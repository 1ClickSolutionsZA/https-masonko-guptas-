<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Masonko Stokvel-Guptas - Investment Club Management</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTWFzb25rbyBTdG9rdmVsLUd1cHRhcyIsInNob3J0X25hbWUiOiJNYXNvbmtvIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwQTFBMkEiLCJ0aGVtZV9jb2xvciI6IiMwQTFBMkEifQ==">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Urbanist:wght@300;400;500;600;700;800;900&family=DM+Serif+Display:ital@0;1&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            scroll-behavior: smooth;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        :root {
            --primary: #1E3A5F; /* Lighter navy blue */
            --secondary: #2A4A6F; /* Lighter teal blue */
            --accent: #00B4D8; /* Cyan from logo */
            --accent-dark: #0096B8;
            --gold: #E67E22; /* Orange from logo (primary text color) */
            --danger: #FF4757;
            --success: #007A4D; /* SA Green - matches flags */
            --text: #E8F4F8;
            --text-muted: #A0B8C8; /* Lighter muted text */
            --border: rgba(255, 255, 255, 0.15);
            --card-bg: rgba(42, 74, 111, 0.5); /* Lighter card background */
            --shadow: rgba(0, 0, 0, 0.3);
            --orange-secondary: #FF8C00; /* Orange from logo (handshake) */
            --cyan-secondary: #00A8CC; /* Cyan text from logo */
            
            /* South African Flag Colors */
            --sa-green: #007A4D; /* SA Green */
            --sa-gold: #FFB612; /* SA Gold */
            --sa-red: #DE3831; /* SA Red */
            --sa-blue: #002395; /* SA Blue */
            --sa-black: #000000; /* SA Black */
            --sa-white: #FFFFFF; /* SA White */
            
            /* Kenyan Flag Colors */
            --ke-black: #000000; /* Kenyan Black */
            --ke-red: #BB0000; /* Kenyan Red */
            --ke-green: #006600; /* Kenyan Green */
            --ke-white: #FFFFFF; /* Kenyan White */
        }
        
        body {
            font-family: 'Urbanist', sans-serif;
            background: linear-gradient(135deg, #1E3A5F 0%, #2A4A6F 50%, #1E4A6F 100%);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(0, 180, 216, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 140, 0, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        /* Login/Auth Screen */
        .auth-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .auth-container {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            max-width: 450px;
            width: 100%;
            border: 1px solid var(--border);
            border-top: 4px solid transparent;
            border-image: linear-gradient(to right, 
                var(--ke-black) 0%, 
                var(--ke-red) 20%, 
                var(--ke-green) 40%, 
                var(--sa-blue) 60%, 
                var(--sa-gold) 80%, 
                var(--sa-green) 100%) 1;
            border-image-slice: 1 0 0 0;
            box-shadow: 0 20px 60px var(--shadow);
            animation: slideUp 0.6s ease-out;
        }
        
        .auth-logo {
            font-family: 'DM Serif Display', serif;
            font-size: 36px;
            font-style: italic;
            text-align: center;
            background: linear-gradient(135deg, var(--accent), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        
        .auth-subtitle {
            text-align: center;
            color: var(--text-muted);
            margin-bottom: 35px;
            font-size: 14px;
        }
        
        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.2);
            padding: 5px;
            border-radius: 12px;
        }
        
        .auth-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-family: 'Urbanist', sans-serif;
        }
        
        .auth-tab.active {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: var(--primary);
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }
        
        .auth-link {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: var(--text-muted);
        }
        
        .auth-link a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }
        
        .auth-link a:hover {
            text-decoration: underline;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Password Toggle */
        .password-wrapper {
            position: relative;
        }
        
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 20px;
            color: var(--text-muted);
            user-select: none;
            transition: color 0.3s ease;
        }
        
        .password-toggle:hover {
            color: var(--accent);
        }
        
        .password-wrapper input {
            padding-right: 45px;
        }
        
        /* Password Strength Indicator */
        .password-requirements {
            margin-top: 10px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-size: 12px;
            border-left: 3px solid var(--text-muted);
        }
        
        .password-requirements.show {
            display: block;
        }
        
        .requirement {
            display: flex;
            align-items: center;
            margin: 5px 0;
            color: var(--text-muted);
            transition: all 0.3s ease;
        }
        
        .requirement.met {
            color: var(--success);
        }
        
        .requirement.met::before {
            content: '✓ ';
            color: var(--success);
            font-weight: bold;
            margin-right: 5px;
        }
        
        .requirement:not(.met)::before {
            content: '✗ ';
            color: var(--danger);
            font-weight: bold;
            margin-right: 5px;
        }
        
        .password-strength {
            margin-top: 8px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .password-strength-bar {
            height: 100%;
            transition: all 0.3s ease;
            border-radius: 2px;
        }
        
        .password-strength-bar.weak {
            width: 33%;
            background: var(--danger);
        }
        
        .password-strength-bar.medium {
            width: 66%;
            background: var(--gold);
        }
        
        .password-strength-bar.strong {
            width: 100%;
            background: var(--success);
        }
        
        .logout-btn {
            background: rgba(255, 71, 87, 0.2);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: 'Urbanist', sans-serif;
        }
        
        .logout-btn:hover {
            background: var(--danger);
            color: white;
        }
        
        .app-container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        header {
            background: rgba(30, 58, 95, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 40px var(--shadow);
            border: 1px solid var(--border);
            border-bottom: 3px solid transparent;
            border-image: linear-gradient(to right, 
                var(--sa-green) 0%, 
                var(--sa-gold) 25%, 
                var(--ke-red) 50%, 
                var(--sa-blue) 75%, 
                var(--ke-green) 100%) 1;
            border-image-slice: 0 0 1 0;
            animation: slideDown 0.6s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .logo {
            font-family: 'DM Serif Display', serif;
            font-size: 32px;
            font-weight: 400;
            font-style: italic;
            background: linear-gradient(135deg, var(--accent), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .role-badge {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(0, 180, 216, 0.3);
        }
        
        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gold), #FFA500);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            color: var(--primary);
            box-shadow: 0 4px 15px rgba(230, 126, 34, 0.3);
        }
        
        /* Navigation */
        nav {
            background: rgba(30, 58, 95, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 30px;
            display: flex;
            gap: 10px;
            overflow-x: auto;
            scrollbar-width: none;
            border: 1px solid var(--border);
            animation: fadeIn 0.8s ease-out 0.2s both;
            transition: transform 0.3s ease;
        }
        
        /* Hamburger Menu Button */
        .hamburger-btn {
            display: none;
            position: fixed;
            top: 25px;
            right: 20px;
            z-index: 1001;
            background: var(--accent);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            cursor: pointer;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 5px;
            box-shadow: 0 4px 20px rgba(0, 180, 216, 0.4);
            transition: all 0.3s ease;
        }
        
        .hamburger-btn:hover {
            background: var(--accent-dark);
            transform: scale(1.05);
        }
        
        .hamburger-btn span {
            display: block;
            width: 25px;
            height: 3px;
            background: white;
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        
        .hamburger-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(7px, 7px);
        }
        
        .hamburger-btn.active span:nth-child(2) {
            opacity: 0;
        }
        
        .hamburger-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }
        
        /* Mobile Menu Overlay */
        .nav-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .nav-overlay.active {
            opacity: 1;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .hamburger-btn {
                display: flex;
            }
            
            .nav-overlay {
                display: block;
            }
            
            /* Hide user info on very small screens */
            .user-info .role-badge,
            .user-info .user-avatar {
                display: none;
            }
            
            .user-info {
                gap: 0;
            }
            
            nav {
                position: fixed;
                top: 0;
                right: -100%;
                width: 280px;
                height: 100vh;
                flex-direction: column;
                padding: 80px 20px 20px 20px;
                margin: 0;
                border-radius: 0;
                overflow-y: auto;
                z-index: 1000;
                gap: 15px;
                border: none;
                border-left: 1px solid var(--border);
                animation: none;
                background: var(--secondary);
            }
            
            nav.active {
                right: 0;
                animation: slideInRight 0.3s ease-out;
            }
            
            @keyframes slideInRight {
                from {
                    right: -100%;
                }
                to {
                    right: 0;
                }
            }
            
            .nav-btn {
                width: 100%;
                text-align: left;
                padding: 15px 20px;
                font-size: 16px;
                justify-content: flex-start;
            }
            
            header {
                padding: 15px 20px;
                position: sticky;
                top: 0;
                z-index: 999;
                background: var(--secondary);
            }
            
            .logo img {
                height: 45px !important;
            }
            
            /* Ensure content is not hidden behind fixed header */
            .app-container {
                padding-top: 0;
            }
            
            /* Hide stats on mobile for better performance */
            #statsCards {
                margin-top: 10px;
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        nav::-webkit-scrollbar {
            display: none;
        }
        
        .nav-btn {
            background: transparent;
            border: 2px solid transparent;
            color: var(--text-muted);
            padding: 12px 24px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-family: 'Urbanist', sans-serif;
        }
        
        .nav-btn:hover {
            background: rgba(230, 126, 34, 0.15);
            color: var(--gold);
            border-color: var(--gold);
        }
        
        .nav-btn.active {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: var(--primary);
            border-color: var(--accent);
            box-shadow: 0 4px 20px rgba(0, 180, 216, 0.4);
        }
        
        /* Dashboard Cards */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            animation: fadeIn 0.8s ease-out 0.4s both;
        }
        
        .stat-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px var(--shadow);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, 
                var(--sa-green) 0%, 
                var(--sa-gold) 25%, 
                var(--ke-red) 50%, 
                var(--sa-blue) 75%, 
                var(--accent) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px var(--shadow);
            border-color: var(--accent);
        }
        
        .stat-card:hover::before {
            opacity: 1;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--text), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }
        
        .stat-change {
            font-size: 13px;
            font-weight: 600;
        }
        
        .stat-change.positive {
            color: var(--success);
        }
        
        .stat-change.negative {
            color: var(--danger);
        }
        
        /* Main Content Area */
        .content-area {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 40px var(--shadow);
            min-height: 500px;
            animation: fadeIn 0.8s ease-out 0.6s both;
        }
        
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
            animation: viewFadeIn 0.5s ease-out;
        }
        
        @keyframes viewFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        h2 {
            font-family: 'DM Serif Display', serif;
            font-size: 32px;
            font-style: italic;
            margin-bottom: 25px;
            background: linear-gradient(135deg, var(--text), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 14px 18px;
            background: rgba(10, 26, 42, 0.6);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 15px;
            font-family: 'Urbanist', sans-serif;
            transition: all 0.3s ease;
        }
        
        /* Select dropdown styling */
        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2300B4D8' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 12px;
            padding-right: 40px;
        }
        
        /* Select options - visible text */
        select option {
            background: var(--secondary);
            color: var(--text);
            padding: 12px;
            font-size: 15px;
            font-weight: 500;
        }
        
        /* Hover state for options */
        select option:hover,
        select option:checked {
            background: var(--accent);
            color: white;
        }
        
        /* Disabled options */
        select option:disabled {
            color: var(--text-muted);
            background: rgba(0, 0, 0, 0.3);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(0, 180, 216, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Urbanist', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn span {
            position: relative;
            z-index: 1;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: var(--primary);
            box-shadow: 0 6px 20px rgba(0, 180, 216, 0.4);
        }
        
        .btn-primary:hover {
            box-shadow: 0 8px 30px rgba(0, 180, 216, 0.6);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            border: 2px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--accent);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #E63946);
            color: white;
            box-shadow: 0 6px 20px rgba(255, 71, 87, 0.4);
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: rgba(0, 180, 216, 0.1);
        }
        
        th {
            padding: 16px;
            text-align: left;
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--accent);
            border-bottom: 2px solid var(--border);
        }
        
        td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        /* Member Cards */
        .member-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .member-grid.list-view {
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .member-grid.list-view .member-card {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 20px;
            align-items: center;
            padding: 20px;
        }
        
        .member-card {
            background: rgba(10, 26, 42, 0.6);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .member-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px var(--shadow);
            border-color: var(--accent);
        }
        
        .member-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .member-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gold), #FFA500);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 24px;
            color: var(--primary);
        }
        
        .member-info h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .member-role {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .member-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }
        
        .member-stat {
            text-align: center;
        }
        
        .member-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .member-stat-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent);
            margin-top: 5px;
        }
        
        /* Chat Interface */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 600px;
            background: rgba(10, 26, 42, 0.4);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .chat-message {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 18px;
            animation: messageSlide 0.3s ease-out;
        }
        
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chat-message.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: var(--primary);
            border-bottom-right-radius: 4px;
        }
        
        .chat-message.received {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            border-bottom-left-radius: 4px;
        }
        
        .message-author {
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 5px;
            opacity: 0.8;
        }
        
        .message-time {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 5px;
        }
        
        .chat-input-area {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid var(--border);
        }
        
        .chat-input {
            flex: 1;
        }
        
        /* Notifications */
        .notification-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .notification {
            background: rgba(10, 26, 42, 0.6);
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            animation: notificationSlide 0.4s ease-out;
        }
        
        @keyframes notificationSlide {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100px);
            }
        }
        
        .notification:hover {
            background: rgba(10, 26, 42, 0.8);
            border-left-width: 6px;
        }
        
        .notification.unread {
            border-left-color: var(--gold);
            background: rgba(230, 126, 34, 0.05);
        }
        
        .notification-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 700;
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .notification-message {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .notification-time {
            font-size: 12px;
            color: var(--text-muted);
            opacity: 0.7;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease-out;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--secondary);
            border-radius: 20px;
            padding: 35px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px var(--shadow);
            animation: modalSlideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .modal-title {
            font-family: 'DM Serif Display', serif;
            font-size: 28px;
            font-style: italic;
            background: linear-gradient(135deg, var(--text), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 32px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-modal:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            transform: rotate(90deg);
        }
        
        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            justify-content: flex-end;
        }
        
        /* Loading State */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* Offline Indicator */
        .offline-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--danger);
            color: white;
            padding: 12px 20px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 6px 20px rgba(255, 71, 87, 0.4);
            display: none;
            z-index: 100;
            animation: slideUp 0.4s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .offline-indicator.show {
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                padding: 10px;
            }
            
            header {
                flex-direction: row;
                justify-content: space-between;
                gap: 10px;
                padding: 12px 15px;
            }
            
            .logo {
                font-size: 18px;
            }
            
            .logo img {
                height: 40px !important;
            }
            
            .user-info {
                flex-direction: row;
                align-items: center;
            }
            
            .logout-btn {
                padding: 8px 15px;
                font-size: 13px;
            }
            
            nav {
                flex-wrap: nowrap;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .content-area {
                padding: 15px;
            }
            
            h2 {
                font-size: 22px;
            }
            
            .modal {
                padding: 10px;
                align-items: flex-start;
                padding-top: 20px;
            }
            
            .modal-content {
                max-width: 100% !important;
                width: calc(100% - 20px);
                padding: 20px;
                margin: 0 10px;
                border-radius: 12px;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .modal-header {
                flex-direction: row;
                align-items: center;
                gap: 10px;
            }
            
            .modal-title {
                font-size: 18px;
                flex: 1;
            }
            
            .close-modal {
                position: relative;
                top: 0;
                right: 0;
                margin: 0;
            }
            
            .member-grid {
                grid-template-columns: 1fr;
            }
            
            .chat-message {
                max-width: 85%;
            }
            
            /* Tables responsive */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
            }
            
            /* Forms */
            .form-group {
                margin-bottom: 15px;
            }
            
            .form-group label {
                font-size: 13px;
            }
            
            input, select, textarea {
                font-size: 16px !important; /* Prevent zoom on iOS */
            }
            
            /* Buttons */
            .btn {
                font-size: 14px;
                padding: 12px 20px;
            }
            
            .modal-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-actions .btn {
                width: 100%;
            }
            
            /* Auth screen */
            .auth-container {
                padding: 20px;
                max-width: 100%;
            }
            
            .auth-logo {
                font-size: 28px;
            }
            
            .auth-form {
                padding: 25px 20px;
            }
            
            /* Cards */
            .card {
                padding: 20px;
            }
            
            .stat-card {
                min-height: auto;
            }
            
            /* Member cards */
            .member-card {
                margin-bottom: 15px;
            }
            
            /* Dashboard stats */
            .stat-value {
                font-size: 28px;
            }
            
            .stat-label {
                font-size: 12px;
            }
            
            /* Loan application form */
            #newLoanModal .form-group {
                margin-bottom: 15px;
            }
            
            /* Guarantor sections */
            #newLoanModal .form-group > div[style*="grid"] {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            /* 2FA Modal */
            #twoFACode {
                font-size: 20px !important;
                letter-spacing: 8px !important;
                padding: 15px !important;
            }
            
            #twoFAModal .modal-actions > div {
                flex-direction: column;
                gap: 10px;
            }
            
            #twoFAModal .btn {
                width: 100%;
            }
            
            /* Leadership cards */
            .leadership-grid {
                grid-template-columns: 1fr !important;
            }
            
            /* Minutes form */
            #minutesForm .form-group > div[style*="grid"] {
                grid-template-columns: 1fr !important;
            }
            
            /* Reports section */
            div[style*="grid-template-columns: repeat(auto-fit"] {
                grid-template-columns: 1fr !important;
            }
            
            /* Notifications */
            .notification {
                padding: 12px;
            }
            
            .notification-icon {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            /* Toast notifications */
            div[style*="position: fixed"] {
                right: 10px !important;
                left: 10px !important;
                top: 70px !important;
                max-width: calc(100% - 20px) !important;
            }
            
            /* User profile dropdown */
            .user-profile {
                position: relative;
            }
            
            .profile-dropdown {
                right: 0;
                left: auto;
                min-width: 200px;
            }
            
            /* Voting items */
            .voting-item {
                padding: 15px !important;
            }
            
            /* Banking details grid */
            div[style*="grid-template-columns: 1fr 150px"] {
                grid-template-columns: 1fr !important;
            }
            
            /* Fix button groups */
            div[style*="display: grid; grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
            
            /* Contribution table actions */
            td[style*="white-space: nowrap"] {
                white-space: normal !important;
            }
            
            td[style*="white-space: nowrap"] .btn {
                width: 100%;
                margin: 5px 0 !important;
            }
        }
        
        /* Extra small devices */
        @media (max-width: 480px) {
            .app-container {
                padding: 8px;
            }
            
            .content-area {
                padding: 10px;
            }
            
            header {
                padding: 10px 15px;
            }
            
            .logo img {
                height: 35px !important;
            }
            
            .hamburger-btn {
                width: 45px;
                height: 45px;
                top: 22px;
                right: 15px;
            }
            
            .hamburger-btn span {
                width: 22px;
            }
            
            .user-info {
                margin-right: 55px; /* Make space for hamburger */
            }
            
            h2 {
                font-size: 20px;
            }
            
            h3 {
                font-size: 16px;
            }
            
            .modal-content {
                padding: 15px;
                width: calc(100% - 10px);
                margin: 0 5px;
            }
            
            .card {
                padding: 15px;
            }
            
            .btn {
                font-size: 13px;
                padding: 10px 15px;
            }
            
            #twoFACode {
                font-size: 18px !important;
                letter-spacing: 5px !important;
            }
            
            .stat-value {
                font-size: 24px;
            }
            
            table {
                font-size: 12px;
            }
            
            td, th {
                padding: 8px 5px;
            }
            
            .logout-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            nav {
                width: 260px;
            }
        }
        
        /* Landscape mobile fix */
        @media (max-width: 768px) and (orientation: landscape) {
            .modal {
                padding: 5px;
                overflow-y: auto;
            }
            
            .modal-content {
                max-height: 95vh;
                overflow-y: auto;
            }
        }
        
        /* iOS Safari fixes */
        @supports (-webkit-touch-callout: none) {
            input, select, textarea {
                font-size: 16px !important;
            }
            
            .modal {
                -webkit-overflow-scrolling: touch;
            }
        }
        
        /* Touch-friendly targets - all clickable elements should be at least 44x44px */
        button, .btn, a, input[type="checkbox"], input[type="radio"] {
            min-height: 44px;
            min-width: 44px;
            touch-action: manipulation; /* Prevents double-tap zoom */
        }
        
        /* Prevent text selection on buttons */
        button, .btn {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Fix for iOS input zoom */
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="number"],
        input[type="password"],
        select,
        textarea {
            font-size: 16px !important; /* Prevents zoom on iOS */
        }
        
        /* Smooth scrolling for mobile */
        html {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        
        /* AI Insights */
        .ai-insight {
            background: linear-gradient(135deg, rgba(0, 180, 216, 0.1), rgba(230, 126, 34, 0.1));
            border: 2px solid var(--accent);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }
        
        .ai-insight::before {
            content: '✨';
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 32px;
            opacity: 0.3;
        }
        
        .ai-insight-title {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 10px;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .ai-insight-content {
            color: var(--text);
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-container">
            <div class="auth-logo" style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                <!-- Logo image - upload masonko-logo.png to your GitHub repo root -->
                <img src="masonko-logo.png" alt="Masonko Stokvel" style="height: 100px; width: auto; margin-bottom: 5px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <!-- Fallback if logo doesn't load -->
                <div style="display: none; flex-direction: column; align-items: center; gap: 5px;">
                    <span style="color: #E67E22; font-weight: 700; font-size: 32px; letter-spacing: 1px;">MASONKO STOKVEL</span>
                    <span style="color: #00B4D8; font-size: 16px; font-weight: 600; letter-spacing: 2px; font-family: 'Urbanist', sans-serif;">INVESTMENT CLUB</span>
                </div>
                <span style="color: #E67E22; font-size: 18px; font-weight: 600; margin-top: 5px;">"GUPTAS"</span>
            </div>
            <div class="auth-subtitle">Investment Club Management System</div>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
            </div>
            
            <!-- Login Form -->
            <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Email or Phone Number</label>
                    <input type="text" id="loginIdentifier" required placeholder="Enter your email or phone">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="loginPassword" required placeholder="Enter your password">
                        <span class="password-toggle" onclick="togglePassword('loginPassword', this)">👁️</span>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">
                    <span>Login</span>
                </button>
                <div class="auth-link">
                    <a onclick="showForgotPassword()">Forgot password?</a>
                </div>
            </form>
            
            <!-- Registration Form -->
            <form class="auth-form" id="registerForm" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="regName" required placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="regEmail" required placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="regPhone" required placeholder="08X XXX XXXX">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="regPassword" required placeholder="Create a strong password" minlength="8" oninput="checkPasswordStrength(this.value)">
                        <span class="password-toggle" onclick="togglePassword('regPassword', this)">👁️</span>
                    </div>
                    <div class="password-requirements">
                        <div style="font-weight: 600; margin-bottom: 8px; color: var(--accent);">Password must contain:</div>
                        <div class="requirement" id="req-length">At least 8 characters</div>
                        <div class="requirement" id="req-uppercase">At least one uppercase letter (A-Z)</div>
                        <div class="requirement" id="req-lowercase">At least one lowercase letter (a-z)</div>
                        <div class="requirement" id="req-number">At least one number (0-9)</div>
                        <div class="requirement" id="req-symbol">At least one symbol (!@#$%^&*)</div>
                        <div class="password-strength">
                            <div class="password-strength-bar" id="strength-bar"></div>
                        </div>
                        <div style="margin-top: 8px; font-size: 11px; text-align: center;">
                            <span id="strength-text" style="font-weight: 600;"></span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="regConfirmPassword" required placeholder="Confirm your password" oninput="checkPasswordMatch()">
                        <span class="password-toggle" onclick="togglePassword('regConfirmPassword', this)">👁️</span>
                    </div>
                    <div id="password-match-message" style="margin-top: 5px; font-size: 13px;"></div>
                </div>
                <div class="form-group">
                    <label>Membership Tier</label>
                    <select id="regTier" required onchange="updateRegTierInfo()">
                        <option value="">Select Your Tier</option>
                        <option value="1">Tier 1 - R1,000 (1 Share) - R100/week</option>
                        <option value="2">Tier 2 - R2,000 (2 Shares) - R200/week</option>
                        <option value="3">Tier 3 - R3,000 (3 Shares) - R300/week</option>
                        <option value="4">Tier 4 - R4,000 (4 Shares) - R400/week</option>
                        <option value="5">Tier 5 - R5,000 (5 Shares) - R500/week</option>
                    </select>
                    <div id="regTierInfo" style="margin-top: 10px; padding: 10px; background: rgba(0, 180, 216, 0.1); border-radius: 8px; display: none; font-size: 13px;">
                        <strong>Initial Investment:</strong> <span id="regTierInvestment"></span><br>
                        <strong>Shares:</strong> <span id="regTierShares"></span><br>
                        <strong>Weekly Subscription:</strong> <span id="regTierSubscription"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="regTerms" required style="width: auto; margin-right: 8px;">
                        I agree to the terms and conditions
                    </label>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">
                    <span>Create Account</span>
                </button>
                <div class="auth-link" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                    <small>Registration requires approval from the Admin or Treasurer</small>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Main Application (hidden until logged in) -->
    <div class="app-container hidden" id="mainApp">
        <header>
            <div class="logo" style="display: flex; align-items: center; gap: 15px;">
                <!-- Logo image - upload masonko-logo.png to your GitHub repo root -->
                <img src="masonko-logo.png" alt="Masonko Stokvel" style="height: 70px; width: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <!-- Fallback if logo doesn't load -->
                <div style="display: none; flex-direction: column; gap: 0; line-height: 1.1;">
                    <span style="color: #E67E22; font-weight: 700; font-size: 28px; letter-spacing: 1px;">MASONKO STOKVEL</span>
                    <span style="color: #00B4D8; font-size: 14px; font-weight: 600; letter-spacing: 2px; font-family: 'Urbanist', sans-serif; margin-top: -5px;">INVESTMENT CLUB</span>
                    <span style="color: #E67E22; font-size: 12px; font-weight: 600; margin-top: 2px;">"GUPTAS"</span>
                </div>
            </div>
            <div class="user-info">
                <span class="role-badge" id="userRoleBadge">Admin</span>
                <div class="user-avatar" id="userAvatar">TS</div>
                <button class="logout-btn" onclick="handleLogout()">Logout</button>
            </div>
        </header>
        
        <!-- Hamburger Menu Button (Mobile) -->
        <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleMobileMenu()">
            <span></span>
            <span></span>
            <span></span>
        </button>
        
        <!-- Mobile Menu Overlay -->
        <div class="nav-overlay" id="navOverlay" onclick="toggleMobileMenu()"></div>
        
        <nav id="mainNav">
            <button class="nav-btn active" data-view="dashboard">Dashboard</button>
            <button class="nav-btn" data-view="members">Members</button>
            <button class="nav-btn" data-view="contributions">Contributions</button>
            <button class="nav-btn" data-view="loans">Loans</button>
            <button class="nav-btn" data-view="minutes" id="minutesNav">Meeting Minutes</button>
            <button class="nav-btn" data-view="leadership">Leadership</button>
            <button class="nav-btn" data-view="reports">Reports</button>
            <button class="nav-btn" data-view="chat">Chat</button>
            <button class="nav-btn" data-view="notifications">Notifications</button>
            <button class="nav-btn" data-view="settings">Settings</button>
            <button class="nav-btn" data-view="adminPanel" id="adminPanelNav" style="display: none;">System Settings</button>
        </nav>
        
        <div class="dashboard" id="statsCards">
            <div class="stat-card">
                <div class="stat-label">Total Pool Value</div>
                <div class="stat-value">R 315,900</div>
                <div class="stat-change positive">+15.2% this month</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Members</div>
                <div class="stat-value">8</div>
                <div class="stat-change">17 Total Shares</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Weekly Subscriptions</div>
                <div class="stat-value">R 1,600</div>
                <div class="stat-change positive">75% paid this week</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Outstanding Payments</div>
                <div class="stat-value">2</div>
                <div class="stat-change">R 400 + R 100 fines due</div>
            </div>
        </div>
        
        <div class="content-area">
            <!-- Dashboard View -->
            <div id="dashboard" class="view active">
                <h2>Investment Overview</h2>
                
                <div class="ai-insight">
                    <div class="ai-insight-title">AI Investment Insight</div>
                    <div class="ai-insight-content">
                        Based on current weekly subscription trends (R 1,600/week) and 17 total shares, your stokveld is on track to accumulate R 83,200 annually in subscriptions alone. With current growth trajectory and reinvestment strategy, projected pool value by Q4 2026: R 420,000. Recommendation: 2 members have late payments - automated reminders sent with R 50 fine notices.
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px; color: var(--accent);">Recent Activity</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Member</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivityTable">
                                <tr>
                                    <td>2026-01-13</td>
                                    <td>Admin User</td>
                                    <td>Contribution</td>
                                    <td>R 800</td>
                                    <td><span style="color: var(--success);">✓ Confirmed</span></td>
                                </tr>
                                <tr>
                                    <td>2026-01-12</td>
                                    <td>Member 6</td>
                                    <td>Contribution</td>
                                    <td>R 800</td>
                                    <td><span style="color: var(--success);">✓ Confirmed</span></td>
                                </tr>
                                <tr>
                                    <td>2026-01-11</td>
                                    <td>Loan Officer User</td>
                                    <td>Loan Payment</td>
                                    <td>R 2,500</td>
                                    <td><span style="color: var(--success);">✓ Confirmed</span></td>
                                </tr>
                                <tr>
                                    <td>2026-01-10</td>
                                    <td>Member 4</td>
                                    <td>Contribution</td>
                                    <td>R 800</td>
                                    <td><span style="color: var(--gold);">⏳ Pending</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Members View -->
            <div id="members" class="view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h2>Members</h2>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <!-- View Toggle -->
                        <div style="display: flex; gap: 5px; background: rgba(0, 0, 0, 0.3); padding: 5px; border-radius: 10px;">
                            <button id="listViewBtn" class="btn btn-secondary" onclick="switchMemberView('list')" style="padding: 8px 15px; background: var(--accent); border-color: var(--accent);">
                                <span>📋 List</span>
                            </button>
                            <button id="tileViewBtn" class="btn btn-secondary" onclick="switchMemberView('tile')" style="padding: 8px 15px;">
                                <span>🔲 Tiles</span>
                            </button>
                        </div>
                        <button class="btn btn-primary" id="addMemberBtn" onclick="openModal('addMemberModal')" style="display: none;"><span>+ Add Member</span></button>
                    </div>
                </div>
                
                <!-- Pending Approvals Section (Admin/Treasurer only) -->
                <div id="pendingApprovalsSection" style="display: none;">
                    <h3 style="margin-bottom: 15px; color: var(--gold);">⏳ Pending Approvals</h3>
                    <div class="ai-insight" style="background: linear-gradient(135deg, rgba(230, 126, 34, 0.1), rgba(255, 71, 87, 0.1)); border-color: var(--gold); margin-bottom: 30px;">
                        <div class="ai-insight-title">Action Required</div>
                        <div class="ai-insight-content" id="pendingCount">
                            0 new member applications awaiting your approval.
                        </div>
                    </div>
                    <div id="pendingMembersList" style="margin-bottom: 30px;">
                        <!-- Pending members will be shown here -->
                    </div>
                </div>
                
                <h3 style="margin-bottom: 15px; color: var(--accent);">Active Members</h3>
                <div class="member-grid" id="memberGrid">
                    <!-- Members will be populated here -->
                </div>
            </div>
            
            <!-- Contributions View -->
            <div id="contributions" class="view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h2>Contributions</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="openModal('submitPaymentModal')"><span>📤 Submit My Payment</span></button>
                        <button class="btn btn-primary" onclick="openModal('recordContributionModal')" id="recordPaymentBtn"><span>+ Record Payment</span></button>
                    </div>
                </div>
                
                <!-- Pending Payments Review (Treasurer/Admin only) -->
                <div id="pendingPaymentsSection" style="display: none; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px; color: var(--gold);">📋 Pending Payment Submissions</h3>
                    <div class="ai-insight" style="background: linear-gradient(135deg, rgba(230, 126, 34, 0.1), rgba(0, 180, 216, 0.1)); border-color: var(--gold);">
                        <div class="ai-insight-title">Payments Awaiting Verification</div>
                        <div class="ai-insight-content" id="pendingPaymentsCount">
                            0 payment submissions awaiting your verification.
                        </div>
                    </div>
                    <div id="pendingPaymentsList" style="margin-top: 15px;">
                        <!-- Pending payments will be shown here -->
                    </div>
                </div>
                
                <div class="ai-insight">
                    <div class="ai-insight-title">Weekly Payment Status</div>
                    <div class="ai-insight-content">
                        2 members have overdue payments from last week. Total outstanding: R 400 (subscriptions) + R 100 (late fees) = R 500. Automated SMS and WhatsApp reminders sent. Collection rate for current members: 75%. Expected weekly collection: R 1,600.
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Member</th>
                                <th>Due Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="contributionsTable">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Loans View -->
            <div id="loans" class="view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Loans</h2>
                    <button class="btn btn-primary" onclick="openModal('newLoanModal')"><span>+ New Loan</span></button>
                </div>
                
                <div class="ai-insight">
                    <div class="ai-insight-title">Loan Portfolio Health</div>
                    <div class="ai-insight-content">
                        Current loan portfolio is performing well with 100% on-time payment rate. Based on club liquidity, you can safely approve loans up to R 15,000 without affecting monthly operations.
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Member</th>
                                <th>Amount</th>
                                <th>Term</th>
                                <th>Interest</th>
                                <th>Status</th>
                                <th>Next Payment</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="loansTable">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Leadership Section (Visible to All Members) -->
            <div id="leadership" class="view">
                <h2>🏛️ Leadership & Elected Positions</h2>
                
                <div style="max-width: 1200px; margin: 0 auto;">
                    <div class="ai-insight" style="margin-bottom: 30px;">
                        <div class="ai-insight-title">Stokvel Leadership</div>
                        <div class="ai-insight-content">
                            <p style="margin-bottom: 10px;">
                                These are the members elected by the group to serve in leadership positions. They are responsible for guiding the stokvel's operations and making key decisions on behalf of all members.
                            </p>
                            <p style="margin: 0; font-size: 13px; color: var(--text-muted);">
                                <strong>Note:</strong> Positions are typically elected during annual general meetings and can be changed through member voting.
                            </p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- Chairperson Card -->
                        <div class="card" style="text-align: center; padding: 30px;">
                            <div style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-dark)); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 36px; color: white; border: 4px solid var(--border);">
                                👑
                            </div>
                            <h3 style="color: var(--accent); margin-bottom: 5px;">Chairperson</h3>
                            <div id="chairpersonDisplay" style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">
                                Not Assigned
                            </div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 15px;">
                                Overall leadership, presides over meetings
                            </div>
                            <div id="chairpersonTermDisplay" style="font-size: 12px; padding: 8px; background: rgba(0, 180, 216, 0.1); border-radius: 5px; color: var(--text-muted);">
                                —
                            </div>
                        </div>
                        
                        <!-- Vice Chairperson Card -->
                        <div class="card" style="text-align: center; padding: 30px;">
                            <div style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-dark)); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 36px; color: white; border: 4px solid var(--border);">
                                🤝
                            </div>
                            <h3 style="color: var(--accent); margin-bottom: 5px;">Vice Chairperson</h3>
                            <div id="viceChairpersonDisplay" style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">
                                Not Assigned
                            </div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 15px;">
                                Assists chairperson, acts in their absence
                            </div>
                            <div id="viceChairpersonTermDisplay" style="font-size: 12px; padding: 8px; background: rgba(0, 180, 216, 0.1); border-radius: 5px; color: var(--text-muted);">
                                —
                            </div>
                        </div>
                        
                        <!-- Treasurer Card -->
                        <div class="card" style="text-align: center; padding: 30px;">
                            <div style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, var(--gold), #D4940E); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 36px; color: white; border: 4px solid var(--border);">
                                💰
                            </div>
                            <h3 style="color: var(--gold); margin-bottom: 5px;">Treasurer</h3>
                            <div id="treasurerDisplay" style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">
                                Not Assigned
                            </div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 15px;">
                                Financial management, contributions tracking
                            </div>
                            <div id="treasurerTermDisplay" style="font-size: 12px; padding: 8px; background: rgba(230, 126, 34, 0.1); border-radius: 5px; color: var(--text-muted);">
                                —
                            </div>
                        </div>
                        
                        <!-- Secretary Card -->
                        <div class="card" style="text-align: center; padding: 30px;">
                            <div style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, var(--success), #006B4F); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 36px; color: white; border: 4px solid var(--border);">
                                📝
                            </div>
                            <h3 style="color: var(--success); margin-bottom: 5px;">Secretary</h3>
                            <div id="secretaryDisplay" style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">
                                Not Assigned
                            </div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 15px;">
                                Documentation, meeting minutes, records
                            </div>
                            <div id="secretaryTermDisplay" style="font-size: 12px; padding: 8px; background: rgba(0, 122, 77, 0.1); border-radius: 5px; color: var(--text-muted);">
                                —
                            </div>
                        </div>
                        
                        <!-- Loan Officer Card -->
                        <div class="card" style="text-align: center; padding: 30px;">
                            <div style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #FFB800, #D49900); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 36px; color: white; border: 4px solid var(--border);">
                                🏦
                            </div>
                            <h3 style="color: #FFB800; margin-bottom: 5px;">Loan Officer</h3>
                            <div id="loanOfficerDisplay" style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">
                                Not Assigned
                            </div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 15px;">
                                Loan applications, approvals, tracking
                            </div>
                            <div id="loanOfficerTermDisplay" style="font-size: 12px; padding: 8px; background: rgba(255, 184, 0, 0.1); border-radius: 5px; color: var(--text-muted);">
                                —
                            </div>
                        </div>
                        
                        <!-- Payment Loader Card -->
                        <div class="card" style="text-align: center; padding: 30px;">
                            <div style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #9B59B6, #8E44AD); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 36px; color: white; border: 4px solid var(--border);">
                                💳
                            </div>
                            <h3 style="color: #9B59B6; margin-bottom: 5px;">Payment Loader</h3>
                            <div id="paymentLoaderDisplay" style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">
                                Not Assigned
                            </div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 15px;">
                                Loads approved loan payments in bank
                            </div>
                            <div id="paymentLoaderTermDisplay" style="font-size: 12px; padding: 8px; background: rgba(155, 89, 182, 0.1); border-radius: 5px; color: var(--text-muted);">
                                —
                            </div>
                        </div>
                        
                        <!-- Payment Releaser Card -->
                        <div class="card" style="text-align: center; padding: 30px;">
                            <div style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #E74C3C, #C0392B); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 36px; color: white; border: 4px solid var(--border);">
                                🔓
                            </div>
                            <h3 style="color: #E74C3C; margin-bottom: 5px;">Payment Releaser</h3>
                            <div id="paymentReleaserDisplay" style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">
                                Not Assigned
                            </div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 15px;">
                                Releases funds to loan applicants
                            </div>
                            <div id="paymentReleaserTermDisplay" style="font-size: 12px; padding: 8px; background: rgba(231, 76, 60, 0.1); border-radius: 5px; color: var(--text-muted);">
                                —
                            </div>
                        </div>
                    </div>
                    
                    <!-- Admin Section: Position Assignment (Admin Only) -->
                    <div id="leadershipAdminSection" style="display: none;">
                        <div class="card" style="background: linear-gradient(135deg, rgba(255, 75, 87, 0.1), rgba(230, 126, 34, 0.1)); border: 2px solid var(--danger);">
                            <h3 style="color: var(--danger); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <span>🔒</span> Admin: Assign Elected Positions
                            </h3>
                            
                            <div style="padding: 15px; background: rgba(0, 0, 0, 0.2); border-radius: 8px; margin-bottom: 20px; font-size: 14px; color: var(--text-muted);">
                                <strong>Important:</strong> Position changes should be made only after elections or member voting. Document all changes in meeting minutes.
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div class="form-group">
                                    <label style="color: var(--accent); font-weight: 600;">👑 Chairperson</label>
                                    <select id="positionChairperson" class="form-control" onchange="updatePosition('chairperson', this.value)">
                                        <option value="">-- Not Assigned --</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label style="color: var(--accent); font-weight: 600;">🤝 Vice Chairperson</label>
                                    <select id="positionViceChairperson" class="form-control" onchange="updatePosition('viceChairperson', this.value)">
                                        <option value="">-- Not Assigned --</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label style="color: var(--gold); font-weight: 600;">💰 Treasurer</label>
                                    <select id="positionTreasurer" class="form-control" onchange="updatePosition('treasurer', this.value)">
                                        <option value="">-- Not Assigned --</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label style="color: var(--success); font-weight: 600;">📝 Secretary</label>
                                    <select id="positionSecretary" class="form-control" onchange="updatePosition('secretary', this.value)">
                                        <option value="">-- Not Assigned --</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label style="color: #FFB800; font-weight: 600;">🏦 Loan Officer</label>
                                    <select id="positionLoanOfficer" class="form-control" onchange="updatePosition('loanOfficer', this.value)">
                                        <option value="">-- Not Assigned --</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label style="color: #9B59B6; font-weight: 600;">💳 Payment Loader</label>
                                    <select id="positionPaymentLoader" class="form-control" onchange="updatePosition('paymentLoader', this.value)">
                                        <option value="">-- Not Assigned --</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label style="color: #E74C3C; font-weight: 600;">🔓 Payment Releaser</label>
                                    <select id="positionPaymentReleaser" class="form-control" onchange="updatePosition('paymentReleaser', this.value)">
                                        <option value="">-- Not Assigned --</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reports View -->
            <div id="reports" class="view">
                <h2>Financial Reports</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                    <button class="btn btn-secondary" onclick="generateReport('monthly')"><span>📄 Monthly Report</span></button>
                    <button class="btn btn-secondary" onclick="generateReport('quarterly')"><span>📄 Quarterly Report</span></button>
                    <button class="btn btn-secondary" onclick="generateReport('annual')"><span>📄 Annual Report</span></button>
                    <button class="btn btn-secondary" onclick="generateReport('custom')"><span>📄 Custom Report</span></button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0; padding: 15px; background: rgba(37, 211, 102, 0.1); border-radius: 12px; border: 2px solid rgba(37, 211, 102, 0.3);">
                    <button class="btn btn-primary" onclick="generateWeeklyWhatsAppReport()" style="background: #25D366; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span style="font-size: 20px;">📋</span>
                        <span>Copy Weekly Report</span>
                    </button>
                    <button class="btn btn-primary" onclick="shareReportToWhatsApp('monthly')" style="background: #25D366; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span style="font-size: 20px;">💬</span>
                        <span>Share to WhatsApp</span>
                    </button>
                </div>
                
                <div class="ai-insight">
                    <div class="ai-insight-title">AI-Generated Financial Summary</div>
                    <div class="ai-insight-content" id="aiReportSummary">
                        Click on any report button above to generate an AI-powered financial analysis with insights and recommendations.
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px; color: var(--accent);">Report History</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Report Type</th>
                                    <th>Period</th>
                                    <th>Generated</th>
                                    <th>Generated By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reportHistoryTable">
                                <tr>
                                    <td>Monthly Report</td>
                                    <td>December 2025</td>
                                    <td>2026-01-05</td>
                                    <td>Treasurer</td>
                                    <td><button class="btn btn-secondary" style="padding: 8px 16px;"><span>Download</span></button></td>
                                </tr>
                                <tr>
                                    <td>Quarterly Report</td>
                                    <td>Q4 2025</td>
                                    <td>2026-01-02</td>
                                    <td>Admin</td>
                                    <td><button class="btn btn-secondary" style="padding: 8px 16px;"><span>Download</span></button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Chat View -->
            <div id="chat" class="view">
                <h2>Group Chat</h2>
                
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <!-- Messages will be populated here -->
                    </div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
                        <button class="btn btn-primary" onclick="sendMessage()"><span>Send</span></button>
                    </div>
                </div>
            </div>
            
            <!-- Notifications View -->
            <div id="notifications" class="view">
                <h2>Notifications</h2>
                
                <div class="notification-list" id="notificationList">
                    <!-- Notifications will be populated here -->
                </div>
            </div>
            
            <!-- Settings/Profile Section -->
            <div id="settings" class="view">
                <h2>My Profile</h2>
                
                <!-- Guarantor Requests Section -->
                <div id="guarantorRequestsSection" style="margin-bottom: 30px;">
                    <div class="card">
                        <h3 style="color: var(--accent); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span>🤝</span> Guarantor Requests
                        </h3>
                        <div id="guarantorRequestsList">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <div class="card" style="max-width: 800px; margin: 0 auto;">
                    <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 30px;">
                        <!-- Profile Picture Preview -->
                        <div style="position: relative; margin-bottom: 20px;">
                            <div id="profilePicPreview" style="
                                width: 150px;
                                height: 150px;
                                border-radius: 50%;
                                background: linear-gradient(135deg, var(--accent), var(--accent-dark));
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 48px;
                                color: white;
                                font-weight: bold;
                                overflow: hidden;
                                border: 4px solid var(--border);
                                box-shadow: 0 10px 30px var(--shadow);
                            ">
                                <span id="profileInitials">TM</span>
                                <img id="profilePicImage" src="" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                            </div>
                            
                            <!-- Camera Icon Button -->
                            <label for="profilePicInput" style="
                                position: absolute;
                                bottom: 5px;
                                right: 5px;
                                background: var(--accent);
                                width: 45px;
                                height: 45px;
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                cursor: pointer;
                                box-shadow: 0 4px 15px rgba(0, 180, 216, 0.4);
                                transition: all 0.3s ease;
                                border: 3px solid var(--secondary);
                            " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                                <span style="font-size: 20px;">📷</span>
                            </label>
                            <input type="file" id="profilePicInput" accept="image/*" style="display: none;" onchange="handleProfilePicture(event)">
                        </div>
                        
                        <!-- Image Position Controls (shown when image is uploaded) -->
                        <div id="imagePositionControls" style="display: none; margin-top: 15px; padding: 15px; background: rgba(0, 180, 216, 0.1); border-radius: 10px; max-width: 350px;">
                            <div style="color: var(--text); font-weight: 600; margin-bottom: 10px; text-align: center;">
                                🎯 Adjust Image Position
                            </div>
                            
                            <!-- Position Sliders -->
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; color: var(--text-muted); font-size: 13px; margin-bottom: 5px;">
                                    Horizontal Position
                                </label>
                                <input type="range" id="positionX" min="0" max="100" value="50" 
                                    style="width: 100%; cursor: pointer;" 
                                    oninput="updateImagePosition()">
                                <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); margin-top: 2px;">
                                    <span>← Left</span>
                                    <span>Center</span>
                                    <span>Right →</span>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; color: var(--text-muted); font-size: 13px; margin-bottom: 5px;">
                                    Vertical Position
                                </label>
                                <input type="range" id="positionY" min="0" max="100" value="50" 
                                    style="width: 100%; cursor: pointer;" 
                                    oninput="updateImagePosition()">
                                <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); margin-top: 2px;">
                                    <span>↑ Top</span>
                                    <span>Center</span>
                                    <span>Bottom ↓</span>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; color: var(--text-muted); font-size: 13px; margin-bottom: 5px;">
                                    Zoom Level
                                </label>
                                <input type="range" id="zoomLevel" min="100" max="200" value="100" 
                                    style="width: 100%; cursor: pointer;" 
                                    oninput="updateImagePosition()">
                                <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); margin-top: 2px;">
                                    <span>100%</span>
                                    <span>150%</span>
                                    <span>200%</span>
                                </div>
                            </div>
                            
                            <!-- Quick Actions -->
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                                <button type="button" onclick="centerImage()" class="btn" style="padding: 8px 16px; font-size: 13px; background: var(--accent);">
                                    <span>📐 Center</span>
                                </button>
                                <button type="button" onclick="resetImagePosition()" class="btn" style="padding: 8px 16px; font-size: 13px; background: var(--gold);">
                                    <span>🔄 Reset</span>
                                </button>
                                <button type="button" onclick="removeProfilePicture()" class="btn" style="padding: 8px 16px; font-size: 13px; background: var(--danger);">
                                    <span>🗑️ Remove</span>
                                </button>
                            </div>
                        </div>
                        
                        <h3 style="margin: 0; color: var(--text);" id="profileName">Member Name</h3>
                        <p style="color: var(--text-muted); margin: 5px 0 0 0;" id="profileRegNo">MSK-0000</p>
                    </div>
                    
                    <form onsubmit="updateProfile(event)" style="max-width: 500px; margin: 0 auto;">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="profileNameInput" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="profileEmailInput" class="form-control" placeholder="your.email@example.com">
                            <small style="color: var(--text-muted); font-size: 13px; margin-top: 5px; display: block;">
                                📧 Used for notifications and password recovery
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label>Cell Number</label>
                            <input type="tel" id="profileCellInput" class="form-control" placeholder="+27 XX XXX XXXX" pattern="[0-9+\s\-()]+">
                            <small style="color: var(--text-muted); font-size: 13px; margin-top: 5px; display: block;">
                                📱 For SMS notifications and contact
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label>Membership Tier</label>
                            <input type="text" id="profileTierInput" class="form-control" readonly style="background: rgba(0, 180, 216, 0.1); cursor: not-allowed;">
                            <small style="color: var(--text-muted); font-size: 13px; margin-top: 5px; display: block;">
                                💎 Contact admin to change membership tier
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label>Member Since</label>
                            <input type="text" id="profileJoinedInput" class="form-control" readonly style="background: rgba(0, 180, 216, 0.1); cursor: not-allowed;">
                        </div>
                        
                        <div style="display: flex; gap: 15px; margin-top: 30px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">
                                <span>💾 Save Changes</span>
                            </button>
                            <button type="button" class="btn" style="flex: 1; background: var(--danger);" onclick="resetProfileForm()">
                                <span>❌ Cancel</span>
                            </button>
                        </div>
                    </form>
                    
                    <!-- Additional Profile Info -->
                    <div style="margin-top: 40px; padding-top: 30px; border-top: 1px solid var(--border);">
                        <h3 style="margin-bottom: 20px;">Account Information</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: rgba(0, 180, 216, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid var(--accent);">
                                <div style="color: var(--text-muted); font-size: 13px; margin-bottom: 5px;">Total Contributions</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--accent);" id="profileTotalContributions">R 0</div>
                            </div>
                            
                            <div style="background: rgba(230, 126, 34, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid var(--gold);">
                                <div style="color: var(--text-muted); font-size: 13px; margin-bottom: 5px;">Active Loans</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--gold);" id="profileActiveLoans">0</div>
                            </div>
                            
                            <div style="background: rgba(0, 122, 77, 0.1); padding: 15px; border-radius: 10px; border-left: 4px solid var(--success);">
                                <div style="color: var(--text-muted); font-size: 13px; margin-bottom: 5px;">Account Status</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--success);" id="profileStatus">Active</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Change Password Section -->
                    <div style="margin-top: 40px; padding-top: 30px; border-top: 1px solid var(--border);">
                        <h3 style="margin-bottom: 20px;">🔒 Change Password</h3>
                        
                        <form onsubmit="changePassword(event)" style="max-width: 500px;">
                            <div class="form-group">
                                <label>Current Password</label>
                                <input type="password" id="currentPassword" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label>New Password</label>
                                <input type="password" id="newPassword" class="form-control" minlength="6" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Confirm New Password</label>
                                <input type="password" id="confirmPassword" class="form-control" required>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <span>🔑 Update Password</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- System Settings Section (Admin/Tech Support Only) -->
            <div id="adminPanel" class="view">
                <h2>⚙️ System Settings</h2>
                
                <div style="max-width: 1200px; margin: 0 auto;">
                    <!-- Admin Notice -->
                    <div class="ai-insight" style="margin-bottom: 30px; background: linear-gradient(135deg, rgba(255, 75, 87, 0.15), rgba(230, 126, 34, 0.15)); border-left: 4px solid var(--danger);">
                        <div class="ai-insight-title" style="color: var(--danger);">🔒 Administrator Access Only</div>
                        <div class="ai-insight-content">
                            <p style="margin-bottom: 10px;">
                                <strong>Important:</strong> This section is for system administrators and technical support only. These settings control the app configuration and should be modified based on instructions from elected leadership and member decisions.
                            </p>
                            <p style="margin: 0; font-size: 13px;">
                                <strong>Process:</strong> Leadership/Members decide → Meeting minutes document → Admin implements changes here
                            </p>
                        </div>
                    </div>
                    
                    <!-- WhatsApp Notifications Info -->
                    <div class="card" style="margin-bottom: 30px; background: linear-gradient(135deg, rgba(37, 211, 102, 0.05), rgba(0, 180, 216, 0.05)); border-left: 4px solid #25D366;">
                        <h3 style="margin-bottom: 20px; color: #25D366; font-size: 20px; display: flex; align-items: center; gap: 10px;">
                            <span>📱</span> WhatsApp Notifications - How It Works
                        </h3>
                        
                        <div style="padding: 15px; background: rgba(37, 211, 102, 0.1); border-radius: 8px; margin-bottom: 20px;">
                            <strong style="color: #25D366; font-size: 16px;">ℹ️ Important Information</strong>
                            <p style="margin: 10px 0 0 0; line-height: 1.6;">
                                The system uses WhatsApp's official click-to-chat API which is <strong>100% free</strong> and requires <strong>no API keys</strong>. Here's how it works:
                            </p>
                        </div>
                        
                        <div style="display: grid; gap: 15px;">
                            <div style="padding: 15px; background: rgba(0, 0, 0, 0.2); border-radius: 8px; border-left: 3px solid var(--accent);">
                                <strong style="color: var(--accent);">1️⃣ Message Generation</strong>
                                <p style="margin: 8px 0 0 0; font-size: 14px; color: var(--text-muted);">
                                    When a notification is triggered (loan approval, guarantor request, etc.), the system generates a formatted message with all relevant details.
                                </p>
                            </div>
                            
                            <div style="padding: 15px; background: rgba(0, 0, 0, 0.2); border-radius: 8px; border-left: 3px solid var(--gold);">
                                <strong style="color: var(--gold);">2️⃣ WhatsApp Opens</strong>
                                <p style="margin: 8px 0 0 0; font-size: 14px; color: var(--text-muted);">
                                    WhatsApp opens (either app or web) with the message pre-filled in the <strong>composition box</strong>. The recipient's phone number is already selected.
                                </p>
                            </div>
                            
                            <div style="padding: 15px; background: rgba(0, 0, 0, 0.2); border-radius: 8px; border-left: 3px solid #25D366;">
                                <strong style="color: #25D366;">3️⃣ You Click Send</strong>
                                <p style="margin: 8px 0 0 0; font-size: 14px; color: var(--text-muted);">
                                    <strong>You must click the Send button in WhatsApp</strong> to actually send the message. This is a WhatsApp security feature - no app can automatically send messages on your behalf.
                                </p>
                            </div>
                            
                            <div style="padding: 15px; background: rgba(0, 0, 0, 0.2); border-radius: 8px; border-left: 3px solid var(--success);">
                                <strong style="color: var(--success);">4️⃣ Message Delivered</strong>
                                <p style="margin: 8px 0 0 0; font-size: 14px; color: var(--text-muted);">
                                    Once you click send, the message is delivered to the recipient's WhatsApp. They receive it as a normal WhatsApp message.
                                </p>
                            </div>
                        </div>
                        
                        <div style="padding: 15px; background: rgba(230, 126, 34, 0.1); border-radius: 8px; margin-top: 20px; border-left: 4px solid var(--gold);">
                            <strong style="color: var(--gold);">💡 Why the message appears in the composition box:</strong>
                            <p style="margin: 8px 0 0 0; font-size: 13px; line-height: 1.6;">
                                This is <strong>normal behavior</strong> for WhatsApp's click-to-chat API. WhatsApp does not allow apps to automatically send messages (this prevents spam and protects privacy). You need to manually click Send to deliver the message. This is the same for all legitimate business apps using WhatsApp.
                            </p>
                        </div>
                        
                        <div style="padding: 15px; background: rgba(0, 180, 216, 0.1); border-radius: 8px; margin-top: 15px;">
                            <strong style="color: var(--accent);">📋 Testing Tips:</strong>
                            <ul style="margin: 8px 0 0 20px; font-size: 13px; line-height: 1.8; color: var(--text-muted);">
                                <li>If testing on your own number, the message will open in YOUR WhatsApp</li>
                                <li>On desktop, it opens WhatsApp Web in a new tab</li>
                                <li>On mobile, it tries to open the WhatsApp app first</li>
                                <li>The recipient sees your message just like any other WhatsApp chat</li>
                            </ul>
                        </div>
                    </div>
                    
                    
                    <!-- Membership Tiers Configuration -->
                    <div class="card" style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 20px; color: var(--accent); font-size: 20px; display: flex; align-items: center; gap: 10px;">
                            <span>💎</span> Membership Tiers Configuration
                        </h3>
                        
                        <div class="ai-insight" style="margin-bottom: 25px;">
                            <div class="ai-insight-title">Tier Structure</div>
                            <div class="ai-insight-content">
                                Configure investment tiers that members can choose during registration. Each tier determines initial investment, number of shares, and weekly subscription amount. Changes affect new registrations only.
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                            <!-- Tier 1 -->
                            <div style="background: rgba(0, 180, 216, 0.05); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
                                <h4 style="color: var(--accent); margin-bottom: 15px;">Tier 1 - Starter</h4>
                                <div class="form-group">
                                    <label>Initial Investment (R)</label>
                                    <input type="number" class="form-control" value="1000" id="tier1Investment" min="100" step="100">
                                </div>
                                <div class="form-group">
                                    <label>Shares</label>
                                    <input type="number" class="form-control" value="1" id="tier1Shares" readonly style="background: rgba(0, 180, 216, 0.1); cursor: not-allowed;">
                                </div>
                                <div class="form-group">
                                    <label>Weekly Subscription (R)</label>
                                    <input type="number" class="form-control" value="100" id="tier1Subscription" min="10" step="10">
                                </div>
                            </div>
                            
                            <!-- Tier 2 -->
                            <div style="background: rgba(0, 180, 216, 0.05); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
                                <h4 style="color: var(--accent); margin-bottom: 15px;">Tier 2 - Bronze</h4>
                                <div class="form-group">
                                    <label>Initial Investment (R)</label>
                                    <input type="number" class="form-control" value="2000" id="tier2Investment" min="100" step="100">
                                </div>
                                <div class="form-group">
                                    <label>Shares</label>
                                    <input type="number" class="form-control" value="2" id="tier2Shares" readonly style="background: rgba(0, 180, 216, 0.1); cursor: not-allowed;">
                                </div>
                                <div class="form-group">
                                    <label>Weekly Subscription (R)</label>
                                    <input type="number" class="form-control" value="200" id="tier2Subscription" min="10" step="10">
                                </div>
                            </div>
                            
                            <!-- Tier 3 -->
                            <div style="background: rgba(230, 126, 34, 0.05); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
                                <h4 style="color: var(--gold); margin-bottom: 15px;">Tier 3 - Silver</h4>
                                <div class="form-group">
                                    <label>Initial Investment (R)</label>
                                    <input type="number" class="form-control" value="3000" id="tier3Investment" min="100" step="100">
                                </div>
                                <div class="form-group">
                                    <label>Shares</label>
                                    <input type="number" class="form-control" value="3" id="tier3Shares" readonly style="background: rgba(230, 126, 34, 0.1); cursor: not-allowed;">
                                </div>
                                <div class="form-group">
                                    <label>Weekly Subscription (R)</label>
                                    <input type="number" class="form-control" value="300" id="tier3Subscription" min="10" step="10">
                                </div>
                            </div>
                            
                            <!-- Tier 4 -->
                            <div style="background: rgba(230, 126, 34, 0.05); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
                                <h4 style="color: var(--gold); margin-bottom: 15px;">Tier 4 - Gold</h4>
                                <div class="form-group">
                                    <label>Initial Investment (R)</label>
                                    <input type="number" class="form-control" value="4000" id="tier4Investment" min="100" step="100">
                                </div>
                                <div class="form-group">
                                    <label>Shares</label>
                                    <input type="number" class="form-control" value="4" id="tier4Shares" readonly style="background: rgba(230, 126, 34, 0.1); cursor: not-allowed;">
                                </div>
                                <div class="form-group">
                                    <label>Weekly Subscription (R)</label>
                                    <input type="number" class="form-control" value="400" id="tier4Subscription" min="10" step="10">
                                </div>
                            </div>
                            
                            <!-- Tier 5 -->
                            <div style="background: rgba(0, 122, 77, 0.05); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
                                <h4 style="color: var(--success); margin-bottom: 15px;">Tier 5 - Platinum</h4>
                                <div class="form-group">
                                    <label>Initial Investment (R)</label>
                                    <input type="number" class="form-control" value="5000" id="tier5Investment" min="100" step="100">
                                </div>
                                <div class="form-group">
                                    <label>Shares</label>
                                    <input type="number" class="form-control" value="5" id="tier5Shares" readonly style="background: rgba(0, 122, 77, 0.1); cursor: not-allowed;">
                                </div>
                                <div class="form-group">
                                    <label>Weekly Subscription (R)</label>
                                    <input type="number" class="form-control" value="500" id="tier5Subscription" min="10" step="10">
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 25px;">
                            <button class="btn btn-primary" onclick="saveTierSettings()" style="width: 100%; max-width: 300px; margin: 0 auto; display: block;">
                                <span>💾 Save Tier Configuration</span>
                            </button>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: rgba(255, 75, 87, 0.1); border-radius: 8px; border-left: 4px solid var(--danger);">
                            <strong style="color: var(--danger);">⚠️ Important:</strong>
                            <p style="margin: 5px 0 0 0; font-size: 14px; color: var(--text-muted);">
                                Tier changes only affect new member registrations. Existing members retain their current tier settings unless manually updated.
                            </p>
                        </div>
                    </div>
                    
                    <!-- General Settings -->
                    <div class="card">
                        <h3 style="margin-bottom: 20px; color: var(--accent); font-size: 20px; display: flex; align-items: center; gap: 10px;">
                            <span>⚙️</span> General Settings
                        </h3>
                        
                        <div style="max-width: 600px;">
                            <div class="form-group">
                                <label>Club Name</label>
                                <input type="text" class="form-control" value='Masonko Stokvel "Guptas"' id="clubName">
                                <small style="color: var(--text-muted); font-size: 13px; margin-top: 5px; display: block;">
                                    This name appears in documents, reports, and the header
                                </small>
                            </div>
                            
                            <div class="form-group">
                                <label>Interest Rate on Loans (%)</label>
                                <input type="number" class="form-control" value="10" id="loanInterestRate" min="0" max="50" step="0.5">
                                <small style="color: var(--text-muted); font-size: 13px; margin-top: 5px; display: block;">
                                    Default interest rate applied to new loans
                                </small>
                            </div>
                            
                            <div class="form-group">
                                <label>Late Payment Grace Period (days)</label>
                                <input type="number" class="form-control" value="7" id="gracePeriod" min="0" max="30">
                                <small style="color: var(--text-muted); font-size: 13px; margin-top: 5px; display: block;">
                                    Days before marking a member as late on payments
                                </small>
                            </div>
                            
                            <div style="margin-top: 25px;">
                                <button class="btn btn-primary" onclick="saveGeneralSettings()">
                                    <span>💾 Save General Settings</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            
            <!-- Meeting Minutes View -->
            <div id="minutes" class="view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h2>Meeting Minutes</h2>
                    <button class="btn btn-primary" onclick="openModal('newMinutesModal')" id="createMinutesBtn"><span>+ New Meeting Minutes</span></button>
                </div>
                
                <div class="ai-insight">
                    <div class="ai-insight-title">Meeting Notes Management</div>
                    <div class="ai-insight-content">
                        Create professional meeting minutes that can be shared with all members as PDF documents. All minutes are automatically saved and archived for future reference.
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Meeting Date</th>
                                <th>Meeting Type</th>
                                <th>Attendees</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="minutesTable">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- Modals -->
    <div class="modal" id="addMemberModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add New Member</div>
                <button class="close-modal" onclick="closeModal('addMemberModal')">×</button>
            </div>
            <form onsubmit="addMember(event)">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" required id="memberName">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" required id="memberEmail">
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" required id="memberPhone">
                </div>
                <div class="form-group">
                    <label>Membership Tier</label>
                    <select id="memberTier" required onchange="updateTierInfo()">
                        <option value="">Select Tier</option>
                        <option value="1">Tier 1 - R1,000 (1 Share) - R100/week</option>
                        <option value="2">Tier 2 - R2,000 (2 Shares) - R200/week</option>
                        <option value="3">Tier 3 - R3,000 (3 Shares) - R300/week</option>
                        <option value="4">Tier 4 - R4,000 (4 Shares) - R400/week</option>
                        <option value="5">Tier 5 - R5,000 (5 Shares) - R500/week</option>
                    </select>
                    <div id="tierInfo" style="margin-top: 10px; padding: 10px; background: rgba(0, 180, 216, 0.1); border-radius: 8px; display: none; font-size: 13px;">
                        <strong>Initial Investment:</strong> <span id="tierInvestment"></span><br>
                        <strong>Shares:</strong> <span id="tierShares"></span><br>
                        <strong>Weekly Subscription:</strong> <span id="tierSubscription"></span><br>
                        <strong>Late Fee:</strong> R 50 per week
                    </div>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="memberRole">
                        <option value="member">Regular Member</option>
                        <option value="admin">Admin</option>
                        <option value="vice-chair">Vice Chairperson</option>
                        <option value="treasurer">Treasurer</option>
                        <option value="loan-officer">Loan Officer</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addMemberModal')"><span>Cancel</span></button>
                    <button type="submit" class="btn btn-primary"><span>Add Member</span></button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="modal" id="recordContributionModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Record Contribution</div>
                <button class="close-modal" onclick="closeModal('recordContributionModal')">×</button>
            </div>
            <form onsubmit="recordContribution(event)">
                <div class="form-group">
                    <label>Member</label>
                    <select id="contributionMember" required onchange="updateContributionAmount()">
                        <option value="">Select Member</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Amount Due</label>
                    <input type="number" required id="contributionAmount2" readonly style="background: rgba(0, 180, 216, 0.1);">
                    <div id="contributionBreakdown" style="margin-top: 8px; font-size: 13px; color: var(--text-muted);"></div>
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="paymentMethod">
                        <option value="eft">EFT</option>
                        <option value="cash">Cash</option>
                        <option value="card">Card</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Reference/Proof</label>
                    <input type="text" id="paymentReference" placeholder="Enter payment reference number">
                </div>
                
                <!-- Camera/Upload Section -->
                <div class="form-group">
                    <label>Proof of Payment (Deposit Slip)</label>
                    <div style="margin-bottom: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="openCamera()" style="margin-right: 10px;">
                            <span>📷 Take Photo</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('fileUpload').click()">
                            <span>📁 Upload File</span>
                        </button>
                    </div>
                    <input type="file" id="fileUpload" accept="image/*" style="display: none;" onchange="handleFileUpload(event)">
                    <input type="file" id="cameraCapture" accept="image/*" capture="environment" style="display: none;" onchange="handleCameraCapture(event)">
                    
                    <!-- Preview Area -->
                    <div id="proofPreview" style="display: none; margin-top: 15px;">
                        <div style="position: relative; border: 2px solid var(--accent); border-radius: 12px; padding: 10px; background: rgba(0, 0, 0, 0.3);">
                            <button type="button" onclick="removeProof()" style="position: absolute; top: 5px; right: 5px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-weight: bold;">×</button>
                            <img id="proofImage" style="width: 100%; max-height: 300px; object-fit: contain; border-radius: 8px;">
                            <div style="margin-top: 10px; font-size: 13px; color: var(--text-muted);" id="proofFileName"></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="applyLateFee" onchange="updateContributionAmount()" style="width: auto; margin-right: 8px;">
                        Apply Late Payment Fine (R 50)
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('recordContributionModal')"><span>Cancel</span></button>
                    <button type="submit" class="btn btn-primary"><span>Record Payment</span></button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="modal" id="newLoanModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">Masonko Loan Application Form</div>
                <button class="close-modal" onclick="closeModal('newLoanModal')">×</button>
            </div>
            <form onsubmit="createLoan(event)">
                <!-- Loan Reference Numbers -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; padding: 15px; background: rgba(0, 180, 216, 0.1); border-radius: 8px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Loan Cycle No</label>
                        <input type="text" id="loanCycleNo" readonly value="2026-01">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Loan No</label>
                        <input type="text" id="loanNo" readonly value="AUTO">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Masonko Registration No</label>
                        <input type="text" id="regNo" readonly>
                    </div>
                </div>
                
                <h3 style="color: var(--accent); margin: 20px 0 15px; font-size: 16px;">Personal Information</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Applicant (Member)</label>
                        <select id="loanMember" required onchange="populateMemberInfo()">
                            <option value="">Select Member</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>First Names</label>
                        <input type="text" id="loanFirstNames" readonly>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Type of Identification</label>
                        <select id="idType">
                            <option value="SA ID">SA ID</option>
                            <option value="Passport">Passport</option>
                            <option value="Driver's License">Driver's License</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Identification No</label>
                        <input type="text" id="idNumber" required>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Personal Cell Phone No</label>
                        <input type="tel" id="loanPhone" readonly>
                    </div>
                    <div class="form-group">
                        <label>Alternative Tel No</label>
                        <input type="tel" id="altPhone">
                    </div>
                </div>
                
                <h3 style="color: var(--accent); margin: 20px 0 15px; font-size: 16px;">Residential Address</h3>
                
                <div class="form-group">
                    <label>Stand/House Number & Street</label>
                    <input type="text" id="residentialAddress" required>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 100px 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="resLocation">
                    </div>
                    <div class="form-group">
                        <label>Suburb/Township</label>
                        <input type="text" id="resSuburb">
                    </div>
                    <div class="form-group">
                        <label>Area Code</label>
                        <input type="text" id="resAreaCode">
                    </div>
                    <div class="form-group">
                        <label>Province</label>
                        <select id="resProvince">
                            <option value="Gauteng">Gauteng</option>
                            <option value="Western Cape">Western Cape</option>
                            <option value="KwaZulu-Natal">KwaZulu-Natal</option>
                            <option value="Eastern Cape">Eastern Cape</option>
                            <option value="Free State">Free State</option>
                            <option value="Limpopo">Limpopo</option>
                            <option value="Mpumalanga">Mpumalanga</option>
                            <option value="Northern Cape">Northern Cape</option>
                            <option value="North West">North West</option>
                        </select>
                    </div>
                </div>
                
                <h3 style="color: var(--accent); margin: 20px 0 15px; font-size: 16px;">Business Address (If Applicable)</h3>
                
                <div class="form-group">
                    <label>Business Address & Street</label>
                    <input type="text" id="businessAddress">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 100px 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="bizLocation">
                    </div>
                    <div class="form-group">
                        <label>Suburb/Township</label>
                        <input type="text" id="bizSuburb">
                    </div>
                    <div class="form-group">
                        <label>Area Code</label>
                        <input type="text" id="bizAreaCode">
                    </div>
                    <div class="form-group">
                        <label>Province</label>
                        <select id="bizProvince">
                            <option value="">N/A</option>
                            <option value="Gauteng">Gauteng</option>
                            <option value="Western Cape">Western Cape</option>
                            <option value="KwaZulu-Natal">KwaZulu-Natal</option>
                            <option value="Eastern Cape">Eastern Cape</option>
                            <option value="Free State">Free State</option>
                            <option value="Limpopo">Limpopo</option>
                            <option value="Mpumalanga">Mpumalanga</option>
                            <option value="Northern Cape">Northern Cape</option>
                            <option value="North West">North West</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Business Telephone No</label>
                        <input type="tel" id="bizPhone">
                    </div>
                    <div class="form-group">
                        <label>Email (If Any)</label>
                        <input type="email" id="loanEmail" readonly>
                    </div>
                </div>
                
                <h3 style="color: var(--accent); margin: 20px 0 15px; font-size: 16px;">Loan Details</h3>
                
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                    <div class="form-group">
                        <label>Loan Desired (Amount)</label>
                        <input type="number" id="loanAmount" required min="100" step="100" onchange="calculateLoanDetails()">
                    </div>
                    <div class="form-group">
                        <label>Duration (Weeks)</label>
                        <input type="number" id="loanDurationWeeks" required min="1" max="52" value="24" onchange="calculateLoanDetails()">
                    </div>
                    <div class="form-group">
                        <label>Est Interest</label>
                        <input type="number" id="loanInterestCalc" readonly style="background: rgba(0, 180, 216, 0.1);">
                    </div>
                    <div class="form-group">
                        <label>Total P&I</label>
                        <input type="number" id="loanTotalPI" readonly style="background: rgba(0, 180, 216, 0.1);">
                    </div>
                </div>
                
                <h3 style="color: var(--accent); margin: 20px 0 15px; font-size: 16px;">Member's Shares & Savings</h3>
                
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                    <div class="form-group">
                        <label>No of Shares</label>
                        <input type="number" id="memberShares" readonly style="background: rgba(0, 180, 216, 0.1);">
                    </div>
                    <div class="form-group">
                        <label>Total Share Value</label>
                        <input type="number" id="shareValue" readonly style="background: rgba(0, 180, 216, 0.1);">
                    </div>
                    <div class="form-group">
                        <label>Savings</label>
                        <input type="number" id="memberSavings" readonly style="background: rgba(0, 180, 216, 0.1);">
                    </div>
                    <div class="form-group">
                        <label>By Date</label>
                        <input type="date" id="savingsDate" readonly style="background: rgba(0, 180, 216, 0.1);">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Total Shares + Savings</label>
                        <input type="number" id="totalSharesSavings" readonly style="background: rgba(0, 180, 216, 0.1);">
                    </div>
                    <div class="form-group">
                        <label>P&I Amount to be Guaranteed</label>
                        <input type="number" id="guaranteeAmount" readonly style="background: rgba(0, 180, 216, 0.1);">
                    </div>
                </div>
                
                <h3 style="color: var(--accent); margin: 20px 0 15px; font-size: 16px;">Type of Guarantee</h3>
                
                <div class="form-group">
                    <label>Tangible Collateral (Optional)</label>
                    <input type="text" id="collateralType" placeholder="e.g., Vehicle, Property, Equipment">
                </div>
                
                <div class="form-group">
                    <label>Estimated Value of Collateral</label>
                    <input type="number" id="collateralValue" min="0">
                </div>
                
                <h3 style="color: var(--accent); margin: 20px 0 15px; font-size: 16px;">Member Guarantors</h3>
                <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 15px;">
                    The following Masonko members guarantee this loan with their shares and savings (up to 5 guarantors):
                </p>
                
                <div id="guarantorsSection">
                    <div style="margin-bottom: 10px; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 150px; gap: 10px; align-items: end;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Guarantor 1</label>
                                <select id="guarantor1" onchange="validateAndUpdateGuarantor(1)" required>
                                    <option value="">Select Member</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Shares/Savings (R)</label>
                                <input type="number" id="guarantor1Value" readonly style="background: rgba(0, 180, 216, 0.1);">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 10px; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 150px; gap: 10px; align-items: end;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Guarantor 2 (Optional)</label>
                                <select id="guarantor2" onchange="validateAndUpdateGuarantor(2)">
                                    <option value="">Select Member</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Shares/Savings (R)</label>
                                <input type="number" id="guarantor2Value" readonly style="background: rgba(0, 180, 216, 0.1);">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 10px; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 150px; gap: 10px; align-items: end;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Guarantor 3 (Optional)</label>
                                <select id="guarantor3" onchange="validateAndUpdateGuarantor(3)">
                                    <option value="">Select Member</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Shares/Savings (R)</label>
                                <input type="number" id="guarantor3Value" readonly style="background: rgba(0, 180, 216, 0.1);">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 10px; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 150px; gap: 10px; align-items: end;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Guarantor 4 (Optional)</label>
                                <select id="guarantor4" onchange="validateAndUpdateGuarantor(4)">
                                    <option value="">Select Member</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Shares/Savings (R)</label>
                                <input type="number" id="guarantor4Value" readonly style="background: rgba(0, 180, 216, 0.1);">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 10px; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 150px; gap: 10px; align-items: end;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Guarantor 5 (Optional)</label>
                                <select id="guarantor5" onchange="validateAndUpdateGuarantor(5)">
                                    <option value="">Select Member</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Shares/Savings (R)</label>
                                <input type="number" id="guarantor5Value" readonly style="background: rgba(0, 180, 216, 0.1);">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Total Guarantee Summary -->
                    <div style="margin-top: 20px; padding: 15px; background: rgba(0, 122, 77, 0.15); border-radius: 8px; border: 2px solid var(--success);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong style="color: var(--success); font-size: 16px;">💰 Total Available Guarantee</strong>
                            <strong id="totalGuaranteeDisplay" style="color: var(--success); font-size: 20px;">R 0</strong>
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            Sum of all guarantor shares/savings. Your loan amount cannot exceed this total.
                        </div>
                    </div>
                </div>
                
                <!-- Banking Details Section -->
                <div style="background: rgba(0, 180, 216, 0.1); border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 4px solid var(--accent);">
                    <h3 style="color: var(--accent); margin-bottom: 15px; font-size: 18px; display: flex; align-items: center; gap: 10px;">
                        <span>🏦</span> Banking Details for Loan Disbursement
                    </h3>
                    
                    <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 20px;">
                        Please provide your bank account details where the loan amount will be deposited upon approval.
                    </p>
                    
                    <div class="form-group">
                        <label>Bank Name <span style="color: var(--danger);">*</span></label>
                        <select id="loanBankName" required onchange="updateBranchCode()">
                            <option value="">-- Select Your Bank --</option>
                            <option value="FNB" data-branch="250655">FNB (First National Bank)</option>
                            <option value="Standard Bank" data-branch="051001">Standard Bank</option>
                            <option value="Nedbank" data-branch="198765">Nedbank</option>
                            <option value="ABSA" data-branch="632005">ABSA</option>
                            <option value="Capitec" data-branch="470010">Capitec Bank</option>
                            <option value="TymeBank" data-branch="678910">TymeBank</option>
                            <option value="Bidvest Bank" data-branch="462005">Bidvest Bank</option>
                            <option value="African Bank" data-branch="430000">African Bank</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Branch Code <span style="color: var(--danger);">*</span></label>
                        <input type="text" id="loanBranchCode" required readonly placeholder="Auto-filled based on bank selection" style="background: rgba(0, 180, 216, 0.05); cursor: not-allowed;">
                        <small style="font-size: 12px; color: var(--text-muted); display: block; margin-top: 5px;">
                            Universal branch code for the selected bank
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label>Account Holder Name <span style="color: var(--danger);">*</span></label>
                        <input type="text" id="loanAccountName" required placeholder="Full name as it appears on bank account">
                        <small style="font-size: 12px; color: var(--text-muted); display: block; margin-top: 5px;">
                            Must match the name on your bank account exactly
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label>Account Number <span style="color: var(--danger);">*</span></label>
                        <input type="text" id="loanAccountNumber" required placeholder="Enter your bank account number" pattern="[0-9]{8,16}" maxlength="16">
                        <small style="font-size: 12px; color: var(--text-muted); display: block; margin-top: 5px;">
                            8-16 digit account number
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label>Account Type <span style="color: var(--danger);">*</span></label>
                        <select id="loanAccountType" required>
                            <option value="">-- Select Account Type --</option>
                            <option value="Cheque">Cheque Account</option>
                            <option value="Savings">Savings Account</option>
                            <option value="Current">Current Account</option>
                            <option value="Transmission">Transmission Account</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Reference / Payment Description</label>
                        <input type="text" id="loanReference" placeholder="e.g., Loan Payment - [Your Name]" maxlength="50">
                        <small style="font-size: 12px; color: var(--text-muted); display: block; margin-top: 5px;">
                            Optional: This reference will appear on your bank statement when loan is paid
                        </small>
                    </div>
                    
                    <div style="padding: 12px; background: rgba(230, 126, 34, 0.1); border-radius: 8px; border-left: 4px solid var(--gold); margin-top: 15px;">
                        <strong style="color: var(--gold);">⚠️ Important:</strong>
                        <p style="margin: 5px 0 0 0; font-size: 13px; color: var(--text-muted);">
                            Please verify your banking details carefully. Incorrect details may delay loan disbursement. The loan amount will be transferred to this account upon approval.
                        </p>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newLoanModal')"><span>Cancel</span></button>
                    <button type="submit" class="btn btn-primary"><span>Submit Application</span></button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Submit Payment Modal (For Members) -->
    <div class="modal" id="submitPaymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Submit My Payment</div>
                <button class="close-modal" onclick="closeModal('submitPaymentModal')">×</button>
            </div>
            <form onsubmit="submitMyPayment(event)">
                <div class="ai-insight" style="margin-bottom: 20px;">
                    <div class="ai-insight-title">Your Payment Details</div>
                    <div class="ai-insight-content" id="myPaymentInfo">
                        Loading...
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Amount Paid</label>
                    <input type="number" required id="myPaymentAmount" placeholder="Enter the amount you paid">
                </div>
                
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="myPaymentMethod" required>
                        <option value="eft">EFT/Bank Transfer</option>
                        <option value="cash">Cash</option>
                        <option value="card">Card Payment</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Payment Reference Number</label>
                    <input type="text" id="myPaymentReference" required placeholder="e.g., Transaction reference or receipt number">
                </div>
                
                <div class="form-group">
                    <label>Payment Date</label>
                    <input type="date" id="myPaymentDate" required>
                </div>
                
                <!-- Camera/Upload Section for Member -->
                <div class="form-group">
                    <label>Upload Deposit Slip / Proof of Payment *</label>
                    <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 10px;">
                        Take a photo of your deposit slip or upload a screenshot of your payment confirmation
                    </p>
                    <div style="margin-bottom: 10px;">
                        <button type="button" class="btn btn-primary" onclick="openMemberCamera()" style="margin-right: 10px;">
                            <span>📷 Take Photo</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('memberFileUpload').click()">
                            <span>📁 Upload File</span>
                        </button>
                    </div>
                    <input type="file" id="memberFileUpload" accept="image/*,application/pdf" style="display: none;" onchange="handleMemberFileUpload(event)">
                    <input type="file" id="memberCameraCapture" accept="image/*" capture="environment" style="display: none;" onchange="handleMemberCameraCapture(event)">
                    
                    <!-- Preview Area for Member -->
                    <div id="memberProofPreview" style="display: none; margin-top: 15px;">
                        <div style="position: relative; border: 2px solid var(--accent); border-radius: 12px; padding: 10px; background: rgba(0, 0, 0, 0.3);">
                            <button type="button" onclick="removeMemberProof()" style="position: absolute; top: 5px; right: 5px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-weight: bold;">×</button>
                            <img id="memberProofImage" style="width: 100%; max-height: 300px; object-fit: contain; border-radius: 8px; display: none;">
                            <div style="margin-top: 10px; font-size: 13px; color: var(--text-muted); text-align: center;" id="memberProofFileName"></div>
                        </div>
                    </div>
                    <input type="hidden" id="memberProofData" required>
                </div>
                
                <div class="form-group">
                    <label>Additional Notes (Optional)</label>
                    <textarea id="myPaymentNotes" placeholder="Add any additional information about your payment"></textarea>
                </div>
                
                <div style="background: rgba(230, 126, 34, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--gold);">
                    <strong>⚠️ Important:</strong> Your payment will be reviewed by the Treasurer. You'll receive a notification once it's confirmed.
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('submitPaymentModal')"><span>Cancel</span></button>
                    <button type="submit" class="btn btn-primary"><span>Submit Payment</span></button>
                </div>
            </form>
        </div>
    </div>
    
    
    <!-- New Meeting Minutes Modal -->
    <div class="modal" id="newMinutesModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title">Create Meeting Minutes</div>
                <button class="close-modal" onclick="closeModal('newMinutesModal')">×</button>
            </div>
            <form onsubmit="createMinutes(event)">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Meeting Date</label>
                        <input type="date" id="minutesDate" required>
                    </div>
                    <div class="form-group">
                        <label>Meeting Time</label>
                        <input type="time" id="minutesTime" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Meeting Type</label>
                    <select id="minutesType" required>
                        <option value="">Select Meeting Type</option>
                        <option value="Monthly General Meeting">Monthly General Meeting</option>
                        <option value="AGM">Annual General Meeting (AGM)</option>
                        <option value="Special Meeting">Special Meeting</option>
                        <option value="Committee Meeting">Committee Meeting</option>
                        <option value="Emergency Meeting">Emergency Meeting</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Meeting Venue</label>
                    <input type="text" id="minutesVenue" required placeholder="e.g., Community Hall, Online via Zoom">
                </div>
                
                <h3 style="color: var(--accent); margin: 20px 0 15px; font-size: 16px;">Attendees</h3>
                
                <div class="form-group">
                    <label>Present Members</label>
                    <div id="attendeesList" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 10px; background: rgba(0, 0, 0, 0.2);">
                        <!-- Will be populated with checkboxes -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Apologies (Absent)</label>
                    <textarea id="minutesApologies" rows="2" placeholder="List members who sent apologies"></textarea>
                </div>
                
                <h3 style="color: var(--accent); margin: 20px 0 15px; font-size: 16px;">Agenda & Discussion</h3>
                
                <div class="form-group">
                    <label>Opening & Welcome</label>
                    <textarea id="minutesOpening" rows="2" placeholder="Opening remarks by Chairperson"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Previous Minutes Review</label>
                    <textarea id="minutesPreviousReview" rows="2" placeholder="Approval of previous meeting minutes"></textarea>
                    
                    <!-- Proposer and Seconder Section -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; padding: 15px; background: rgba(0, 180, 216, 0.05); border-radius: 8px; border-left: 4px solid var(--accent);">
                        <div>
                            <label style="font-size: 13px; font-weight: 600; color: var(--accent); margin-bottom: 8px; display: block;">
                                📝 Proposer
                            </label>
                            <select id="minutesProposer" class="form-control" style="background: rgba(0, 180, 216, 0.1);">
                                <option value="">-- Select Proposer --</option>
                            </select>
                            <small style="color: var(--text-muted); font-size: 12px; display: block; margin-top: 5px;">
                                Member who proposes approval
                            </small>
                        </div>
                        
                        <div>
                            <label style="font-size: 13px; font-weight: 600; color: var(--gold); margin-bottom: 8px; display: block;">
                                ✅ Seconder
                            </label>
                            <select id="minutesSeconder" class="form-control" style="background: rgba(230, 126, 34, 0.1);">
                                <option value="">-- Select Seconder --</option>
                            </select>
                            <small style="color: var(--text-muted); font-size: 12px; display: block; margin-top: 5px;">
                                Member who seconds the approval
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Matters Arising</label>
                    <textarea id="minutesMattersArising" rows="3" placeholder="Updates on action items from previous meeting"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Financial Report (Treasurer)</label>
                    <textarea id="minutesFinancialReport" rows="4" placeholder="Current balance, contributions received, expenses, etc." required></textarea>
                </div>
                
                <div class="form-group">
                    <label>Loan Applications & Approvals</label>
                    <textarea id="minutesLoans" rows="3" placeholder="Loan applications discussed and decisions made"></textarea>
                </div>
                
                <div class="form-group">
                    <label>New Business / General Discussion</label>
                    <textarea id="minutesNewBusiness" rows="4" placeholder="New topics, proposals, member concerns" required></textarea>
                </div>
                
                <!-- Voting & Resolutions Section -->
                <div class="form-group">
                    <label style="font-size: 18px; color: var(--accent); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <span>🗳️</span> Voting & Resolutions
                    </label>
                    
                    <div style="padding: 15px; background: rgba(0, 180, 216, 0.05); border-radius: 8px; border-left: 4px solid var(--accent); margin-bottom: 15px;">
                        <p style="margin: 0; font-size: 14px; color: var(--text-muted);">
                            Document formal votes on investment decisions, new member inductions, constitutional changes, or other important matters requiring member approval.
                        </p>
                    </div>
                    
                    <div id="votingItemsContainer" style="margin-bottom: 15px;">
                        <!-- Voting items will be added here dynamically -->
                    </div>
                    
                    <button type="button" class="btn btn-secondary" onclick="addVotingItem()" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span style="font-size: 20px;">+</span>
                        <span>Add Voting Item</span>
                    </button>
                </div>
                
                <div class="form-group">
                    <label>Decisions & Resolutions</label>
                    <textarea id="minutesDecisions" rows="4" placeholder="Key decisions made and motions passed" required></textarea>
                </div>
                
                <div class="form-group">
                    <label>Action Items</label>
                    <textarea id="minutesActionItems" rows="3" placeholder="Tasks assigned with responsible persons and deadlines"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Next Meeting</label>
                    <input type="text" id="minutesNextMeeting" placeholder="Date and time for next meeting">
                </div>
                
                <div class="form-group">
                    <label>Closing Remarks</label>
                    <textarea id="minutesClosing" rows="2" placeholder="Closing remarks and adjournment time"></textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newMinutesModal')"><span>Cancel</span></button>
                    <button type="submit" class="btn btn-primary"><span>Save & Share Minutes</span></button>
                </div>
            </form>
        </div>
    </div>
    
    
    
    <!-- 2FA Verification Modal -->
    <div class="modal" id="twoFAModal" style="z-index: 10001;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title">🔐 Two-Factor Authentication</div>
                <button class="close-modal" onclick="cancel2FA()">×</button>
            </div>
            <form onsubmit="verify2FACode(event)">
                <div class="ai-insight" style="margin-bottom: 20px; background: rgba(0, 180, 216, 0.1);">
                    <div class="ai-insight-title">Verification Code Sent</div>
                    <div class="ai-insight-content" id="twoFAMessage">
                        We've sent a 6-digit verification code to your WhatsApp.
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Enter 6-Digit Code <span style="color: var(--danger);">*</span></label>
                    <input 
                        type="text" 
                        id="twoFACode" 
                        required 
                        maxlength="6" 
                        pattern="[0-9]{6}"
                        placeholder="000000"
                        autocomplete="off"
                        style="font-size: 24px; text-align: center; letter-spacing: 10px; font-weight: 600;"
                        oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                    >
                    <small style="font-size: 12px; color: var(--text-muted); display: block; margin-top: 5px;">
                        Code expires in <strong id="twoFATimer">5:00</strong>
                    </small>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="resend2FACode('whatsapp')" style="flex: 1; font-size: 13px;">
                        <span>📱 Resend via WhatsApp</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resend2FACode('email')" style="flex: 1; font-size: 13px;">
                        <span>📧 Send via Email</span>
                    </button>
                </div>
                
                <div style="padding: 12px; background: rgba(230, 126, 34, 0.1); border-radius: 8px; border-left: 4px solid var(--gold); margin-bottom: 20px; font-size: 13px;">
                    <strong>⚠️ Security Tip:</strong> Never share this code with anyone. Masonko Stokvel staff will never ask for your verification code.
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="cancel2FA()"><span>Cancel</span></button>
                    <button type="submit" class="btn btn-primary"><span>Verify & Login</span></button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Guarantor Response Modal -->

    <div class="modal" id="guarantorResponseModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">🤝 Guarantor Request Response</div>
                <button class="close-modal" onclick="closeModal('guarantorResponseModal')">×</button>
            </div>
            <form onsubmit="submitGuarantorResponse(event)">
                <input type="hidden" id="responseRequestId">
                
                <div class="ai-insight" style="margin-bottom: 20px;">
                    <div class="ai-insight-title">Loan Application Details</div>
                    <div class="ai-insight-content" id="guarantorRequestDetails">
                        Loading...
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Your Response <span style="color: var(--danger);">*</span></label>
                    <select id="guarantorResponseAction" required onchange="toggleAmountEdit()">
                        <option value="">-- Select Response --</option>
                        <option value="approved">✅ Approve - I agree to guarantee this loan</option>
                        <option value="approved-edited">✏️ Approve with Edited Amount</option>
                        <option value="rejected">❌ Reject - I cannot guarantee this loan</option>
                    </select>
                </div>
                
                <div class="form-group" id="editedAmountGroup" style="display: none;">
                    <label>Your Approved Amount <span style="color: var(--danger);">*</span></label>
                    <input type="number" id="guarantorApprovedAmount" min="0" step="0.01" placeholder="Enter amount you're willing to guarantee">
                    <small style="font-size: 12px; color: var(--text-muted); display: block; margin-top: 5px;">
                        Originally requested: <strong id="originalRequestedAmount">R 0</strong><br>
                        Your available shares/savings: <strong id="guarantorAvailableAmount">R 0</strong>
                    </small>
                </div>
                
                <div class="form-group">
                    <label>Comments / Reason (Optional)</label>
                    <textarea id="guarantorComments" rows="3" placeholder="Add any comments or explain your decision"></textarea>
                </div>
                
                <div style="padding: 12px; background: rgba(230, 126, 34, 0.1); border-radius: 8px; border-left: 4px solid var(--gold); margin-bottom: 20px;">
                    <strong style="color: var(--gold);">⚠️ Important:</strong>
                    <p style="margin: 5px 0 0 0; font-size: 13px; color: var(--text-muted);">
                        By approving, you agree that your shares/savings can be used to cover this loan if the borrower defaults. The approved amount will be held as collateral.
                    </p>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('guarantorResponseModal')"><span>Cancel</span></button>
                    <button type="submit" class="btn btn-primary"><span>Submit Response</span></button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="offline-indicator" id="offlineIndicator">
        ⚠️ You're offline - Changes will sync when connected
    </div>
    
    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        
        // WhatsApp Notification Settings
        const WHATSAPP_CONFIG = {
            // Set to true for testing without opening WhatsApp
            DEVELOPMENT_MODE: false,
            
            // Set to true to log messages to console instead of opening WhatsApp
            LOG_ONLY: false,
            
            // Set to true to show confirmation before sending
            CONFIRM_BEFORE_SEND: false
        };
        
        // IndexedDB Database Configuration
        const DB_NAME = 'MasonkoStokveldDB';
        const DB_VERSION = 1;
        let db;
        
        // Initialize IndexedDB
        function initDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('Database failed to open');
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    console.log('Database opened successfully');
                    loadDataFromDB();
                    resolve(db);
                };
                
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    
                    // Users/Members table
                    if (!db.objectStoreNames.contains('users')) {
                        const usersStore = db.createObjectStore('users', { keyPath: 'id', autoIncrement: true });
                        usersStore.createIndex('email', 'email', { unique: true });
                        usersStore.createIndex('phone', 'phone', { unique: true });
                        usersStore.createIndex('role', 'role', { unique: false });
                        usersStore.createIndex('approved', 'approved', { unique: false });
                    }
                    
                    // Contributions table
                    if (!db.objectStoreNames.contains('contributions')) {
                        const contribStore = db.createObjectStore('contributions', { keyPath: 'id', autoIncrement: true });
                        contribStore.createIndex('memberId', 'memberId', { unique: false });
                        contribStore.createIndex('date', 'date', { unique: false });
                        contribStore.createIndex('status', 'status', { unique: false });
                    }
                    
                    // Loans table
                    if (!db.objectStoreNames.contains('loans')) {
                        const loansStore = db.createObjectStore('loans', { keyPath: 'id', autoIncrement: true });
                        loansStore.createIndex('memberId', 'memberId', { unique: false });
                        loansStore.createIndex('status', 'status', { unique: false });
                    }
                    
                    // Pending Payments table
                    if (!db.objectStoreNames.contains('pendingPayments')) {
                        const pendingStore = db.createObjectStore('pendingPayments', { keyPath: 'id', autoIncrement: true });
                        pendingStore.createIndex('memberId', 'memberId', { unique: false });
                        pendingStore.createIndex('status', 'status', { unique: false });
                    }
                    
                    // Notifications table
                    if (!db.objectStoreNames.contains('notifications')) {
                        const notifsStore = db.createObjectStore('notifications', { keyPath: 'id', autoIncrement: true });
                        notifsStore.createIndex('userId', 'userId', { unique: false });
                        notifsStore.createIndex('unread', 'unread', { unique: false });
                    }
                    
                    // Chat Messages table
                    if (!db.objectStoreNames.contains('chatMessages')) {
                        const chatStore = db.createObjectStore('chatMessages', { keyPath: 'id', autoIncrement: true });
                        chatStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                    
                    // Settings table
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                    
                    console.log('Database setup complete');
                    
                    // Seed initial data
                    seedInitialData(e.target.transaction);
                };
            });
        }
        
        // Seed initial data
        function seedInitialData(transaction) {
            const usersStore = transaction.objectStore('users');
            const settingsStore = transaction.objectStore('settings');
            
            // Add default admin and treasurer
            const defaultUsers = [
                { 
                    id: 1, 
                    name: 'Admin User', 
                    email: 'admin@masonko.com', 
                    phone: '0821234567', 
                    password: 'admin123', 
                    role: 'admin', 
                    tier: 3, 
                    shares: 3, 
                    balance: 14400, 
                    joined: '2024-01-15', 
                    lastPayment: '2026-01-13', 
                    status: 'current', 
                    approved: true 
                },
                { 
                    id: 2, 
                    name: 'Treasurer User', 
                    email: 'treasurer@masonko.com', 
                    phone: '0832345678', 
                    password: 'treasurer123', 
                    role: 'treasurer', 
                    tier: 2, 
                    shares: 2, 
                    balance: 9600, 
                    joined: '2024-02-20', 
                    lastPayment: '2026-01-13', 
                    status: 'current', 
                    approved: true 
                },
                { 
                    id: 3, 
                    name: 'Loan Officer User', 
                    email: 'loanofficer@masonko.com', 
                    phone: '0843456789', 
                    password: 'member123', 
                    role: 'loan-officer', 
                    tier: 3, 
                    shares: 3, 
                    balance: 13800, 
                    joined: '2024-03-10', 
                    lastPayment: '2026-01-13', 
                    status: 'current', 
                    approved: true 
                }
            ];
            
            defaultUsers.forEach(user => {
                usersStore.add(user);
            });
            
            // Add default settings
            const defaultSettings = [
                { key: 'clubName', value: 'Masonko Stokvel-Guptas' },
                { key: 'lateFee', value: 50 },
                { key: 'loanInterestRate', value: 10 },
                { key: 'paymentDueDay', value: 1 },
                { key: 'smsNotifications', value: true },
                { key: 'whatsappNotifications', value: true },
                { key: 'aiInsights', value: true }
            ];
            
            defaultSettings.forEach(setting => {
                settingsStore.add(setting);
            });
        }
        
        // Database Helper Functions
        const DB = {
            // Add record to any store
            add: (storeName, data) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.add(data);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            
            // Get record by ID
            get: (storeName, id) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.get(id);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            
            // Get all records from store
            getAll: (storeName) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            
            // Update record
            update: (storeName, data) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(data);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            
            // Delete record
            delete: (storeName, id) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(id);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            },
            
            // Query by index
            getByIndex: (storeName, indexName, value) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const index = store.index(indexName);
                    const request = index.getAll(value);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            
            // Clear all data from store
            clear: (storeName) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        };
        
        // Load data from DB into appState
        async function loadDataFromDB() {
            try {
                // Load users
                const users = await DB.getAll('users');
                appState.users = users;
                appState.members = users.filter(u => u.approved);
                appState.pendingMembers = users.filter(u => !u.approved);
                
                // Load contributions
                const contributions = await DB.getAll('contributions');
                appState.contributions = contributions || [];
                
                // Load loans
                const loans = await DB.getAll('loans');
                appState.loans = loans || [];
                
                // Load pending payments
                const pendingPayments = await DB.getAll('pendingPayments');
                appState.pendingPayments = pendingPayments || [];
                
                // Load notifications
                const notifications = await DB.getAll('notifications');
                appState.notifications = notifications || [];
                
                // Load chat messages
                const chatMessages = await DB.getAll('chatMessages');
                appState.chatMessages = chatMessages || [];
                
                console.log('Data loaded from database');
            } catch (error) {
                console.error('Error loading data from database:', error);
            }
        }
        
        // Save data to DB
        async function saveToDB(storeName, data) {
            try {
                if (data.id) {
                    await DB.update(storeName, data);
                } else {
                    const id = await DB.add(storeName, data);
                    data.id = id;
                }
                return data;
            } catch (error) {
                console.error(`Error saving to ${storeName}:`, error);
                throw error;
            }
        }
        
        // App State Management
        const appState = {
            currentUser: null, // Will be set on login
            isLoggedIn: false,
            twoFASession: null, // Stores pending 2FA verification data
            users: [
                // Pre-seeded accounts - all members without permanent roles
                { id: 1, name: 'Admin User', email: 'admin@masonko.com', phone: '0821234567', password: 'admin123', tier: 3, shares: 3, balance: 14400, joined: '2024-01-15', lastPayment: '2026-01-13', status: 'current', approved: true },
                { id: 2, name: 'Treasurer User', email: 'treasurer@masonko.com', phone: '0832345678', password: 'treasurer123', tier: 2, shares: 2, balance: 9600, joined: '2024-02-20', lastPayment: '2026-01-13', status: 'current', approved: true },
                { id: 3, name: 'Loan Officer User', email: 'loanofficer@masonko.com', phone: '0843456789', password: 'member123', tier: 3, shares: 3, balance: 13800, joined: '2024-03-10', lastPayment: '2026-01-13', status: 'current', approved: true },
                { id: 9, name: 'Secretary User', email: 'secretary@masonko.com', phone: '0809012345', password: 'secretary123', tier: 2, shares: 2, balance: 9800, joined: '2024-02-15', lastPayment: '2026-01-13', status: 'current', approved: true }
            ],
            pendingMembers: [],
            // Elected positions - can be changed/reassigned
            electedPositions: {
                chairperson: { memberId: 1, electedDate: '2024-01-20', term: '2024-2025' },
                viceChairperson: { memberId: 5, electedDate: '2024-01-20', term: '2024-2025' },
                treasurer: { memberId: 2, electedDate: '2024-01-20', term: '2024-2025' },
                secretary: { memberId: 9, electedDate: '2024-01-20', term: '2024-2025' },
                loanOfficer: { memberId: 3, electedDate: '2024-01-20', term: '2024-2025' },
                paymentLoader: { memberId: null, electedDate: null, term: '2024-2025' },
                paymentReleaser: { memberId: null, electedDate: null, term: '2024-2025' }
            },
            tiers: {
                1: { shares: 1, weeklySubscription: 100, initialInvestment: 1000 },
                2: { shares: 2, weeklySubscription: 200, initialInvestment: 2000 },
                3: { shares: 3, weeklySubscription: 300, initialInvestment: 3000 },
                4: { shares: 4, weeklySubscription: 400, initialInvestment: 4000 },
                5: { shares: 5, weeklySubscription: 500, initialInvestment: 5000 }
            },
            lateFee: 50,
            members: [
                { id: 1, name: 'Admin User', email: 'admin@masonko.com', phone: '0821234567', tier: 3, shares: 3, balance: 14400, joined: '2024-01-15', lastPayment: '2026-01-13', status: 'current' },
                { id: 2, name: 'Treasurer User', email: 'treasurer@masonko.com', phone: '0832345678', tier: 2, shares: 2, balance: 9600, joined: '2024-02-20', lastPayment: '2026-01-13', status: 'current' },
                { id: 3, name: 'Loan Officer User', email: 'loanofficer@masonko.com', phone: '0843456789', tier: 3, shares: 3, balance: 13800, joined: '2024-03-10', lastPayment: '2026-01-13', status: 'current' },
                { id: 4, name: 'Member 4', email: 'member4@email.com', phone: '0854567890', tier: 2, shares: 2, balance: 9200, joined: '2024-03-25', lastPayment: '2026-01-06', status: 'late' },
                { id: 5, name: 'Member 5', email: 'member5@email.com', phone: '0865678901', tier: 1, shares: 1, balance: 4800, joined: '2024-04-05', lastPayment: '2026-01-13', status: 'current' },
                { id: 6, name: 'Member 6', email: 'member6@email.com', phone: '0876789012', tier: 3, shares: 3, balance: 14100, joined: '2024-04-15', lastPayment: '2026-01-13', status: 'current' },
                { id: 7, name: 'Member 7', email: 'member7@email.com', phone: '0887890123', tier: 1, shares: 1, balance: 4600, joined: '2024-05-01', lastPayment: '2026-01-13', status: 'current' },
                { id: 8, name: 'Member 8', email: 'member8@email.com', phone: '0898901234', tier: 2, shares: 2, balance: 9400, joined: '2024-05-10', lastPayment: '2026-01-06', status: 'late' },
                { id: 9, name: 'Secretary User', email: 'secretary@masonko.com', phone: '0809012345', tier: 2, shares: 2, balance: 9800, joined: '2024-02-15', lastPayment: '2026-01-13', status: 'current' }
            ],
            contributions: [],
            loans: [
                { id: 1, memberId: 3, amount: 10000, term: 6, interest: 10, outstanding: 8500, nextPayment: '2026-02-15', status: 'active' },
                { id: 2, memberId: 4, amount: 5000, term: 4, interest: 10, outstanding: 3500, nextPayment: '2026-02-15', status: 'active' }
            ],
            meetingMinutes: [],
            guarantorRequests: [], // New: Stores guarantor approval requests
            notifications: [
                { id: 1, type: 'payment', title: 'Payment Received', message: 'A member contributed R 800', time: '2 hours ago', unread: true },
                { id: 2, type: 'reminder', title: 'Payment Due', message: '3 members have payments due tomorrow', time: '5 hours ago', unread: true },
                { id: 3, type: 'loan', title: 'Loan Payment', message: 'A member paid R 2,500 loan installment', time: '1 day ago', unread: false }
            ],
            chatMessages: [
                { id: 1, sender: 'Treasurer User', message: 'Good morning everyone! Reminder that contributions are due on the 15th.', time: '09:30', isSent: false },
                { id: 2, sender: 'You', message: 'Thanks! I have already made my payment.', time: '09:45', isSent: true },
                { id: 3, sender: 'Loan Officer User', message: 'Can we discuss investment opportunities at the next meeting?', time: '10:15', isSent: false }
            ]
        };
        
        // Helper function to get member's current role(s)
        function getMemberRoles(memberId) {
            const roles = [];
            if (appState.electedPositions.chairperson?.memberId === memberId) roles.push('chairperson');
            if (appState.electedPositions.viceChairperson?.memberId === memberId) roles.push('vice-chair');
            if (appState.electedPositions.treasurer?.memberId === memberId) roles.push('treasurer');
            if (appState.electedPositions.secretary?.memberId === memberId) roles.push('secretary');
            if (appState.electedPositions.loanOfficer?.memberId === memberId) roles.push('loan-officer');
            if (appState.electedPositions.paymentLoader?.memberId === memberId) roles.push('payment-loader');
            if (appState.electedPositions.paymentReleaser?.memberId === memberId) roles.push('payment-releaser');
            return roles.length > 0 ? roles : ['member'];
        }
        
        // Helper function to check if member has specific permission
        function hasPermission(memberId, permission) {
            // Admin User (ID: 1) always has all permissions
            if (memberId === 1) return true;
            
            const roles = getMemberRoles(memberId);
            
            const permissions = {
                'approve_members': ['chairperson', 'treasurer'],
                'record_payments': ['treasurer', 'chairperson'],
                'approve_payments': ['treasurer', 'chairperson'],
                'approve_loans': ['loan-officer', 'chairperson'],
                'load_payments': ['payment-loader', 'treasurer', 'chairperson'],
                'release_payments': ['payment-releaser', 'treasurer', 'chairperson'],
                'create_minutes': ['secretary', 'chairperson'],
                'view_reports': ['chairperson', 'treasurer', 'secretary', 'loan-officer', 'vice-chair', 'payment-loader', 'payment-releaser']
            };
            
            return permissions[permission]?.some(role => roles.includes(role)) || false;
        }
        
        // Payment Proof Upload Functions
        let currentProofData = null;
        let currentMemberProofData = null;
        
        // Password Toggle Function
        function togglePassword(inputId, iconElement) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                iconElement.textContent = '🙈'; // Closed eye
            } else {
                input.type = 'password';
                iconElement.textContent = '👁️'; // Open eye
            }
        }
        
        // Password Strength Checker
        function checkPasswordStrength(password) {
            // Check requirements
            const hasLength = password.length >= 8;
            const hasUppercase = /[A-Z]/.test(password);
            const hasLowercase = /[a-z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSymbol = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
            
            // Update requirement indicators
            updateRequirement('req-length', hasLength);
            updateRequirement('req-uppercase', hasUppercase);
            updateRequirement('req-lowercase', hasLowercase);
            updateRequirement('req-number', hasNumber);
            updateRequirement('req-symbol', hasSymbol);
            
            // Calculate strength
            let strength = 0;
            if (hasLength) strength++;
            if (hasUppercase) strength++;
            if (hasLowercase) strength++;
            if (hasNumber) strength++;
            if (hasSymbol) strength++;
            
            // Update strength bar
            const strengthBar = document.getElementById('strength-bar');
            const strengthText = document.getElementById('strength-text');
            
            if (password.length === 0) {
                strengthBar.className = 'password-strength-bar';
                strengthText.textContent = '';
                strengthText.style.color = '';
            } else if (strength < 3) {
                strengthBar.className = 'password-strength-bar weak';
                strengthText.textContent = 'Weak Password';
                strengthText.style.color = 'var(--danger)';
            } else if (strength < 5) {
                strengthBar.className = 'password-strength-bar medium';
                strengthText.textContent = 'Medium Password';
                strengthText.style.color = 'var(--gold)';
            } else {
                strengthBar.className = 'password-strength-bar strong';
                strengthText.textContent = 'Strong Password';
                strengthText.style.color = 'var(--success)';
            }
            
            // Check if passwords match when confirm field is not empty
            checkPasswordMatch();
            
            return strength === 5;
        }
        
        function updateRequirement(id, met) {
            const element = document.getElementById(id);
            if (met) {
                element.classList.add('met');
            } else {
                element.classList.remove('met');
            }
        }
        
        function checkPasswordMatch() {
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const messageDiv = document.getElementById('password-match-message');
            
            if (confirmPassword.length === 0) {
                messageDiv.textContent = '';
                return;
            }
            
            if (password === confirmPassword) {
                messageDiv.textContent = '✓ Passwords match';
                messageDiv.style.color = 'var(--success)';
                return true;
            } else {
                messageDiv.textContent = '✗ Passwords do not match';
                messageDiv.style.color = 'var(--danger)';
                return false;
            }
        }
        
        function validatePasswordRequirements(password) {
            const hasLength = password.length >= 8;
            const hasUppercase = /[A-Z]/.test(password);
            const hasLowercase = /[a-z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSymbol = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
            
            return hasLength && hasUppercase && hasLowercase && hasNumber && hasSymbol;
        }
        
        function openCamera() {
            document.getElementById('cameraCapture').click();
        }
        
        function handleCameraCapture(event) {
            const file = event.target.files[0];
            if (file) {
                processProofFile(file);
            }
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processProofFile(file);
            }
        }
        
        function processProofFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file (JPG, PNG, etc.)');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentProofData = {
                    fileName: file.name,
                    fileType: file.type,
                    fileSize: file.size,
                    dataUrl: e.target.result,
                    uploadDate: new Date().toISOString()
                };
                
                // Show preview
                document.getElementById('proofImage').src = e.target.result;
                document.getElementById('proofFileName').textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                document.getElementById('proofPreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
        
        function removeProof() {
            currentProofData = null;
            document.getElementById('proofPreview').style.display = 'none';
            document.getElementById('proofImage').src = '';
            document.getElementById('proofFileName').textContent = '';
            document.getElementById('cameraCapture').value = '';
            document.getElementById('fileUpload').value = '';
        }
        
        // Member Submit Payment Functions
        function openMemberCamera() {
            document.getElementById('memberCameraCapture').click();
        }
        
        function handleMemberCameraCapture(event) {
            const file = event.target.files[0];
            if (file) {
                processMemberProofFile(file);
            }
        }
        
        function handleMemberFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processMemberProofFile(file);
            }
        }
        
        function processMemberProofFile(file) {
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'application/pdf'];
            if (!validTypes.includes(file.type)) {
                alert('Please upload an image file (JPG, PNG, GIF) or PDF');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                alert('File size must be less than 5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentMemberProofData = {
                    fileName: file.name,
                    fileType: file.type,
                    fileSize: file.size,
                    dataUrl: e.target.result,
                    uploadDate: new Date().toISOString()
                };
                
                // Show preview
                if (file.type === 'application/pdf') {
                    document.getElementById('memberProofImage').style.display = 'none';
                    document.getElementById('memberProofFileName').innerHTML = `📄 ${file.name}<br>(${(file.size / 1024).toFixed(1)} KB)`;
                } else {
                    document.getElementById('memberProofImage').src = e.target.result;
                    document.getElementById('memberProofImage').style.display = 'block';
                    document.getElementById('memberProofFileName').textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                }
                document.getElementById('memberProofPreview').style.display = 'block';
                document.getElementById('memberProofData').value = 'uploaded'; // Mark as uploaded
            };
            reader.readAsDataURL(file);
        }
        
        function removeMemberProof() {
            currentMemberProofData = null;
            document.getElementById('memberProofPreview').style.display = 'none';
            document.getElementById('memberProofImage').src = '';
            document.getElementById('memberProofImage').style.display = 'none';
            document.getElementById('memberProofFileName').textContent = '';
            document.getElementById('memberCameraCapture').value = '';
            document.getElementById('memberFileUpload').value = '';
            document.getElementById('memberProofData').value = '';
        }
        
        function submitMyPayment(e) {
            e.preventDefault();
            
            if (!currentMemberProofData) {
                alert('Please upload proof of payment before submitting.');
                return;
            }
            
            const payment = {
                memberId: appState.currentUser.id,
                memberName: appState.currentUser.name,
                amount: parseFloat(document.getElementById('myPaymentAmount').value),
                method: document.getElementById('myPaymentMethod').value,
                reference: document.getElementById('myPaymentReference').value,
                date: document.getElementById('myPaymentDate').value,
                notes: document.getElementById('myPaymentNotes').value,
                proof: currentMemberProofData,
                status: 'pending',
                submittedDate: new Date().toISOString()
            };
            
            // Save to database
            saveToDB('pendingPayments', payment).then(savedPayment => {
                // Add to app state
                if (!appState.pendingPayments) {
                    appState.pendingPayments = [];
                }
                appState.pendingPayments.push(savedPayment);
                
                showNotification('Payment submitted successfully! The Treasurer will review and confirm your payment.', 'success');
                closeModal('submitPaymentModal');
                e.target.reset();
                removeMemberProof();
            }).catch(error => {
                console.error('Error submitting payment:', error);
                alert('Failed to submit payment. Please try again.');
            });
        }
        
        // Authentication Functions
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelector('.auth-tab:first-child').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.querySelector('.auth-tab:last-child').classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            }
        }
        
        function updateRegTierInfo() {
            const tierSelect = document.getElementById('regTier');
            const tier = parseInt(tierSelect.value);
            const tierInfoDiv = document.getElementById('regTierInfo');
            
            if (tier) {
                const tierData = appState.tiers[tier];
                document.getElementById('regTierInvestment').textContent = `R ${tierData.initialInvestment.toLocaleString()}`;
                document.getElementById('regTierShares').textContent = tierData.shares;
                document.getElementById('regTierSubscription').textContent = `R ${tierData.weeklySubscription}`;
                tierInfoDiv.style.display = 'block';
            } else {
                tierInfoDiv.style.display = 'none';
            }
        }
        
        function handleLogin(e) {
            e.preventDefault();
            
            const identifier = document.getElementById('loginIdentifier').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            // Find user by email or phone
            const user = appState.users.find(u => 
                (u.email === identifier || u.phone === identifier) && u.password === password
            );
            
            if (user) {
                if (!user.approved) {
                    alert('Your account is pending approval from the Admin or Treasurer.');
                    return;
                }
                
                // Send 2FA code via WhatsApp (primary) or Email (fallback)
                const sentVia = send2FACode(user, 'whatsapp');
                
                // Show 2FA modal
                openModal('twoFAModal');
                
                // Update message based on delivery method
                const messageDiv = document.getElementById('twoFAMessage');
                if (sentVia === 'whatsapp') {
                    messageDiv.innerHTML = `✅ We've sent a 6-digit verification code to your WhatsApp: <strong>${user.phone}</strong>`;
                } else {
                    messageDiv.innerHTML = `✅ We've sent a 6-digit verification code to your email: <strong>${user.email}</strong>`;
                }
                
                // Start countdown timer
                start2FATimer();
                
                // Focus on code input
                setTimeout(() => {
                    document.getElementById('twoFACode').focus();
                }, 500);
                
                console.log('2FA code sent to:', user.name);
                
            } else {
                alert('Invalid email/phone or password. Please try again.');
            }
        }
        
        function handleRegister(e) {
            e.preventDefault();
            
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            
            // Validate password requirements
            if (!validatePasswordRequirements(password)) {
                alert('Password does not meet all requirements.\n\nPlease ensure your password contains:\n• At least 8 characters\n• At least one uppercase letter (A-Z)\n• At least one lowercase letter (a-z)\n• At least one number (0-9)\n• At least one symbol (!@#$%^&*)');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }
            
            const email = document.getElementById('regEmail').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            
            // Check if user already exists
            if (appState.users.find(u => u.email === email || u.phone === phone)) {
                alert('An account with this email or phone number already exists.');
                return;
            }
            
            const tier = parseInt(document.getElementById('regTier').value);
            const tierData = appState.tiers[tier];
            
            // Create new pending member
            const newMember = {
                name: document.getElementById('regName').value.trim(),
                email: email,
                phone: phone,
                password: password,
                role: 'member',
                tier: tier,
                shares: tierData.shares,
                balance: 0,
                joined: new Date().toISOString().split('T')[0],
                lastPayment: null,
                status: 'pending',
                approved: false
            };
            
            // Save to database
            saveToDB('users', newMember).then(savedUser => {
                // Add to app state
                appState.pendingMembers.push(savedUser);
                appState.users.push(savedUser);
                
                // Show success message
                alert(`Registration submitted successfully!\n\nYour application has been sent to the Admin/Treasurer for approval.\n\nYou will receive a notification once your account is approved.\n\nInitial Investment Required: R ${tierData.initialInvestment.toLocaleString()}\nWeekly Subscription: R ${tierData.weeklySubscription}`);
                
                // Reset form and switch to login
                e.target.reset();
                document.getElementById('regTierInfo').style.display = 'none';
                
                // Reset password strength indicators
                document.querySelectorAll('.requirement').forEach(req => req.classList.remove('met'));
                document.getElementById('strength-bar').className = 'password-strength-bar';
                document.getElementById('strength-text').textContent = '';
                document.getElementById('password-match-message').textContent = '';
                
                switchAuthTab('login');
            }).catch(error => {
                console.error('Error saving user:', error);
                alert('Registration failed. Please try again.');
            });
        }
        
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                appState.currentUser = null;
                appState.isLoggedIn = false;
                localStorage.removeItem('masonkoUser');
                
                // Hide main app, show auth screen
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('authScreen').classList.remove('hidden');
                
                // Reset forms
                document.getElementById('loginForm').reset();
                document.getElementById('registerForm').reset();
            }
        }
        
        // Mobile Menu Toggle
        function toggleMobileMenu() {
            const nav = document.getElementById('mainNav');
            const hamburger = document.getElementById('hamburgerBtn');
            const overlay = document.getElementById('navOverlay');
            
            nav.classList.toggle('active');
            hamburger.classList.toggle('active');
            overlay.classList.toggle('active');
            
            // Prevent body scroll when menu is open
            if (nav.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }
        
        function closeMobileMenu() {
            const nav = document.getElementById('mainNav');
            const hamburger = document.getElementById('hamburgerBtn');
            const overlay = document.getElementById('navOverlay');
            
            nav.classList.remove('active');
            hamburger.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // Close mobile menu when a nav button is clicked
        document.addEventListener('DOMContentLoaded', function() {
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        toggleMobileMenu();
                    }
                });
            });
        });
        
        // Profile Picture Handling
        function handleProfilePicture(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showNotification('Please select an image file', 'error');
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('Image size should be less than 5MB', 'error');
                return;
            }
            
            // Read and display the image
            const reader = new FileReader();
            reader.onload = function(e) {
                const imgElement = document.getElementById('profilePicImage');
                const initialsElement = document.getElementById('profileInitials');
                const controls = document.getElementById('imagePositionControls');
                
                imgElement.src = e.target.result;
                imgElement.style.display = 'block';
                initialsElement.style.display = 'none';
                
                // Show position controls
                controls.style.display = 'block';
                
                // Reset position controls to defaults
                document.getElementById('positionX').value = 50;
                document.getElementById('positionY').value = 50;
                document.getElementById('zoomLevel').value = 100;
                
                // Apply default positioning
                updateImagePosition();
                
                // Save image data (will be saved with position when profile is updated)
                if (appState.currentUser) {
                    appState.currentUser.profilePictureData = e.target.result;
                }
                
                showNotification('Image uploaded! Adjust position and click "Save Changes" below.', 'success');
            };
            reader.readAsDataURL(file);
        }
        
        // Update Image Position
        function updateImagePosition() {
            const imgElement = document.getElementById('profilePicImage');
            const posX = document.getElementById('positionX').value;
            const posY = document.getElementById('positionY').value;
            const zoom = document.getElementById('zoomLevel').value;
            
            imgElement.style.objectPosition = `${posX}% ${posY}%`;
            imgElement.style.transform = `scale(${zoom / 100})`;
            
            // Store position settings
            if (appState.currentUser) {
                appState.currentUser.imagePosition = {
                    x: posX,
                    y: posY,
                    zoom: zoom
                };
            }
        }
        
        // Center Image
        function centerImage() {
            document.getElementById('positionX').value = 50;
            document.getElementById('positionY').value = 50;
            document.getElementById('zoomLevel').value = 100;
            updateImagePosition();
            showNotification('Image centered!', 'success');
        }
        
        // Reset Image Position
        function resetImagePosition() {
            centerImage();
        }
        
        // Remove Profile Picture
        function removeProfilePicture() {
            if (!confirm('Remove profile picture?')) return;
            
            const imgElement = document.getElementById('profilePicImage');
            const initialsElement = document.getElementById('profileInitials');
            const controls = document.getElementById('imagePositionControls');
            
            // Hide image, show initials
            imgElement.style.display = 'none';
            imgElement.src = '';
            initialsElement.style.display = 'flex';
            
            // Hide controls
            controls.style.display = 'none';
            
            // Remove from user data
            if (appState.currentUser) {
                delete appState.currentUser.profilePicture;
                delete appState.currentUser.profilePictureData;
                delete appState.currentUser.imagePosition;
                
                // Update in members array
                const memberIndex = appState.members.findIndex(m => m.id === appState.currentUser.id);
                if (memberIndex !== -1) {
                    delete appState.members[memberIndex].profilePicture;
                    delete appState.members[memberIndex].imagePosition;
                }
                
                // Update in users array
                const userIndex = appState.users.findIndex(u => u.username === appState.currentUser.username);
                if (userIndex !== -1) {
                    delete appState.users[userIndex].profilePicture;
                    delete appState.users[userIndex].imagePosition;
                }
                
                // Reset header avatar to initials
                const avatarElement = document.getElementById('userAvatar');
                const initials = appState.currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                avatarElement.style.backgroundImage = '';
                avatarElement.textContent = initials;
                
                saveData();
                showNotification('Profile picture removed', 'info');
            }
            
            // Clear file input
            document.getElementById('profilePicInput').value = '';
        }
        
        // Load Profile Data
        function loadProfileData() {
            if (!appState.currentUser) return;
            
            const user = appState.currentUser;
            const member = appState.members.find(m => m.id === user.id);
            
            // Load profile picture
            const imgElement = document.getElementById('profilePicImage');
            const initialsElement = document.getElementById('profileInitials');
            const controls = document.getElementById('imagePositionControls');
            
            if (user.profilePicture || user.profilePictureData) {
                const pictureSrc = user.profilePicture || user.profilePictureData;
                imgElement.src = pictureSrc;
                imgElement.style.display = 'block';
                initialsElement.style.display = 'none';
                controls.style.display = 'block';
                
                // Load saved position
                if (user.imagePosition) {
                    document.getElementById('positionX').value = user.imagePosition.x || 50;
                    document.getElementById('positionY').value = user.imagePosition.y || 50;
                    document.getElementById('zoomLevel').value = user.imagePosition.zoom || 100;
                    updateImagePosition();
                } else {
                    // Default center position
                    document.getElementById('positionX').value = 50;
                    document.getElementById('positionY').value = 50;
                    document.getElementById('zoomLevel').value = 100;
                    updateImagePosition();
                }
            } else {
                const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                initialsElement.textContent = initials;
                imgElement.style.display = 'none';
                initialsElement.style.display = 'flex';
                controls.style.display = 'none';
            }
            
            // Load form data
            document.getElementById('profileName').textContent = user.name;
            document.getElementById('profileRegNo').textContent = `MSK-${String(user.id).padStart(4, '0')}`;
            document.getElementById('profileNameInput').value = user.name;
            document.getElementById('profileEmailInput').value = user.email || '';
            document.getElementById('profileCellInput').value = user.cellNumber || '';
            document.getElementById('profileTierInput').value = `Tier ${member?.tier || 1} - R${member?.shares * 1000 || 1000}`;
            document.getElementById('profileJoinedInput').value = new Date(user.joinedDate || Date.now()).toLocaleDateString();
            
            // Load statistics
            const totalContributions = appState.contributions
                .filter(c => c.memberId === user.id)
                .reduce((sum, c) => sum + c.amount, 0);
            
            const activeLoans = appState.loans.filter(l => l.memberId === user.id && l.status === 'active').length;
            
            document.getElementById('profileTotalContributions').textContent = `R ${totalContributions.toLocaleString()}`;
            document.getElementById('profileActiveLoans').textContent = activeLoans;
            document.getElementById('profileStatus').textContent = member?.status || 'Active';
        }
        
        // Update Profile
        function updateProfile(event) {
            event.preventDefault();
            
            if (!appState.currentUser) return;
            
            const name = document.getElementById('profileNameInput').value;
            const email = document.getElementById('profileEmailInput').value;
            const cellNumber = document.getElementById('profileCellInput').value;
            
            // Save profile picture if uploaded
            if (appState.currentUser.profilePictureData) {
                appState.currentUser.profilePicture = appState.currentUser.profilePictureData;
                
                // Update header avatar with positioned image
                const avatarElement = document.getElementById('userAvatar');
                const imgElement = document.getElementById('profilePicImage');
                
                // Apply same positioning to header avatar
                avatarElement.style.backgroundImage = `url(${appState.currentUser.profilePicture})`;
                avatarElement.style.backgroundSize = imgElement.style.transform ? 
                    `${parseInt(imgElement.style.transform.match(/scale\(([\d.]+)\)/)[1]) * 100}%` : 'cover';
                avatarElement.style.backgroundPosition = imgElement.style.objectPosition || 'center';
                avatarElement.textContent = '';
            }
            
            // Update current user
            appState.currentUser.name = name;
            appState.currentUser.email = email;
            appState.currentUser.cellNumber = cellNumber;
            
            // Update in members array
            const memberIndex = appState.members.findIndex(m => m.id === appState.currentUser.id);
            if (memberIndex !== -1) {
                appState.members[memberIndex].name = name;
                appState.members[memberIndex].email = email;
                appState.members[memberIndex].cellNumber = cellNumber;
                appState.members[memberIndex].profilePicture = appState.currentUser.profilePicture;
                appState.members[memberIndex].imagePosition = appState.currentUser.imagePosition;
            }
            
            // Update in users array
            const userIndex = appState.users.findIndex(u => u.username === appState.currentUser.username);
            if (userIndex !== -1) {
                appState.users[userIndex].name = name;
                appState.users[userIndex].email = email;
                appState.users[userIndex].cellNumber = cellNumber;
                appState.users[userIndex].profilePicture = appState.currentUser.profilePicture;
                appState.users[userIndex].imagePosition = appState.currentUser.imagePosition;
            }
            
            // Update header display
            document.getElementById('profileName').textContent = name;
            
            saveData();
            showNotification('Profile updated successfully!', 'success');
            
            // Refresh any views that might show member data
            if (document.getElementById('members').classList.contains('active')) {
                loadMembers();
            }
        }
        
        // Reset Profile Form
        function resetProfileForm() {
            loadProfileData();
            showNotification('Changes cancelled', 'info');
        }
        
        // Change Password
        function changePassword(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validate current password
            if (currentPassword !== appState.currentUser.password) {
                showNotification('Current password is incorrect', 'error');
                return;
            }
            
            // Validate new passwords match
            if (newPassword !== confirmPassword) {
                showNotification('New passwords do not match', 'error');
                return;
            }
            
            // Validate password length
            if (newPassword.length < 6) {
                showNotification('Password must be at least 6 characters', 'error');
                return;
            }
            
            // Update password
            appState.currentUser.password = newPassword;
            
            // Update in users array
            const userIndex = appState.users.findIndex(u => u.username === appState.currentUser.username);
            if (userIndex !== -1) {
                appState.users[userIndex].password = newPassword;
            }
            
            saveData();
            
            // Clear form
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            showNotification('Password changed successfully!', 'success');
        }
        
        // Save Tier Settings
        function saveTierSettings() {
            const tierSettings = {
                tier1: {
                    investment: parseInt(document.getElementById('tier1Investment').value),
                    shares: 1,
                    subscription: parseInt(document.getElementById('tier1Subscription').value)
                },
                tier2: {
                    investment: parseInt(document.getElementById('tier2Investment').value),
                    shares: 2,
                    subscription: parseInt(document.getElementById('tier2Subscription').value)
                },
                tier3: {
                    investment: parseInt(document.getElementById('tier3Investment').value),
                    shares: 3,
                    subscription: parseInt(document.getElementById('tier3Subscription').value)
                },
                tier4: {
                    investment: parseInt(document.getElementById('tier4Investment').value),
                    shares: 4,
                    subscription: parseInt(document.getElementById('tier4Subscription').value)
                },
                tier5: {
                    investment: parseInt(document.getElementById('tier5Investment').value),
                    shares: 5,
                    subscription: parseInt(document.getElementById('tier5Subscription').value)
                }
            };
            
            appState.tierSettings = tierSettings;
            saveData();
            showNotification('Tier settings saved successfully!', 'success');
        }
        
        // Save General Settings
        function saveGeneralSettings() {
            appState.generalSettings = {
                clubName: document.getElementById('clubName').value,
                loanInterestRate: parseFloat(document.getElementById('loanInterestRate').value),
                gracePeriod: parseInt(document.getElementById('gracePeriod').value)
            };
            
            saveData();
            showNotification('General settings saved successfully!', 'success');
        }
        
        function showForgotPassword() {
            alert('Please contact the Admin (admin@masonko.com) or Treasurer (treasurer@masonko.com) to reset your password.');
        }
        
        function updateUserInterface() {
            if (!appState.currentUser) return;
            
            const initials = appState.currentUser.name.split(' ').map(n => n[0]).join('');
            document.getElementById('userAvatar').textContent = initials;
            
            // Display role badge - Admin for user ID 1, otherwise show elected position
            let roleDisplay;
            if (appState.currentUser.id === 1) {
                roleDisplay = 'Admin';
            } else {
                const roles = getMemberRoles(appState.currentUser.id);
                const primaryRole = roles[0] || 'member';
                roleDisplay = primaryRole.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
            }
            document.getElementById('userRoleBadge').textContent = roleDisplay;
            
            // Show Admin Panel button only for admin users
            const isAdmin = hasPermission(appState.currentUser.id, 'approve_members');
            const adminPanelBtn = document.getElementById('adminPanelNav');
            if (adminPanelBtn) {
                adminPanelBtn.style.display = isAdmin ? 'block' : 'none';
            }
            
            // Show/hide sections based on permissions
            if (hasPermission(appState.currentUser.id, 'approve_members')) {
                document.getElementById('pendingApprovalsSection').style.display = 'block';
                renderPendingMembers();
            }
            
            // Show/hide Meeting Minutes button for secretary/chairperson
            if (hasPermission(appState.currentUser.id, 'create_minutes')) {
                document.getElementById('minutesNav').style.display = 'block';
            } else {
                document.getElementById('minutesNav').style.display = 'none';
            }
            
            // Initialize data views
            renderMembers();
            renderContributions();
            renderLoans();
        }
        
        function renderPendingMembers() {
            const pending = appState.pendingMembers;
            const countDiv = document.getElementById('pendingCount');
            const listDiv = document.getElementById('pendingMembersList');
            
            countDiv.textContent = `${pending.length} new member application${pending.length !== 1 ? 's' : ''} awaiting your approval.`;
            
            if (pending.length === 0) {
                listDiv.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No pending applications</p>';
                return;
            }
            
            listDiv.innerHTML = pending.map(member => {
                const tierInfo = appState.tiers[member.tier];
                return `
                    <div class="member-card" style="border: 2px solid var(--gold);">
                        <div class="member-header">
                            <div class="member-avatar">${member.name.split(' ').map(n => n[0]).join('')}</div>
                            <div class="member-info">
                                <h3>${member.name}</h3>
                                <div class="member-role">New Application</div>
                            </div>
                        </div>
                        <div style="margin: 15px 0; padding: 12px; background: rgba(230, 126, 34, 0.1); border-radius: 8px;">
                            <div><strong>Email:</strong> ${member.email}</div>
                            <div><strong>Phone:</strong> ${member.phone}</div>
                            <div><strong>Tier:</strong> ${member.tier} (${member.shares} share${member.shares > 1 ? 's' : ''})</div>
                            <div><strong>Weekly Subscription:</strong> R ${tierInfo.weeklySubscription}</div>
                            <div><strong>Initial Investment:</strong> R ${tierInfo.initialInvestment.toLocaleString()}</div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" style="flex: 1;" onclick="approveMember(${member.id})"><span>✓ Approve</span></button>
                            <button class="btn btn-danger" style="flex: 1;" onclick="rejectMember(${member.id})"><span>✗ Reject</span></button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function approveMember(memberId) {
            if (confirm('Approve this member? They will be able to login immediately.')) {
                const member = appState.pendingMembers.find(m => m.id === memberId);
                if (member) {
                    member.approved = true;
                    member.status = 'current';
                    
                    // Update in database
                    saveToDB('users', member).then(() => {
                        // Move from pending to active members
                        appState.pendingMembers = appState.pendingMembers.filter(m => m.id !== memberId);
                        
                        // Check if already in members array
                        if (!appState.members.find(m => m.id === memberId)) {
                            appState.members.push(member);
                        }
                        
                        renderPendingMembers();
                        renderMembers();
                        showNotification(`${member.name} has been approved and added to the stokveld!`, 'success');
                    }).catch(error => {
                        console.error('Error approving member:', error);
                        alert('Failed to approve member. Please try again.');
                    });
                }
            }
        }
        
        function rejectMember(memberId) {
            if (confirm('Reject this member application? This cannot be undone.')) {
                const member = appState.pendingMembers.find(m => m.id === memberId);
                if (member) {
                    appState.pendingMembers = appState.pendingMembers.filter(m => m.id !== memberId);
                    appState.users = appState.users.filter(u => u.id !== memberId);
                    
                    renderPendingMembers();
                    showNotification(`Application from ${member.name} has been rejected.`, 'success');
                }
            }
        }
        
        // Check for saved login on page load
        window.addEventListener('DOMContentLoaded', async () => {
            // Initialize database first
            try {
                await initDatabase();
                console.log('Database initialized successfully');
            } catch (error) {
                console.error('Database initialization failed:', error);
                alert('Database initialization failed. The app may not work properly.');
            }
            
            const savedUser = localStorage.getItem('masonkoUser');
            if (savedUser) {
                const user = JSON.parse(savedUser);
                // Verify user still exists and is approved
                const currentUser = appState.users.find(u => u.email === user.email && u.approved);
                if (currentUser) {
                    appState.currentUser = currentUser;
                    appState.isLoggedIn = true;
                    document.getElementById('authScreen').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    updateUserInterface();
                }
            }
        });
        
        // Navigation
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const view = btn.dataset.view;
                
                // Update active nav button
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Show/hide views
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(view).classList.add('active');
                
                // Load view-specific data
                loadViewData(view);
            });
        });
        
        function loadViewData(view) {
            switch(view) {
                case 'members':
                    renderMembers();
                    break;
                case 'contributions':
                    renderContributions();
                    break;
                case 'loans':
                    renderLoans();
                    break;
                case 'minutes':
                    renderMinutes();
                    break;
                case 'chat':
                    renderChat();
                    break;
                case 'notifications':
                    renderNotifications();
                    break;
                case 'settings':
                    loadProfileData();
                    renderGuarantorRequests();
                    break;
                case 'leadership':
                    renderLeadershipDisplay();
                    break;
                case 'adminPanel':
                    renderLeadershipDisplay();
                    break;
            }
        }
        
        // Render Members
        // Member view state
        let currentMemberView = 'tile'; // 'tile' or 'list'
        
        function switchMemberView(view) {
            currentMemberView = view;
            const grid = document.getElementById('memberGrid');
            const listBtn = document.getElementById('listViewBtn');
            const tileBtn = document.getElementById('tileViewBtn');
            
            if (view === 'list') {
                grid.classList.add('list-view');
                listBtn.style.background = 'var(--accent)';
                listBtn.style.borderColor = 'var(--accent)';
                tileBtn.style.background = '';
                tileBtn.style.borderColor = '';
            } else {
                grid.classList.remove('list-view');
                tileBtn.style.background = 'var(--accent)';
                tileBtn.style.borderColor = 'var(--accent)';
                listBtn.style.background = '';
                listBtn.style.borderColor = '';
            }
            
            renderMembers();
        }
        
        function calculateMemberFinancials(member) {
            const tierInfo = appState.tiers[member.tier];
            const today = new Date();
            const joinedDate = new Date(member.joined);
            const weeksJoined = Math.floor((today - joinedDate) / (7 * 24 * 60 * 60 * 1000));
            
            // Total expected subscriptions
            const totalExpectedSubscriptions = weeksJoined * tierInfo.weeklySubscription;
            
            // Calculate actual payments from balance
            const totalPaid = member.balance;
            
            // Outstanding subscriptions
            const outstandingSubscriptions = Math.max(0, totalExpectedSubscriptions - totalPaid);
            
            // Calculate fines (late fees)
            const isLate = member.status === 'late';
            const fines = isLate ? appState.lateFee : 0;
            
            // Loan status
            const memberLoans = appState.loans.filter(l => l.memberId === member.id);
            const activeLoans = memberLoans.filter(l => l.status === 'active');
            const loanOutstanding = activeLoans.reduce((sum, loan) => sum + (loan.outstanding || 0), 0);
            
            // Special projects (placeholder - can be expanded)
            const specialProjectsOutstanding = 0;
            
            // Total owed
            const totalOwed = outstandingSubscriptions + fines + loanOutstanding + specialProjectsOutstanding;
            
            // Total shares value
            const totalSharesValue = tierInfo.initialInvestment + member.balance;
            
            return {
                tierAmount: tierInfo.initialInvestment,
                weeklySubscription: tierInfo.weeklySubscription,
                weeksJoined,
                totalExpectedSubscriptions,
                totalPaid,
                outstandingSubscriptions,
                fines,
                loanCount: activeLoans.length,
                loanOutstanding,
                specialProjectsOutstanding,
                totalOwed,
                totalSharesValue
            };
        }
        
        function renderMembers() {
            // Safety check - don't render if not logged in
            if (!appState.currentUser) {
                console.log('renderMembers called before login');
                return;
            }
            
            const grid = document.getElementById('memberGrid');
            if (!grid) {
                console.error('Member grid element not found');
                return;
            }
            
            const isListView = currentMemberView === 'list';
            
            grid.innerHTML = appState.members.map(member => {
                const tierInfo = appState.tiers[member.tier];
                const roles = getMemberRoles(member.id);
                const roleDisplay = roles[0] === 'member' ? 'Member' : roles.map(r => r.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())).join(', ');
                const financials = calculateMemberFinancials(member);
                
                if (isListView) {
                    // LIST VIEW - Horizontal layout with all details
                    return `
                    <div class="member-card">
                        <!-- Avatar & Basic Info -->
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                            <div class="member-avatar" style="width: 60px; height: 60px; font-size: 20px;">${member.name.split(' ').map(n => n[0]).join('')}</div>
                            <div style="text-align: center; font-size: 11px; color: var(--text-muted);">MSK-${String(member.id).padStart(4, '0')}</div>
                        </div>
                        
                        <!-- Member Details Grid -->
                        <div style="flex: 1; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <!-- Basic Info -->
                            <div>
                                <h3 style="margin: 0 0 5px 0; font-size: 18px;">${member.name}</h3>
                                <div style="font-size: 12px; color: var(--gold); font-weight: 600; margin-bottom: 8px;">${roleDisplay}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">
                                    Joined: ${new Date(member.joined).toLocaleDateString('en-ZA', { year: 'numeric', month: 'short' })}
                                </div>
                            </div>
                            
                            <!-- Tier & Subscriptions -->
                            <div style="padding: 10px; background: rgba(0, 180, 216, 0.1); border-radius: 6px; border-left: 3px solid var(--accent);">
                                <div style="font-size: 11px; color: var(--accent); font-weight: 600; margin-bottom: 5px;">TIER ${member.tier} - ${member.shares} SHARE${member.shares > 1 ? 'S' : ''}</div>
                                <div style="font-size: 13px; font-weight: 600;">Initial: R ${financials.tierAmount.toLocaleString()}</div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-top: 3px;">Weekly: R ${financials.weeklySubscription}</div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-top: 3px;">${financials.weeksJoined} weeks paid</div>
                            </div>
                            
                            <!-- Financials -->
                            <div style="padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 6px;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 5px;">BALANCE</div>
                                <div style="font-size: 16px; font-weight: 600; color: var(--success);">R ${member.balance.toLocaleString()}</div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-top: 5px;">Total Value: R ${financials.totalSharesValue.toLocaleString()}</div>
                            </div>
                            
                            <!-- Loans -->
                            <div style="padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 6px;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 5px;">LOANS</div>
                                ${financials.loanCount > 0 ? `
                                    <div style="font-size: 14px; font-weight: 600; color: var(--gold);">${financials.loanCount} Active</div>
                                    <div style="font-size: 12px; color: var(--danger); margin-top: 3px;">Owing: R ${financials.loanOutstanding.toLocaleString()}</div>
                                ` : `
                                    <div style="font-size: 13px; color: var(--success);">✓ No Loans</div>
                                `}
                            </div>
                            
                            <!-- Status & Outstanding -->
                            <div style="padding: 10px; background: ${member.status === 'late' ? 'rgba(255, 71, 87, 0.1)' : 'rgba(0, 122, 77, 0.1)'}; border-radius: 6px; border-left: 3px solid ${member.status === 'late' ? 'var(--danger)' : 'var(--success)'};">
                                <div style="font-size: 11px; color: ${member.status === 'late' ? 'var(--danger)' : 'var(--success)'}; font-weight: 600; margin-bottom: 5px;">
                                    ${member.status === 'late' ? '⚠️ PAYMENT OVERDUE' : '✓ CURRENT'}
                                </div>
                                ${financials.outstandingSubscriptions > 0 ? `
                                    <div style="font-size: 12px; color: var(--danger);">Outstanding: R ${financials.outstandingSubscriptions.toLocaleString()}</div>
                                ` : ''}
                                ${financials.fines > 0 ? `
                                    <div style="font-size: 12px; color: var(--danger); margin-top: 3px;">Late Fee: R ${financials.fines}</div>
                                ` : ''}
                                ${financials.totalOwed > 0 ? `
                                    <div style="font-size: 13px; font-weight: 600; color: var(--danger); margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(255, 71, 87, 0.3);">
                                        Total Owed: R ${financials.totalOwed.toLocaleString()}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div style="display: flex; flex-direction: column; gap: 8px; min-width: 120px;">
                            <button onclick="viewMemberProfile(${member.id})" class="btn btn-primary" style="font-size: 12px; padding: 8px 12px;">
                                <span>👁️ View Full</span>
                            </button>
                            <button onclick="contactMember(${JSON.stringify(member).replace(/"/g, '&quot;')})" class="btn btn-secondary" style="font-size: 12px; padding: 8px 12px; background: #25D366;">
                                <span>💬 Chat</span>
                            </button>
                            ${member.status === 'late' ? `
                            <button onclick="sendPaymentReminder(${JSON.stringify(member).replace(/"/g, '&quot;')})" class="btn btn-primary" style="font-size: 12px; padding: 8px 12px; background: var(--gold);">
                                <span>🔔 Remind</span>
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                } else {
                    // TILE VIEW - Compact cards
                    return `
                    <div class="member-card">
                        <div class="member-header">
                            <div class="member-avatar">${member.name.split(' ').map(n => n[0]).join('')}</div>
                            <div class="member-info">
                                <h3>${member.name}</h3>
                                <div class="member-role">${roleDisplay}</div>
                            </div>
                        </div>
                        
                        <div style="margin: 15px 0; padding: 12px; background: rgba(0, 180, 216, 0.1); border-radius: 8px; border-left: 3px solid ${member.status === 'late' ? 'var(--danger)' : 'var(--accent)'};">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">TIER ${member.tier} - ${member.shares} SHARE${member.shares > 1 ? 'S' : ''}</div>
                            <div style="font-size: 14px; font-weight: 600;">R ${financials.weeklySubscription}/week</div>
                            <div style="font-size: 11px; color: ${member.status === 'late' ? 'var(--danger)' : 'var(--success)'}; margin-top: 5px;">
                                ${member.status === 'late' ? '⚠️ PAYMENT OVERDUE' : '✓ Payment Current'}
                            </div>
                        </div>
                        
                        <div class="member-stats">
                            <div class="member-stat">
                                <div class="member-stat-label">Balance</div>
                                <div class="member-stat-value">R ${member.balance.toLocaleString()}</div>
                            </div>
                            <div class="member-stat">
                                <div class="member-stat-label">Loans</div>
                                <div class="member-stat-value" style="color: ${financials.loanCount > 0 ? 'var(--gold)' : 'var(--success)'};">
                                    ${financials.loanCount > 0 ? financials.loanCount + ' Active' : '✓ None'}
                                </div>
                            </div>
                        </div>
                        
                        ${financials.totalOwed > 0 ? `
                        <div style="margin: 10px 0; padding: 10px; background: rgba(255, 71, 87, 0.1); border-radius: 6px; border-left: 3px solid var(--danger);">
                            <div style="font-size: 11px; color: var(--danger); font-weight: 600;">TOTAL OWED</div>
                            <div style="font-size: 16px; font-weight: 600; color: var(--danger);">R ${financials.totalOwed.toLocaleString()}</div>
                            <div style="font-size: 10px; color: var(--text-muted); margin-top: 3px;">
                                ${financials.outstandingSubscriptions > 0 ? `Subs: R${financials.outstandingSubscriptions} ` : ''}
                                ${financials.fines > 0 ? `Fines: R${financials.fines} ` : ''}
                                ${financials.loanOutstanding > 0 ? `Loans: R${financials.loanOutstanding}` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="display: flex; gap: 8px; margin-top: 12px;">
                            <button onclick="viewMemberProfile(${member.id})" class="btn btn-primary" style="flex: 1; font-size: 12px; padding: 8px;">
                                <span>👁️ View</span>
                            </button>
                            <button onclick="contactMember(${JSON.stringify(member).replace(/"/g, '&quot;')})" class="btn btn-secondary" style="flex: 1; font-size: 12px; padding: 8px; background: #25D366;">
                                <span>💬</span>
                            </button>
                            ${member.status === 'late' ? `
                            <button onclick="sendPaymentReminder(${JSON.stringify(member).replace(/"/g, '&quot;')})" class="btn btn-primary" style="flex: 1; font-size: 12px; padding: 8px; background: var(--gold);">
                                <span>🔔</span>
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                }
            }).join('');
            
            // Show/hide Add Member button based on permissions
            const addMemberBtn = document.getElementById('addMemberBtn');
            if (addMemberBtn && appState.currentUser && hasPermission(appState.currentUser.id, 'approve_members')) {
                addMemberBtn.style.display = 'block';
            }
        }
        
        function viewMemberProfile(memberId) {
            const member = appState.members.find(m => m.id === memberId);
            if (!member) return;
            
            const financials = calculateMemberFinancials(member);
            const roles = getMemberRoles(member.id);
            const roleDisplay = roles[0] === 'member' ? 'Member' : roles.map(r => r.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())).join(', ');
            
            const modalContent = `
                <h2 style="color: var(--accent); margin-bottom: 20px; text-align: center;">📋 Member Profile</h2>
                
                <div style="text-align: center; margin-bottom: 30px;">
                    <div class="member-avatar" style="width: 100px; height: 100px; font-size: 36px; margin: 0 auto 15px;">
                        ${member.name.split(' ').map(n => n[0]).join('')}
                    </div>
                    <h3 style="margin: 0 0 5px 0;">${member.name}</h3>
                    <div style="color: var(--gold); font-weight: 600; margin-bottom: 5px;">${roleDisplay}</div>
                    <div style="font-size: 13px; color: var(--text-muted);">MSK-${String(member.id).padStart(4, '0')}</div>
                </div>
                
                <div style="display: grid; gap: 20px;">
                    <!-- Membership Info -->
                    <div class="card" style="background: rgba(0, 180, 216, 0.1);">
                        <h4 style="color: var(--accent); margin-bottom: 15px;">💎 Membership Details</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted);">TIER</div>
                                <div style="font-size: 18px; font-weight: 600;">Tier ${member.tier} - ${member.shares} Shares</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted);">JOINED</div>
                                <div style="font-size: 14px; font-weight: 600;">${new Date(member.joined).toLocaleDateString('en-ZA')}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted);">INITIAL INVESTMENT</div>
                                <div style="font-size: 18px; font-weight: 600; color: var(--success);">R ${financials.tierAmount.toLocaleString()}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted);">WEEKLY SUBSCRIPTION</div>
                                <div style="font-size: 18px; font-weight: 600;">R ${financials.weeklySubscription}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Financial Summary -->
                    <div class="card">
                        <h4 style="color: var(--gold); margin-bottom: 15px;">💰 Financial Summary</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="padding: 12px; background: rgba(0, 122, 77, 0.1); border-radius: 6px;">
                                <div style="font-size: 11px; color: var(--success);">CURRENT BALANCE</div>
                                <div style="font-size: 20px; font-weight: 600; color: var(--success);">R ${member.balance.toLocaleString()}</div>
                            </div>
                            <div style="padding: 12px; background: rgba(0, 180, 216, 0.1); border-radius: 6px;">
                                <div style="font-size: 11px; color: var(--accent);">TOTAL SHARES VALUE</div>
                                <div style="font-size: 20px; font-weight: 600; color: var(--accent);">R ${financials.totalSharesValue.toLocaleString()}</div>
                            </div>
                            <div style="padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 6px;">
                                <div style="font-size: 11px; color: var(--text-muted);">WEEKS CONTRIBUTED</div>
                                <div style="font-size: 20px; font-weight: 600;">${financials.weeksJoined}</div>
                            </div>
                            <div style="padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 6px;">
                                <div style="font-size: 11px; color: var(--text-muted);">TOTAL PAID</div>
                                <div style="font-size: 20px; font-weight: 600;">R ${financials.totalPaid.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loan Status -->
                    <div class="card">
                        <h4 style="color: ${financials.loanCount > 0 ? 'var(--gold)' : 'var(--success)'}; margin-bottom: 15px;">
                            🏦 Loan Status
                        </h4>
                        ${financials.loanCount > 0 ? `
                            <div style="padding: 12px; background: rgba(230, 126, 34, 0.1); border-radius: 6px; border-left: 3px solid var(--gold);">
                                <div style="font-size: 14px; font-weight: 600; color: var(--gold); margin-bottom: 8px;">
                                    ${financials.loanCount} Active Loan${financials.loanCount > 1 ? 's' : ''}
                                </div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">OUTSTANDING BALANCE</div>
                                <div style="font-size: 24px; font-weight: 600; color: var(--danger);">R ${financials.loanOutstanding.toLocaleString()}</div>
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 30px; color: var(--success);">
                                <span style="font-size: 48px;">✅</span>
                                <p style="margin-top: 10px; font-weight: 600;">No Active Loans</p>
                            </div>
                        `}
                    </div>
                    
                    <!-- Outstanding Amounts -->
                    ${financials.totalOwed > 0 ? `
                    <div class="card" style="background: rgba(255, 71, 87, 0.1); border: 2px solid var(--danger);">
                        <h4 style="color: var(--danger); margin-bottom: 15px;">⚠️ Outstanding Amounts</h4>
                        <div style="display: grid; gap: 10px;">
                            ${financials.outstandingSubscriptions > 0 ? `
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 6px;">
                                <span style="font-weight: 600;">Subscription Arrears:</span>
                                <span style="color: var(--danger); font-weight: 600;">R ${financials.outstandingSubscriptions.toLocaleString()}</span>
                            </div>
                            ` : ''}
                            ${financials.fines > 0 ? `
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 6px;">
                                <span style="font-weight: 600;">Late Fees:</span>
                                <span style="color: var(--danger); font-weight: 600;">R ${financials.fines}</span>
                            </div>
                            ` : ''}
                            ${financials.loanOutstanding > 0 ? `
                            <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 6px;">
                                <span style="font-weight: 600;">Loan Balance:</span>
                                <span style="color: var(--danger); font-weight: 600;">R ${financials.loanOutstanding.toLocaleString()}</span>
                            </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; padding: 15px; background: var(--danger); border-radius: 6px; margin-top: 10px;">
                                <span style="font-weight: 700; font-size: 16px;">TOTAL OWED:</span>
                                <span style="font-weight: 700; font-size: 20px;">R ${financials.totalOwed.toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                    ` : `
                    <div class="card" style="background: rgba(0, 122, 77, 0.1); border: 2px solid var(--success);">
                        <div style="text-align: center; padding: 30px;">
                            <span style="font-size: 48px;">✅</span>
                            <h4 style="color: var(--success); margin-top: 15px;">All Payments Current</h4>
                            <p style="color: var(--text-muted); margin-top: 5px;">No outstanding amounts</p>
                        </div>
                    </div>
                    `}
                    
                    <!-- Contact -->
                    <div style="display: flex; gap: 10px;">
                        <button onclick="contactMember(${JSON.stringify(member).replace(/"/g, '&quot;')}); closeModal('memberProfileModal');" class="btn btn-primary" style="flex: 1; background: #25D366;">
                            <span>💬 Send WhatsApp Message</span>
                        </button>
                        ${member.status === 'late' ? `
                        <button onclick="sendPaymentReminder(${JSON.stringify(member).replace(/"/g, '&quot;')}); closeModal('memberProfileModal');" class="btn btn-primary" style="flex: 1; background: var(--gold);">
                            <span>🔔 Send Payment Reminder</span>
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // Create and show modal
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'memberProfileModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <div class="modal-title">Member Profile</div>
                        <button class="close-modal" onclick="closeModal('memberProfileModal')">×</button>
                    </div>
                    <div>${modalContent}</div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        
        // Render Contributions
        function renderContributions() {
            // Safety check - don't render if not logged in
            if (!appState.currentUser) {
                return;
            }
            
            const table = document.getElementById('contributionsTable');
            if (!table) {
                return;
            }
            
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday
            const daysUntilMonday = dayOfWeek === 0 ? 1 : dayOfWeek === 1 ? 0 : 8 - dayOfWeek;
            const nextMonday = new Date(today);
            nextMonday.setDate(today.getDate() + daysUntilMonday);
            
            const contributions = appState.members.map(member => {
                const tierInfo = appState.tiers[member.tier];
                const isLate = member.status === 'late';
                const amountDue = tierInfo.weeklySubscription + (isLate ? appState.lateFee : 0);
                
                return {
                    member: member.name,
                    memberId: member.id,
                    memberData: member,
                    tier: member.tier,
                    shares: member.shares,
                    dueDate: nextMonday.toISOString().split('T')[0],
                    baseAmount: tierInfo.weeklySubscription,
                    lateFee: isLate ? appState.lateFee : 0,
                    totalAmount: amountDue,
                    status: isLate ? 'overdue' : (member.lastPayment === '2026-01-13' ? 'paid' : 'pending'),
                    lastPayment: member.lastPayment
                };
            });
            
            table.innerHTML = contributions.map(contrib => `
                <tr style="${contrib.status === 'overdue' ? 'background: rgba(255, 71, 87, 0.1);' : ''}">
                    <td>
                        <strong>${contrib.member}</strong><br>
                        <span style="font-size: 11px; color: var(--text-muted);">Tier ${contrib.tier} - ${contrib.shares} Share${contrib.shares > 1 ? 's' : ''}</span>
                    </td>
                    <td>${contrib.dueDate}<br><span style="font-size: 11px; color: var(--text-muted);">Every Monday</span></td>
                    <td>
                        <strong>R ${contrib.baseAmount}</strong>
                        ${contrib.lateFee > 0 ? `<br><span style="color: var(--danger); font-size: 12px;">+ R ${contrib.lateFee} late fee</span>` : ''}
                        ${contrib.lateFee > 0 ? `<br><strong style="color: var(--danger);">R ${contrib.totalAmount} total</strong>` : ''}
                    </td>
                    <td>
                        <span style="color: ${contrib.status === 'paid' ? 'var(--success)' : contrib.status === 'overdue' ? 'var(--danger)' : 'var(--gold)'}; font-weight: 600;">
                            ${contrib.status === 'paid' ? '✓ Paid' : contrib.status === 'overdue' ? '⚠️ OVERDUE' : '⏳ Pending'}
                        </span>
                        ${contrib.status === 'paid' ? `<br><span style="font-size: 11px; color: var(--text-muted);">Last: ${contrib.lastPayment}</span>` : ''}
                    </td>
                    <td style="white-space: nowrap;">
                        ${contrib.status !== 'paid' ? 
                            `<button class="btn btn-primary" style="padding: 8px 16px; background: #25D366;" onclick='sendPaymentReminder(${JSON.stringify(contrib.memberData).replace(/'/g, "\\'")})'>
                                <span>💬 Remind</span>
                            </button>` : 
                            '<button class="btn btn-secondary" style="padding: 8px 16px;"><span>✓ Paid</span></button>'}
                    </td>
                </tr>
            `).join('');
            
            // Show pending payments section if user is Treasurer or Admin
            if (appState.currentUser && (appState.currentUser.role === 'treasurer' || appState.currentUser.role === 'admin')) {
                renderPendingPayments();
            }
        }
        
        function renderPendingPayments() {
            if (!appState.pendingPayments) {
                appState.pendingPayments = [];
            }
            
            const section = document.getElementById('pendingPaymentsSection');
            const countDiv = document.getElementById('pendingPaymentsCount');
            const listDiv = document.getElementById('pendingPaymentsList');
            
            const pending = appState.pendingPayments.filter(p => p.status === 'pending');
            
            if (pending.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            countDiv.textContent = `${pending.length} payment submission${pending.length !== 1 ? 's' : ''} awaiting your verification.`;
            
            listDiv.innerHTML = pending.map((payment, index) => `
                <div style="background: rgba(10, 26, 42, 0.6); border: 2px solid var(--gold); border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4 style="color: var(--accent); margin-bottom: 10px;">${payment.memberName}</h4>
                            <div style="font-size: 14px; line-height: 1.8;">
                                <strong>Amount:</strong> R ${payment.amount}<br>
                                <strong>Method:</strong> ${payment.method.toUpperCase()}<br>
                                <strong>Reference:</strong> ${payment.reference}<br>
                                <strong>Payment Date:</strong> ${payment.date}<br>
                                <strong>Submitted:</strong> ${new Date(payment.submittedDate).toLocaleString()}<br>
                                ${payment.notes ? `<strong>Notes:</strong> ${payment.notes}<br>` : ''}
                            </div>
                        </div>
                        <div>
                            <strong style="color: var(--text-muted); font-size: 12px;">PROOF OF PAYMENT</strong>
                            <div style="margin-top: 10px; border: 2px solid var(--border); border-radius: 8px; overflow: hidden;">
                                ${payment.proof.fileType === 'application/pdf' ? 
                                    `<div style="padding: 40px; text-align: center; background: rgba(0,0,0,0.3);">
                                        <div style="font-size: 48px;">📄</div>
                                        <div style="margin-top: 10px; font-size: 13px;">${payment.proof.fileName}</div>
                                        <button class="btn btn-secondary" style="margin-top: 10px; padding: 8px 16px;" onclick="viewProofFullScreen(${index})"><span>View PDF</span></button>
                                    </div>` :
                                    `<img src="${payment.proof.dataUrl}" style="width: 100%; max-height: 300px; object-fit: contain; background: rgba(0,0,0,0.3); cursor: pointer;" onclick="viewProofFullScreen(${index})">`
                                }
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                        <button class="btn btn-primary" style="flex: 1;" onclick="approvePayment(${index})"><span>✓ Confirm Payment</span></button>
                        <button class="btn btn-danger" style="flex: 1;" onclick="rejectPayment(${index})"><span>✗ Reject</span></button>
                    </div>
                </div>
            `).join('');
        }
        
        function viewProofFullScreen(index) {
            const payment = appState.pendingPayments.filter(p => p.status === 'pending')[index];
            if (payment && payment.proof) {
                window.open(payment.proof.dataUrl, '_blank');
            }
        }
        
        function approvePayment(index) {
            const pending = appState.pendingPayments.filter(p => p.status === 'pending');
            const payment = pending[index];
            
            if (confirm(`Confirm payment of R ${payment.amount} from ${payment.memberName}?`)) {
                // Update payment status
                payment.status = 'confirmed';
                payment.confirmedBy = appState.currentUser.name;
                payment.confirmedDate = new Date().toISOString();
                
                // Update member's record
                const member = appState.members.find(m => m.id === payment.memberId);
                if (member) {
                    member.lastPayment = payment.date;
                    member.status = 'current';
                    member.balance += payment.amount;
                    
                    // Save to database
                    Promise.all([
                        saveToDB('pendingPayments', payment),
                        saveToDB('users', member),
                        saveToDB('contributions', payment)
                    ]).then(() => {
                        // Update app state
                        if (!appState.contributions) {
                            appState.contributions = [];
                        }
                        appState.contributions.push(payment);
                        
                        renderPendingPayments();
                        renderContributions();
                        showNotification(`Payment from ${payment.memberName} confirmed successfully!`, 'success');
                    }).catch(error => {
                        console.error('Error approving payment:', error);
                        alert('Failed to approve payment. Please try again.');
                    });
                }
            }
        }
        
        function rejectPayment(index) {
            const pending = appState.pendingPayments.filter(p => p.status === 'pending');
            const payment = pending[index];
            
            const reason = prompt(`Why are you rejecting this payment from ${payment.memberName}?`);
            if (reason) {
                payment.status = 'rejected';
                payment.rejectedBy = appState.currentUser.name;
                payment.rejectedDate = new Date().toISOString();
                payment.rejectionReason = reason;
                
                renderPendingPayments();
                showNotification(`Payment from ${payment.memberName} rejected. Member will be notified.`, 'success');
            }
        }
        
        // Render Loans
        function renderLoans() {
            // Safety check - don't render if not logged in
            if (!appState.currentUser) {
                return;
            }
            
            const table = document.getElementById('loansTable');
            if (!table) {
                return;
            }
            
            table.innerHTML = appState.loans.map(loan => {
                const member = appState.members.find(m => m.id === loan.memberId);
                const paymentStatus = loan.paymentStatus || 'pending-approval';
                
                // Determine status display
                let statusColor, statusText;
                if (loan.status === 'active') {
                    statusColor = 'var(--success)';
                    statusText = '✓ Active';
                } else if (loan.status === 'approved') {
                    if (paymentStatus === 'awaiting-load') {
                        statusColor = '#9B59B6';
                        statusText = '💳 Awaiting Load';
                    } else if (paymentStatus === 'loaded') {
                        statusColor = '#E74C3C';
                        statusText = '🔓 Awaiting Release';
                    } else if (paymentStatus === 'released') {
                        statusColor = 'var(--success)';
                        statusText = '✅ Released';
                    } else {
                        statusColor = 'var(--gold)';
                        statusText = '⏳ Approved';
                    }
                } else if (loan.status === 'pending') {
                    statusColor = 'var(--gold)';
                    statusText = '⏳ Pending Review';
                } else {
                    statusColor = 'var(--danger)';
                    statusText = '✗ Rejected';
                }
                
                // Determine which action buttons to show
                const hasLoadPermission = hasPermission(appState.currentUser.id, 'load_payments');
                const hasReleasePermission = hasPermission(appState.currentUser.id, 'release_payments');
                const hasApprovePermission = hasPermission(appState.currentUser.id, 'approve_loans');
                
                let actionButtons = `<button class="btn btn-secondary" style="padding: 8px 16px;" onclick="viewLoanDetails(${loan.id})"><span>View Details</span></button>`;
                
                if (loan.status === 'pending' && hasApprovePermission) {
                    actionButtons += `<button class="btn btn-primary" style="padding: 8px 16px; margin-left: 5px;" onclick="approveLoan(${loan.id})"><span>Approve</span></button>`;
                } else if (loan.status === 'approved' && paymentStatus === 'awaiting-load' && hasLoadPermission) {
                    actionButtons += `<button class="btn btn-primary" style="padding: 8px 16px; margin-left: 5px; background: #9B59B6;" onclick="loadPayment(${loan.id})"><span>💳 Mark Loaded</span></button>`;
                } else if (loan.status === 'approved' && paymentStatus === 'loaded' && hasReleasePermission) {
                    actionButtons += `<button class="btn btn-primary" style="padding: 8px 16px; margin-left: 5px; background: #E74C3C;" onclick="releasePayment(${loan.id})"><span>🔓 Release Funds</span></button>`;
                }
                
                return `
                    <tr>
                        <td>
                            <strong>${member.name}</strong><br>
                            <span style="font-size: 11px; color: var(--text-muted);">MSK-${String(member.id).padStart(4, '0')}</span>
                        </td>
                        <td>R ${loan.amount.toLocaleString()}</td>
                        <td>${loan.term} weeks</td>
                        <td>${loan.interest}%</td>
                        <td><span style="color: ${statusColor}; font-weight: 600;">${statusText}</span></td>
                        <td>${loan.nextPayment || 'N/A'}</td>
                        <td style="white-space: nowrap;">
                            ${actionButtons}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function viewLoanDetails(loanId) {
            const loan = appState.loans.find(l => l.id === loanId);
            if (!loan) return;
            
            const member = appState.members.find(m => m.id === loan.memberId);
            const details = loan.applicationDetails || {};
            
            let detailsHTML = `
                <div style="text-align: left; line-height: 1.8;">
                    <h3 style="color: var(--gold); margin-bottom: 20px; text-align: center;">📋 Loan Application Details</h3>
                    
                    <div style="background: rgba(0, 180, 216, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--accent);">
                        <strong style="color: var(--accent);">Applicant Information</strong><br>
                        <strong>Name:</strong> ${member.name}<br>
                        <strong>Registration No:</strong> MSK-${String(member.id).padStart(4, '0')}<br>
                    </div>
                    
                    <div style="background: rgba(230, 126, 34, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--gold);">
                        <strong style="color: var(--gold);">Loan Details</strong><br>
                        <strong>Amount:</strong> R ${loan.amount.toLocaleString()}<br>
                        <strong>Duration:</strong> ${loan.term} weeks<br>
                        <strong>Interest Rate:</strong> ${loan.interest}%<br>
                        <strong>Total P&I:</strong> R ${loan.outstanding.toLocaleString()}<br>
                        <strong>Status:</strong> <span style="color: ${loan.status === 'pending' ? 'var(--gold)' : loan.status === 'approved' ? 'var(--success)' : 'var(--accent)'};">${loan.status.charAt(0).toUpperCase() + loan.status.slice(1)}</span><br>
                        <strong>Application Date:</strong> ${loan.applicationDate || 'N/A'}
                    </div>
            `;
            
            // Display Banking Details (new)
            if (loan.bankingDetails) {
                const banking = loan.bankingDetails;
                detailsHTML += `
                    <div style="background: rgba(0, 180, 216, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--accent);">
                        <strong style="color: var(--accent); font-size: 16px;">🏦 Banking Details for Disbursement</strong><br><br>
                        <div style="display: grid; gap: 10px;">
                            <div style="padding: 8px; background: rgba(0,0,0,0.2); border-radius: 5px;">
                                <strong>Bank:</strong> ${banking.bankName || 'N/A'}
                            </div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.2); border-radius: 5px;">
                                <strong>Branch Code:</strong> ${banking.branchCode || 'N/A'}
                            </div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.2); border-radius: 5px;">
                                <strong>Account Holder:</strong> ${banking.accountName || 'N/A'}
                            </div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.2); border-radius: 5px;">
                                <strong>Account Number:</strong> ${banking.accountNumber ? banking.accountNumber.replace(/\d(?=\d{4})/g, '*') : 'N/A'}
                            </div>
                            <div style="padding: 8px; background: rgba(0,0,0,0.2); border-radius: 5px;">
                                <strong>Account Type:</strong> ${banking.accountType || 'N/A'}
                            </div>
                            ${banking.reference ? `
                            <div style="padding: 8px; background: rgba(0,0,0,0.2); border-radius: 5px;">
                                <strong>Reference:</strong> ${banking.reference}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Legacy support for old loans with purpose field
            if (details.purpose) {
                detailsHTML += `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong>Purpose:</strong><br>
                        <div style="margin-top: 8px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px;">${details.purpose}</div>
                    </div>
                `;
            }
            
            if (details.residentialAddress) {
                detailsHTML += `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong>Residential Address:</strong><br>
                        ${details.residentialAddress}${details.resSuburb ? ', ' + details.resSuburb : ''}
                    </div>
                `;
            }
            
            if (details.collateralType) {
                detailsHTML += `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong>Collateral:</strong> ${details.collateralType}<br>
                        <strong>Estimated Value:</strong> R ${(details.collateralValue || 0).toLocaleString()}
                    </div>
                `;
            }
            
            // Display all guarantors
            let guarantorHTML = '';
            let guarantorCount = 0;
            
            for (let i = 1; i <= 5; i++) {
                if (details[`guarantor${i}`]) {
                    if (details[`guarantor${i}`] === 'SELF') {
                        // Self-guarantee display
                        guarantorHTML += `<div style="padding: 8px; background: rgba(0, 180, 216, 0.1); border-radius: 5px; margin-bottom: 5px; border-left: 3px solid var(--accent);"><strong>Guarantor ${i}:</strong> 🔒 SELF GUARANTEE</div>`;
                        guarantorCount++;
                    } else {
                        // Member guarantor display
                        const g = appState.members.find(m => m.id === parseInt(details[`guarantor${i}`]));
                        if (g) {
                            guarantorHTML += `<div style="padding: 8px; background: rgba(0, 122, 77, 0.1); border-radius: 5px; margin-bottom: 5px; border-left: 3px solid var(--success);"><strong>Guarantor ${i}:</strong> ${g.name}</div>`;
                            guarantorCount++;
                        }
                    }
                }
            }
            
            if (guarantorCount > 0) {
                detailsHTML += `
                    <div style="background: rgba(0, 122, 77, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--success);">
                        <strong style="color: var(--success);">Guarantors (${guarantorCount}/5)</strong><br><br>
                        ${guarantorHTML}
                    </div>
                `;
            }
            
            detailsHTML += '</div>';
            
            // Create custom modal
            showCustomModal('Loan Details', detailsHTML);
        }
        
        // Custom modal function for displaying HTML content
        function showCustomModal(title, content) {
            // Remove existing modal if any
            const existingModal = document.getElementById('customModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'customModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
                animation: fadeIn 0.3s ease;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: var(--secondary);
                border-radius: 20px;
                padding: 30px;
                max-width: 600px;
                width: 100%;
                max-height: 90vh;
                overflow-y: auto;
                border: 1px solid var(--border);
                box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                animation: slideUp 0.4s ease-out;
            `;
            
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: var(--text);">${title}</h2>
                    <button onclick="document.getElementById('customModal').remove()" style="
                        background: var(--danger);
                        color: white;
                        border: none;
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 20px;
                        font-weight: bold;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">×</button>
                </div>
                <div style="color: var(--text);">
                    ${content}
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="document.getElementById('customModal').remove()" style="
                        padding: 12px 30px;
                        background: var(--accent);
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 16px;
                        font-weight: 600;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='var(--accent-dark)'" onmouseout="this.style.background='var(--accent)'">Close</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        function approveLoan(loanId) {
            if (confirm('Approve this loan application? This will notify the Payment Loader to process the disbursement.')) {
                const loan = appState.loans.find(l => l.id === loanId);
                if (loan) {
                    loan.status = 'approved';
                    loan.approvedDate = new Date().toISOString();
                    loan.paymentStatus = 'awaiting-load'; // New status tracking
                    
                    // Notify Payment Loader via WhatsApp
                    const paymentLoader = appState.electedPositions.paymentLoader;
                    if (paymentLoader && paymentLoader.memberId) {
                        const applicantName = appState.members.find(m => m.id === loan.memberId)?.name;
                        const banking = loan.bankingDetails;
                        addNotification({
                            type: 'payment-load-required',
                            title: '💳 Load Payment Required',
                            message: `Loan approved for ${applicantName}. Amount: R ${loan.amount.toLocaleString()}. Bank: ${banking?.bankName || 'N/A'}. Account: ${banking?.accountNumber?.slice(-4) || 'N/A'}. Please load payment in bank system.`,
                            loanId: loanId
                        }, paymentLoader.memberId);
                    } else {
                        showNotification('⚠️ Warning: No Payment Loader assigned. Please assign one in Leadership section.', 'error');
                    }
                    
                    renderLoans();
                    showNotification('Loan approved! Payment Loader has been notified via WhatsApp.', 'success');
                }
            }
        }
        
        function loadPayment(loanId) {
            if (confirm('Confirm that you have loaded this payment in the bank system?')) {
                const loan = appState.loans.find(l => l.id === loanId);
                if (loan) {
                    loan.paymentStatus = 'loaded';
                    loan.loadedDate = new Date().toISOString();
                    loan.loadedBy = appState.currentUser.id;
                    
                    // Notify Payment Releaser via WhatsApp
                    const paymentReleaser = appState.electedPositions.paymentReleaser;
                    if (paymentReleaser && paymentReleaser.memberId) {
                        const applicantName = appState.members.find(m => m.id === loan.memberId)?.name;
                        addNotification({
                            type: 'payment-release-required',
                            title: '🔓 Release Payment',
                            message: `Payment loaded by ${appState.currentUser.name} for ${applicantName}. Amount: R ${loan.amount.toLocaleString()}. Please release funds to applicant's bank account.`,
                            loanId: loanId
                        }, paymentReleaser.memberId);
                    } else {
                        showNotification('⚠️ Warning: No Payment Releaser assigned. Please assign one in Leadership section.', 'error');
                    }
                    
                    renderLoans();
                    showNotification('Payment marked as loaded! Payment Releaser has been notified.', 'success');
                }
            }
        }
        
        function releasePayment(loanId) {
            if (confirm('Confirm that you have released these funds to the loan applicant?')) {
                const loan = appState.loans.find(l => l.id === loanId);
                if (loan) {
                    loan.paymentStatus = 'released';
                    loan.status = 'active';
                    loan.releasedDate = new Date().toISOString();
                    loan.releasedBy = appState.currentUser.id;
                    
                    // Notify Loan Applicant via WhatsApp
                    const banking = loan.bankingDetails;
                    addNotification({
                        type: 'funds-available',
                        title: '✅ Loan Funds Available',
                        message: `Your loan of R ${loan.amount.toLocaleString()} has been released by ${appState.currentUser.name}. Funds are now available in your ${banking?.bankName || 'bank'} account ending in ${banking?.accountNumber?.slice(-4) || '****'}. Thank you for being part of Masonko Stokvel!`
                    }, loan.memberId);
                    
                    renderLoans();
                    showNotification('Payment released! Applicant has been notified via WhatsApp.', 'success');
                }
            }
        }
        
        // Render Chat
        function renderChat() {
            const container = document.getElementById('chatMessages');
            container.innerHTML = appState.chatMessages.map(msg => `
                <div class="chat-message ${msg.isSent ? 'sent' : 'received'}">
                    ${!msg.isSent ? `<div class="message-author">${msg.sender}</div>` : ''}
                    <div>${msg.message}</div>
                    <div class="message-time">${msg.time}</div>
                </div>
            `).join('');
            container.scrollTop = container.scrollHeight;
        }
        
        // Render Notifications
        // ============================================
        // GUARANTOR REQUEST FUNCTIONS
        // ============================================
        
        function renderGuarantorRequests() {
            if (!appState.currentUser) return;
            
            const container = document.getElementById('guarantorRequestsList');
            if (!container) return;
            
            // Filter requests for current user
            const myRequests = appState.guarantorRequests.filter(
                r => r.guarantorId === appState.currentUser.id && r.status === 'pending'
            );
            
            if (myRequests.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <span style="font-size: 48px;">✅</span>
                        <p style="margin-top: 10px;">No pending guarantor requests</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = myRequests.map(request => {
                const loan = appState.loans.find(l => l.id === request.loanId);
                const tierInfo = appState.tiers[appState.currentUser.tier];
                const myAvailableAmount = tierInfo.initialInvestment + appState.currentUser.balance;
                
                return `
                    <div class="card" style="margin-bottom: 15px; border-left: 4px solid var(--gold);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                            <div>
                                <h4 style="color: var(--accent); margin-bottom: 5px;">${request.applicantName}</h4>
                                <p style="font-size: 13px; color: var(--text-muted); margin: 0;">
                                    Requests you as Guarantor #${request.guarantorPosition}
                                </p>
                            </div>
                            <span style="padding: 6px 12px; background: rgba(230, 126, 34, 0.2); color: var(--gold); border-radius: 20px; font-size: 12px; font-weight: 600;">
                                PENDING
                            </span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px; padding: 15px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 3px;">LOAN AMOUNT</div>
                                <div style="font-size: 18px; font-weight: 600; color: var(--accent);">R ${request.loanAmount.toLocaleString()}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 3px;">LOAN TERM</div>
                                <div style="font-size: 18px; font-weight: 600;">${request.loanTerm} weeks</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 3px;">REQUESTED FROM YOU</div>
                                <div style="font-size: 18px; font-weight: 600; color: var(--gold);">R ${request.requestedAmount.toLocaleString()}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 3px;">YOUR AVAILABLE</div>
                                <div style="font-size: 18px; font-weight: 600; color: ${myAvailableAmount >= request.requestedAmount ? 'var(--success)' : 'var(--danger)'};">
                                    R ${myAvailableAmount.toLocaleString()}
                                </div>
                            </div>
                        </div>
                        
                        <div style="padding: 12px; background: rgba(0, 180, 216, 0.1); border-radius: 6px; margin-bottom: 15px; font-size: 13px;">
                            <strong>📋 What this means:</strong><br>
                            If you approve, R ${request.requestedAmount.toLocaleString()} of your shares/savings will be held as collateral for this loan. 
                            If the borrower defaults, this amount may be used to cover the outstanding balance.
                        </div>
                        
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="openGuarantorResponse(${request.id})" style="background: var(--success);">
                                <span>✅ Respond to Request</span>
                            </button>
                            <button class="btn btn-secondary" onclick="viewLoanDetails(${request.loanId})">
                                <span>👁️ View Full Loan Details</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function openGuarantorResponse(requestId) {
            const request = appState.guarantorRequests.find(r => r.id === requestId);
            if (!request) return;
            
            const tierInfo = appState.tiers[appState.currentUser.tier];
            const myAvailableAmount = tierInfo.initialInvestment + appState.currentUser.balance;
            
            document.getElementById('responseRequestId').value = requestId;
            document.getElementById('originalRequestedAmount').textContent = `R ${request.requestedAmount.toLocaleString()}`;
            document.getElementById('guarantorAvailableAmount').textContent = `R ${myAvailableAmount.toLocaleString()}`;
            document.getElementById('guarantorApprovedAmount').value = request.requestedAmount;
            document.getElementById('guarantorApprovedAmount').max = myAvailableAmount;
            
            document.getElementById('guarantorRequestDetails').innerHTML = `
                <strong>Applicant:</strong> ${request.applicantName}<br>
                <strong>Loan Amount:</strong> R ${request.loanAmount.toLocaleString()}<br>
                <strong>Loan Term:</strong> ${request.loanTerm} weeks<br>
                <strong>Requested from you:</strong> R ${request.requestedAmount.toLocaleString()}<br>
                <strong>Your Position:</strong> Guarantor #${request.guarantorPosition}<br>
                <strong>Request Date:</strong> ${new Date(request.requestDate).toLocaleDateString()}
            `;
            
            openModal('guarantorResponseModal');
        }
        
        function toggleAmountEdit() {
            const action = document.getElementById('guarantorResponseAction').value;
            const amountGroup = document.getElementById('editedAmountGroup');
            const amountInput = document.getElementById('guarantorApprovedAmount');
            
            if (action === 'approved-edited') {
                amountGroup.style.display = 'block';
                amountInput.required = true;
            } else {
                amountGroup.style.display = 'none';
                amountInput.required = false;
            }
        }
        
        function submitGuarantorResponse(e) {
            e.preventDefault();
            
            const requestId = parseInt(document.getElementById('responseRequestId').value);
            const action = document.getElementById('guarantorResponseAction').value;
            const comments = document.getElementById('guarantorComments').value;
            
            const request = appState.guarantorRequests.find(r => r.id === requestId);
            if (!request) return;
            
            // Update request based on response
            if (action === 'approved') {
                request.status = 'approved';
                request.approvedAmount = request.requestedAmount;
            } else if (action === 'approved-edited') {
                const editedAmount = parseFloat(document.getElementById('guarantorApprovedAmount').value);
                request.status = 'approved';
                request.approvedAmount = editedAmount;
            } else if (action === 'rejected') {
                request.status = 'rejected';
                request.approvedAmount = 0;
            }
            
            request.responseDate = new Date().toISOString();
            request.comments = comments;
            
            // Send notification to applicant via WhatsApp
            addNotification({
                type: 'guarantor-response',
                title: request.status === 'approved' ? '✅ Guarantor Approved' : '❌ Guarantor Declined',
                message: `${appState.currentUser.name} ${request.status === 'approved' ? 'approved' : 'declined'} your guarantor request${request.status === 'approved' && request.approvedAmount !== request.requestedAmount ? ` (R ${request.approvedAmount.toLocaleString()} instead of R ${request.requestedAmount.toLocaleString()})` : ''}`
            }, request.applicantId);
            
            // Check if all guarantors have responded
            checkLoanGuarantorStatus(request.loanId);
            
            showNotification(
                action === 'rejected' 
                    ? '❌ Guarantor request declined' 
                    : `✅ Guarantor request approved${request.approvedAmount !== request.requestedAmount ? ' with modified amount' : ''}!`,
                action === 'rejected' ? 'error' : 'success'
            );
            
            closeModal('guarantorResponseModal');
            e.target.reset();
            renderGuarantorRequests();
        }
        
        function checkLoanGuarantorStatus(loanId) {
            const loanRequests = appState.guarantorRequests.filter(r => r.loanId === loanId);
            const pendingRequests = loanRequests.filter(r => r.status === 'pending');
            
            if (pendingRequests.length === 0) {
                // All guarantors have responded
                const approvedRequests = loanRequests.filter(r => r.status === 'approved');
                const totalApprovedAmount = approvedRequests.reduce((sum, r) => sum + r.approvedAmount, 0);
                const loan = appState.loans.find(l => l.id === loanId);
                
                if (loan && totalApprovedAmount >= loan.amount) {
                    // Sufficient guarantee - notify applicant via WhatsApp
                    addNotification({
                        type: 'loan-ready',
                        title: '✅ Loan Ready for Review',
                        message: `All guarantors have responded. Total guarantee: R ${totalApprovedAmount.toLocaleString()}. Your loan is now ready for Loan Officer review.`
                    }, loan.memberId);
                } else if (loan) {
                    // Insufficient guarantee - notify applicant via WhatsApp
                    addNotification({
                        type: 'loan-insufficient',
                        title: '⚠️ Insufficient Guarantee',
                        message: `Some guarantors declined. Total approved: R ${totalApprovedAmount.toLocaleString()}. Loan amount: R ${loan.amount.toLocaleString()}. You need to add more guarantors or reduce your loan amount.`
                    }, loan.memberId);
                }
            }
        }
        
        function renderNotifications() {
            const list = document.getElementById('notificationList');
            list.innerHTML = appState.notifications.map(notif => `
                <div class="notification ${notif.unread ? 'unread' : ''}">
                    <div class="notification-icon">${notif.type === 'payment' ? '💰' : notif.type === 'reminder' ? '🔔' : '📋'}</div>
                    <div class="notification-content">
                        <div class="notification-title">${notif.title}</div>
                        <div class="notification-message">${notif.message}</div>
                        <div class="notification-time">${notif.time}</div>
                    </div>
                </div>
            `).join('');
        }
        
        // Modal Functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            
            // Populate member dropdowns
            if (modalId === 'recordContributionModal') {
                const selectId = 'contributionMember';
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Select Member</option>' + 
                    appState.members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            } else if (modalId === 'newLoanModal') {
                const select = document.getElementById('loanMember');
                select.innerHTML = '<option value="">Select Member</option>' + 
                    appState.members
                        .filter(m => m.status === 'current') // Only current members can apply
                        .map(m => `<option value="${m.id}">${m.name}</option>`)
                        .join('');
            } else if (modalId === 'submitPaymentModal') {
                // Populate member's payment info
                if (appState.currentUser) {
                    const tierInfo = appState.tiers[appState.currentUser.tier];
                    const isLate = appState.currentUser.status === 'late';
                    const dueAmount = tierInfo.weeklySubscription + (isLate ? appState.lateFee : 0);
                    
                    document.getElementById('myPaymentInfo').innerHTML = `
                        <strong>Member:</strong> ${appState.currentUser.name}<br>
                        <strong>Tier:</strong> ${appState.currentUser.tier} (${appState.currentUser.shares} share${appState.currentUser.shares > 1 ? 's' : ''})<br>
                        <strong>Weekly Subscription:</strong> R ${tierInfo.weeklySubscription}<br>
                        ${isLate ? `<strong style="color: var(--danger);">Late Fee:</strong> R ${appState.lateFee}<br>` : ''}
                        <strong>Total Due:</strong> R ${dueAmount}
                    `;
                    
                    // Set today's date as default
                    document.getElementById('myPaymentDate').value = new Date().toISOString().split('T')[0];
                    
                    // Pre-fill amount
                    document.getElementById('myPaymentAmount').value = dueAmount;
                }
            } else if (modalId === 'newMinutesModal') {
                // Populate attendees checklist
                populateAttendeesChecklist();
                // Set today's date as default
                document.getElementById('minutesDate').value = new Date().toISOString().split('T')[0];
                
                // Populate Proposer and Seconder dropdowns
                const proposerSelect = document.getElementById('minutesProposer');
                const seconderSelect = document.getElementById('minutesSeconder');
                
                const memberOptions = '<option value="">-- Select Member --</option>' + 
                    appState.members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
                
                if (proposerSelect) proposerSelect.innerHTML = memberOptions;
                if (seconderSelect) seconderSelect.innerHTML = memberOptions;
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // Form Handlers
        function updateTierInfo() {
            const tierSelect = document.getElementById('memberTier');
            const tier = parseInt(tierSelect.value);
            const tierInfoDiv = document.getElementById('tierInfo');
            
            if (tier) {
                const tierData = appState.tiers[tier];
                document.getElementById('tierInvestment').textContent = `R ${tierData.initialInvestment.toLocaleString()}`;
                document.getElementById('tierShares').textContent = tierData.shares;
                document.getElementById('tierSubscription').textContent = `R ${tierData.weeklySubscription}`;
                tierInfoDiv.style.display = 'block';
            } else {
                tierInfoDiv.style.display = 'none';
            }
        }
        
        function updateContributionAmount() {
            const memberSelect = document.getElementById('contributionMember');
            const memberId = parseInt(memberSelect.value);
            const applyLateFee = document.getElementById('applyLateFee').checked;
            
            if (memberId) {
                const member = appState.members.find(m => m.id === memberId);
                const tierInfo = appState.tiers[member.tier];
                const baseAmount = tierInfo.weeklySubscription;
                const lateFee = applyLateFee ? appState.lateFee : 0;
                const totalAmount = baseAmount + lateFee;
                
                document.getElementById('contributionAmount2').value = totalAmount;
                
                const breakdown = document.getElementById('contributionBreakdown');
                if (lateFee > 0) {
                    breakdown.innerHTML = `Base subscription: R ${baseAmount}<br>Late fee: R ${lateFee}<br><strong>Total: R ${totalAmount}</strong>`;
                    breakdown.style.color = 'var(--danger)';
                } else {
                    breakdown.innerHTML = `Tier ${member.tier} weekly subscription`;
                    breakdown.style.color = 'var(--text-muted)';
                }
            }
        }
        
        function addMember(e) {
            e.preventDefault();
            const tier = parseInt(document.getElementById('memberTier').value);
            const tierInfo = appState.tiers[tier];
            
            const newMember = {
                id: appState.members.length + 1,
                name: document.getElementById('memberName').value,
                email: document.getElementById('memberEmail').value,
                phone: document.getElementById('memberPhone').value,
                role: document.getElementById('memberRole').value,
                tier: tier,
                shares: tierInfo.shares,
                balance: tierInfo.initialInvestment,
                joined: new Date().toISOString().split('T')[0],
                lastPayment: new Date().toISOString().split('T')[0],
                status: 'current'
            };
            appState.members.push(newMember);
            renderMembers();
            closeModal('addMemberModal');
            e.target.reset();
            document.getElementById('tierInfo').style.display = 'none';
            showNotification('Member added successfully!', 'success');
        }
        
        function recordContribution(e) {
            e.preventDefault();
            const memberId = parseInt(document.getElementById('contributionMember').value);
            const member = appState.members.find(m => m.id === memberId);
            const amount = parseFloat(document.getElementById('contributionAmount2').value);
            
            // Create payment record with proof
            const payment = {
                memberId: memberId,
                amount: amount,
                method: document.getElementById('paymentMethod').value,
                reference: document.getElementById('paymentReference').value,
                proof: currentProofData,
                date: new Date().toISOString().split('T')[0],
                recordedBy: appState.currentUser.name,
                status: 'confirmed'
            };
            
            // Save to database
            saveToDB('contributions', payment).then(savedPayment => {
                appState.contributions.push(savedPayment);
                
                // Update member's last payment and status
                member.lastPayment = new Date().toISOString().split('T')[0];
                member.status = 'current';
                member.balance += amount;
                
                // Update member in database
                return saveToDB('users', member);
            }).then(() => {
                showNotification(`Payment of R ${amount} recorded successfully for ${member.name}!`, 'success');
                closeModal('recordContributionModal');
                e.target.reset();
                removeProof();
                
                // Refresh the contributions view if it's active
                if (document.getElementById('contributions').classList.contains('active')) {
                    renderContributions();
                }
            }).catch(error => {
                console.error('Error recording contribution:', error);
                alert('Failed to record payment. Please try again.');
            });
        }
        
        function createLoan(e) {
            e.preventDefault();
            
            const memberId = parseInt(document.getElementById('loanMember').value);
            const member = appState.members.find(m => m.id === memberId);
            const amount = parseFloat(document.getElementById('loanAmount').value);
            const durationWeeks = parseInt(document.getElementById('loanDurationWeeks').value);
            
            // FINAL VALIDATION: Check loan amount against total guarantee
            const totalGuarantee = calculateTotalGuarantee();
            
            if (amount > totalGuarantee) {
                const shortfall = amount - totalGuarantee;
                showNotification(
                    `❌ Cannot submit loan application! Loan amount (R ${amount.toLocaleString()}) exceeds available guarantee (R ${totalGuarantee.toLocaleString()}). You need R ${shortfall.toLocaleString()} more in guarantees.`,
                    'error'
                );
                return; // Stop submission
            }
            
            if (totalGuarantee === 0) {
                showNotification('❌ Please select at least one guarantor before submitting.', 'error');
                return; // Stop submission
            }
            
            const newLoan = {
                memberId: memberId,
                amount: amount,
                term: durationWeeks,
                interest: 10,
                outstanding: parseFloat(document.getElementById('loanTotalPI').value),
                nextPayment: calculateNextPaymentDate(durationWeeks),
                status: 'pending',
                applicationDate: new Date().toISOString().split('T')[0],
                // Store full application details
                applicationDetails: {
                    idType: document.getElementById('idType').value,
                    idNumber: document.getElementById('idNumber').value,
                    altPhone: document.getElementById('altPhone').value,
                    residentialAddress: document.getElementById('residentialAddress').value,
                    resLocation: document.getElementById('resLocation').value,
                    resSuburb: document.getElementById('resSuburb').value,
                    resAreaCode: document.getElementById('resAreaCode').value,
                    resProvince: document.getElementById('resProvince').value,
                    businessAddress: document.getElementById('businessAddress').value,
                    collateralType: document.getElementById('collateralType').value,
                    collateralValue: document.getElementById('collateralValue').value,
                    guarantor1: document.getElementById('guarantor1').value,
                    guarantor2: document.getElementById('guarantor2').value,
                    guarantor3: document.getElementById('guarantor3').value,
                    guarantor4: document.getElementById('guarantor4').value,
                    guarantor5: document.getElementById('guarantor5').value
                },
                // Banking details for disbursement
                bankingDetails: {
                    bankName: document.getElementById('loanBankName').value,
                    branchCode: document.getElementById('loanBranchCode').value,
                    accountName: document.getElementById('loanAccountName').value,
                    accountNumber: document.getElementById('loanAccountNumber').value,
                    accountType: document.getElementById('loanAccountType').value,
                    reference: document.getElementById('loanReference').value || `Loan Payment - ${member.name}`
                }
            };
            
            // Save to database
            saveToDB('loans', newLoan).then(savedLoan => {
                appState.loans.push(savedLoan);
                
                // Send guarantor requests to each selected guarantor
                sendGuarantorRequests(savedLoan);
                
                showNotification(`Loan application submitted successfully! Guarantors have been notified and must approve before Loan Officer review.`, 'success');
                closeModal('newLoanModal');
                e.target.reset();
                
                // Refresh loans view if active
                if (document.getElementById('loans').classList.contains('active')) {
                    renderLoans();
                }
            }).catch(error => {
                console.error('Error creating loan:', error);
                alert('Failed to submit loan application. Please try again.');
            });
        }
        
        function sendGuarantorRequests(loan) {
            const details = loan.applicationDetails;
            
            // Loop through all 5 guarantor slots
            for (let i = 1; i <= 5; i++) {
                const guarantorId = details[`guarantor${i}`];
                
                if (guarantorId && guarantorId !== 'SELF') {
                    // Create guarantor request
                    const request = {
                        id: appState.guarantorRequests.length + 1,
                        loanId: loan.id || appState.loans.length,
                        applicantId: loan.memberId,
                        applicantName: appState.members.find(m => m.id === loan.memberId)?.name,
                        guarantorId: parseInt(guarantorId),
                        guarantorPosition: i,
                        loanAmount: loan.amount,
                        loanTerm: loan.term,
                        requestedAmount: parseFloat(document.getElementById(`guarantor${i}Value`).value) || 0,
                        approvedAmount: null,
                        status: 'pending', // pending, approved, rejected
                        requestDate: new Date().toISOString(),
                        responseDate: null,
                        comments: ''
                    };
                    
                    appState.guarantorRequests.push(request);
                    
                    // Send notification to guarantor via WhatsApp
                    addNotification({
                        type: 'guarantor-request',
                        title: '🤝 Guarantor Request',
                        message: `${request.applicantName} requests you as guarantor for R ${loan.amount.toLocaleString()} loan. Amount requested from you: R ${request.requestedAmount.toLocaleString()}`,
                        requestId: request.id
                    }, parseInt(guarantorId));
                }
            }
        }
        
        function calculateNextPaymentDate(weeks) {
            const date = new Date();
            date.setDate(date.getDate() + (weeks * 7));
            return date.toISOString().split('T')[0];
        }
        
        function updateBranchCode() {
            const bankSelect = document.getElementById('loanBankName');
            const branchCodeInput = document.getElementById('loanBranchCode');
            
            if (bankSelect && branchCodeInput) {
                const selectedOption = bankSelect.options[bankSelect.selectedIndex];
                const branchCode = selectedOption.getAttribute('data-branch');
                
                if (branchCode) {
                    branchCodeInput.value = branchCode;
                } else {
                    branchCodeInput.value = '';
                }
            }
        }
        
        function populateMemberInfo() {
            const memberId = parseInt(document.getElementById('loanMember').value);
            const member = appState.members.find(m => m.id === memberId);
            
            if (member) {
                // Auto-populate member information
                const nameParts = member.name.split(' ');
                document.getElementById('loanFirstNames').value = nameParts.slice(1).join(' ');
                document.getElementById('loanPhone').value = member.phone;
                document.getElementById('loanEmail').value = member.email;
                document.getElementById('regNo').value = `MSK-${String(member.id).padStart(4, '0')}`;
                
                // Populate shares and savings
                document.getElementById('memberShares').value = member.shares;
                const tierInfo = appState.tiers[member.tier];
                document.getElementById('shareValue').value = tierInfo.initialInvestment;
                document.getElementById('memberSavings').value = member.balance;
                document.getElementById('savingsDate').value = new Date().toISOString().split('T')[0];
                
                const totalSharesSavings = tierInfo.initialInvestment + member.balance;
                document.getElementById('totalSharesSavings').value = totalSharesSavings;
                
                // Populate guarantor dropdowns with SELF GUARANTEE option and other members
                const guarantorOptions = '<option value="">Select Member</option>' + 
                    '<option value="SELF" style="background: rgba(0, 180, 216, 0.2); font-weight: bold;">🔒 SELF GUARANTEE</option>' +
                    appState.members
                        .filter(m => m.id !== memberId && m.status === 'current')
                        .map(m => `<option value="${m.id}">${m.name}</option>`)
                        .join('');
                
                document.getElementById('guarantor1').innerHTML = guarantorOptions;
                document.getElementById('guarantor2').innerHTML = guarantorOptions;
                document.getElementById('guarantor3').innerHTML = guarantorOptions;
                document.getElementById('guarantor4').innerHTML = guarantorOptions;
                document.getElementById('guarantor5').innerHTML = guarantorOptions;
            }
        }
        
        function calculateLoanDetails() {
            const amount = parseFloat(document.getElementById('loanAmount').value) || 0;
            const weeks = parseInt(document.getElementById('loanDurationWeeks').value) || 0;
            
            if (amount > 0 && weeks > 0) {
                // Calculate interest (10% per annum, prorated for weeks)
                const annualInterestRate = 0.10;
                const weeklyInterestRate = annualInterestRate / 52;
                const totalInterest = amount * weeklyInterestRate * weeks;
                const totalPI = amount + totalInterest;
                
                document.getElementById('loanInterestCalc').value = totalInterest.toFixed(2);
                document.getElementById('loanTotalPI').value = totalPI.toFixed(2);
                document.getElementById('guaranteeAmount').value = totalPI.toFixed(2);
                
                // Validate against available guarantee
                validateLoanAgainstGuarantee();
            }
        }
        
        function calculateTotalGuarantee() {
            let totalGuarantee = 0;
            
            // Add all guarantor values
            for (let i = 1; i <= 5; i++) {
                const guarantorValue = parseFloat(document.getElementById(`guarantor${i}Value`).value) || 0;
                totalGuarantee += guarantorValue;
            }
            
            return totalGuarantee;
        }
        
        function validateLoanAgainstGuarantee() {
            const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
            const totalGuarantee = calculateTotalGuarantee();
            const loanAmountField = document.getElementById('loanAmount');
            const submitButton = document.querySelector('#newLoanModal button[type="submit"]');
            
            // Update total guarantee display
            const totalGuaranteeDisplay = document.getElementById('totalGuaranteeDisplay');
            if (totalGuaranteeDisplay) {
                totalGuaranteeDisplay.textContent = `R ${totalGuarantee.toLocaleString()}`;
            }
            
            // Create or get validation message element
            let validationMsg = document.getElementById('loanValidationMsg');
            if (!validationMsg) {
                validationMsg = document.createElement('div');
                validationMsg.id = 'loanValidationMsg';
                validationMsg.style.cssText = 'margin-top: 10px; padding: 12px; border-radius: 8px; font-size: 14px; font-weight: 600;';
                loanAmountField.parentElement.appendChild(validationMsg);
            }
            
            if (loanAmount > 0 && totalGuarantee > 0) {
                const coverage = (totalGuarantee / loanAmount) * 100;
                
                if (loanAmount > totalGuarantee) {
                    // INVALID: Loan exceeds guarantee
                    validationMsg.style.background = 'rgba(255, 75, 87, 0.2)';
                    validationMsg.style.borderLeft = '4px solid var(--danger)';
                    validationMsg.style.color = 'var(--danger)';
                    validationMsg.innerHTML = `
                        ❌ <strong>LOAN AMOUNT EXCEEDS AVAILABLE GUARANTEE!</strong><br>
                        <span style="font-size: 13px; font-weight: normal;">
                            Loan: R ${loanAmount.toLocaleString()} | 
                            Available Guarantee: R ${totalGuarantee.toLocaleString()} | 
                            Shortfall: R ${(loanAmount - totalGuarantee).toLocaleString()}
                        </span>
                    `;
                    loanAmountField.style.borderColor = 'var(--danger)';
                    if (submitButton) submitButton.disabled = true;
                    
                } else if (coverage >= 100) {
                    // VALID: Sufficient guarantee
                    validationMsg.style.background = 'rgba(0, 122, 77, 0.2)';
                    validationMsg.style.borderLeft = '4px solid var(--success)';
                    validationMsg.style.color = 'var(--success)';
                    validationMsg.innerHTML = `
                        ✅ <strong>SUFFICIENT GUARANTEE</strong><br>
                        <span style="font-size: 13px; font-weight: normal;">
                            Loan: R ${loanAmount.toLocaleString()} | 
                            Available Guarantee: R ${totalGuarantee.toLocaleString()} | 
                            Coverage: ${coverage.toFixed(0)}%
                        </span>
                    `;
                    loanAmountField.style.borderColor = 'var(--success)';
                    if (submitButton) submitButton.disabled = false;
                }
            } else if (loanAmount > 0 && totalGuarantee === 0) {
                // WARNING: No guarantors selected yet
                validationMsg.style.background = 'rgba(230, 126, 34, 0.2)';
                validationMsg.style.borderLeft = '4px solid var(--gold)';
                validationMsg.style.color = 'var(--gold)';
                validationMsg.innerHTML = `
                    ⚠️ <strong>PLEASE SELECT GUARANTORS</strong><br>
                    <span style="font-size: 13px; font-weight: normal;">
                        You need at least R ${loanAmount.toLocaleString()} in total guarantees to apply for this loan.
                    </span>
                `;
                loanAmountField.style.borderColor = 'var(--gold)';
                if (submitButton) submitButton.disabled = true;
            } else {
                // Clear validation
                validationMsg.innerHTML = '';
                validationMsg.style.background = 'none';
                validationMsg.style.borderLeft = 'none';
                loanAmountField.style.borderColor = '';
                if (submitButton) submitButton.disabled = false;
            }
        }
        
        function validateAndUpdateGuarantor(guarantorNum) {
            const selectId = `guarantor${guarantorNum}`;
            const valueId = `guarantor${guarantorNum}Value`;
            const selectedValue = document.getElementById(selectId).value;
            
            // Check for duplicates
            const allGuarantors = [];
            for (let i = 1; i <= 5; i++) {
                const val = document.getElementById(`guarantor${i}`).value;
                if (val && i !== guarantorNum) {
                    allGuarantors.push(val);
                }
            }
            
            // If this guarantor is already selected elsewhere
            if (selectedValue && allGuarantors.includes(selectedValue)) {
                showNotification('❌ This guarantor is already selected! Please choose a different member.', 'error');
                document.getElementById(selectId).value = '';
                document.getElementById(valueId).value = '';
                return;
            }
            
            // Update value based on selection
            if (selectedValue === 'SELF') {
                // For self-guarantee, use the applicant's own shares/savings
                const totalSharesSavings = parseFloat(document.getElementById('totalSharesSavings').value) || 0;
                document.getElementById(valueId).value = totalSharesSavings;
            } else if (selectedValue) {
                // For member guarantor
                const memberId = parseInt(selectedValue);
                const member = appState.members.find(m => m.id === memberId);
                if (member) {
                    const tierInfo = appState.tiers[member.tier];
                    const totalValue = tierInfo.initialInvestment + member.balance;
                    document.getElementById(valueId).value = totalValue;
                }
            } else {
                // Empty selection
                document.getElementById(valueId).value = '';
            }
            
            // Validate loan amount against total guarantee after updating
            validateLoanAgainstGuarantee();
        }
        
        // Keep old function for backward compatibility
        function updateGuarantorValue(guarantorNum) {
            validateAndUpdateGuarantor(guarantorNum);
        }
        
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message) {
                appState.chatMessages.push({
                    id: appState.chatMessages.length + 1,
                    sender: 'You',
                    message: message,
                    time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
                    isSent: true
                });
                renderChat();
                input.value = '';
            }
        }
        
        function sendReminder() {
            showNotification('Payment reminder sent successfully!', 'success');
        }
        
        function saveSettings() {
            showNotification('Settings saved successfully!', 'success');
        }
        
        // Position Management Functions
        // Render Leadership Display (All Members)
        function renderLeadershipDisplay() {
            const positions = ["chairperson", "viceChairperson", "treasurer", "secretary", "loanOfficer", "paymentLoader", "paymentReleaser"];
            
            positions.forEach(position => {
                const displayDiv = document.getElementById(`${position}Display`);
                const termDiv = document.getElementById(`${position}TermDisplay`);
                const currentPosition = appState.electedPositions[position];
                
                if (currentPosition && displayDiv) {
                    const member = appState.members.find(m => m.id === currentPosition.memberId);
                    if (member) {
                        displayDiv.textContent = member.name;
                        displayDiv.style.color = "var(--text)";
                        if (termDiv) termDiv.textContent = `Elected: ${currentPosition.electedDate} | Term: ${currentPosition.term}`;
                    }
                } else {
                    if (displayDiv) {
                        displayDiv.textContent = "Not Assigned";
                        displayDiv.style.color = "var(--text-muted)";
                    }
                    if (termDiv) termDiv.textContent = "—";
                }
            });
            
            const adminSection = document.getElementById("leadershipAdminSection");
            if (adminSection) {
                // Only Admin User (ID: 1) can see and use position assignment controls
                const isSystemAdmin = appState.currentUser.id === 1;
                adminSection.style.display = isSystemAdmin ? "block" : "none";
                
                if (isSystemAdmin) {
                    positions.forEach(position => {
                        const select = document.getElementById(`position${position.charAt(0).toUpperCase() + position.slice(1)}`);
                        if (!select) return;
                        const currentPosition = appState.electedPositions[position];
                        select.innerHTML = "<option value=\"\">-- Not Assigned --</option>" + 
                            appState.members.map(m => 
                                `<option value="${m.id}" ${currentPosition?.memberId === m.id ? "selected" : ""}>${m.name}</option>`
                            ).join("");
                    });
                }
            }
        }
        

        function renderPositions() {
            const positions = ['chairperson', 'viceChairperson', 'treasurer', 'secretary', 'loanOfficer'];
            
            positions.forEach(position => {
                const select = document.getElementById(`position${position.charAt(0).toUpperCase() + position.slice(1)}`);
                if (!select) return;
                
                const currentPosition = appState.electedPositions[position];
                
                // Populate dropdown with all members
                select.innerHTML = '<option value="">-- Select Member --</option>' + 
                    appState.members.map(m => 
                        `<option value="${m.id}" ${currentPosition?.memberId === m.id ? 'selected' : ''}>${m.name}</option>`
                    ).join('');
                
                // Show term info
                const termDiv = document.getElementById(`${position}Term`);
                if (termDiv && currentPosition) {
                    const member = appState.members.find(m => m.id === currentPosition.memberId);
                    termDiv.textContent = `Elected: ${currentPosition.electedDate} | Term: ${currentPosition.term}`;
                }
            });
        }
        
        function updatePosition(positionName, memberId) {
            if (!memberId) {
                if (confirm('Remove this position? This will revoke their permissions.')) {
                    delete appState.electedPositions[positionName];
                    showNotification('Position cleared', 'success');
                    renderLeadershipDisplay();
                    updateUserInterface();
                }
                return;
            }
            
            const member = appState.members.find(m => m.id === parseInt(memberId));
            if (!member) return;
            
            if (confirm(`Assign ${member.name} to this position?`)) {
                appState.electedPositions[positionName] = {
                    memberId: parseInt(memberId),
                    electedDate: new Date().toISOString().split('T')[0],
                    term: new Date().getFullYear() + '-' + (new Date().getFullYear() + 1)
                };
                
                showNotification(`${member.name} assigned as ${positionName.replace(/([A-Z])/g, ' $1').toLowerCase()}!`, 'success');
                renderLeadershipDisplay();
                updateUserInterface();
            } else {
                // Reset dropdown
                renderLeadershipDisplay();
            }
        }
        
        function generateReport(type) {
            const summaryDiv = document.getElementById('aiReportSummary');
            summaryDiv.innerHTML = '<div class="loading"></div> Generating AI-powered report...';
            
            setTimeout(() => {
                const totalShares = appState.members.reduce((sum, m) => sum + m.shares, 0);
                const weeklyTotal = appState.members.reduce((sum, m) => sum + appState.tiers[m.tier].weeklySubscription, 0);
                const tier1Count = appState.members.filter(m => m.tier === 1).length;
                const tier2Count = appState.members.filter(m => m.tier === 2).length;
                const tier3Count = appState.members.filter(m => m.tier === 3).length;
                const tier4Count = appState.members.filter(m => m.tier === 4).length;
                const tier5Count = appState.members.filter(m => m.tier === 5).length;
                
                summaryDiv.innerHTML = `
                    <strong>${type.charAt(0).toUpperCase() + type.slice(1)} Financial Summary</strong><br><br>
                    <strong>Membership Structure:</strong><br>
                    - Tier 1: ${tier1Count} members (${tier1Count} shares)<br>
                    - Tier 2: ${tier2Count} members (${tier2Count * 2} shares)<br>
                    - Tier 3: ${tier3Count} members (${tier3Count * 3} shares)<br>
                    - Tier 4: ${tier4Count} members (${tier4Count * 4} shares)<br>
                    - Tier 5: ${tier5Count} members (${tier5Count * 5} shares)<br>
                    - Total: ${appState.members.length} members with ${totalShares} shares<br><br>
                    <strong>Financial Performance:</strong><br>
                    Weekly subscriptions collected: R ${weeklyTotal.toLocaleString()} (75% collection rate this week)<br>
                    Late fees collected: R 100<br>
                    Investment returns: +15.2% growth<br>
                    Active loans: R 12,000 with 100% on-time payment rate<br>
                    Projected annual subscription income: R ${weeklyTotal * 52}<br>
                    Current pool value: R 315,900<br><br>
                    <em>Recommendation: Strong membership tier distribution with healthy weekly cash flow. Consider tier-based dividend distribution based on share ownership. 2 members need payment follow-up to maintain 100% collection rate.</em>
                `;
            }, 2000);
        }
        
        // ============================================
        // WHATSAPP INTEGRATION FUNCTIONS
        // ============================================
        
        function formatPhoneForWhatsApp(phone) {
            // Remove all non-digit characters
            const cleaned = phone.replace(/\D/g, '');
            // Ensure it starts with country code (27 for South Africa)
            if (cleaned.startsWith('0')) {
                return '27' + cleaned.substring(1);
            }
            if (!cleaned.startsWith('27')) {
                return '27' + cleaned;
            }
            return cleaned;
        }
        
        function sendWhatsAppMessage(phone, message) {
            const formattedPhone = formatPhoneForWhatsApp(phone);
            const encodedMessage = encodeURIComponent(message);
            
            // Development mode - just log
            if (WHATSAPP_CONFIG.LOG_ONLY) {
                console.log('📱 WhatsApp Message (LOG MODE)');
                console.log('To:', phone, '(' + formattedPhone + ')');
                console.log('Message:', message);
                return;
            }
            
            // Development mode - show in alert instead of opening WhatsApp
            if (WHATSAPP_CONFIG.DEVELOPMENT_MODE) {
                alert('📱 WhatsApp Message Ready\n\nTo: ' + phone + '\n\n' + message + '\n\n(Development mode - WhatsApp not opened)');
                return;
            }
            
            // Confirm before send (optional)
            if (WHATSAPP_CONFIG.CONFIRM_BEFORE_SEND) {
                if (!confirm('Send WhatsApp notification to ' + phone + '?')) {
                    return;
                }
            }
            
            // Production mode - open WhatsApp
            const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodedMessage}`;
            
            // Detect device type
            const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
            
            if (isMobile) {
                // Mobile - try to open WhatsApp app directly
                window.location.href = `whatsapp://send?phone=${formattedPhone}&text=${encodedMessage}`;
                
                // Fallback to web after 1 second if app doesn't open
                setTimeout(() => {
                    window.open(whatsappUrl, '_blank');
                }, 1000);
            } else {
                // Desktop - open WhatsApp Web in new tab
                window.open(whatsappUrl, '_blank');
            }
        }
        
        // Improved version that sends to specific phone number
        function sendWhatsAppNotificationDirect(phone, message) {
            // This is an alias for the main function
            sendWhatsAppMessage(phone, message);
        }
        
        function shareToWhatsApp(message) {
            const encodedMessage = encodeURIComponent(message);
            window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
        }
        
        function copyToClipboard(text, successMessage = 'Copied to clipboard!') {
            navigator.clipboard.writeText(text).then(() => {
                showNotification(successMessage, 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification(successMessage, 'success');
            });
        }
        
        function sendPaymentReminder(member) {
            const tierInfo = appState.tiers[member.tier];
            const isLate = member.status === 'late';
            const amount = tierInfo.weeklySubscription;
            const lateFee = isLate ? ` (+ R${appState.lateFee} late fee)` : '';
            
            const message = `Hi ${member.name},

This is a friendly reminder from Masonko Stokvel "Guptas" 🏦

Your weekly contribution of R${amount}${lateFee} is ${isLate ? 'OVERDUE ⚠️' : 'due soon'}.

Please make your payment at your earliest convenience.

Thank you for your continued participation! 🙏

- Masonko Stokvel Management`;
            
            sendWhatsAppMessage(member.cellNumber, message);
        }
        
        function contactMember(member) {
            const message = `Hi ${member.name}, this is a message from Masonko Stokvel "Guptas". `;
            sendWhatsAppMessage(member.cellNumber, message);
        }
        
        function generateWeeklyWhatsAppReport() {
            const totalPool = appState.members.reduce((sum, m) => sum + m.balance, 0);
            const activeMembers = appState.members.filter(m => m.status === 'current').length;
            const weeklySubscriptions = appState.members.reduce((sum, m) => sum + appState.tiers[m.tier].weeklySubscription, 0);
            const lateMembers = appState.members.filter(m => m.status === 'late').length;
            const totalShares = appState.members.reduce((sum, m) => sum + m.shares, 0);
            
            const report = `*📊 MASONKO STOKVEL - WEEKLY REPORT*
_${new Date().toLocaleDateString('en-ZA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}_

*FINANCIAL OVERVIEW*
💰 Total Pool Value: *R ${totalPool.toLocaleString()}*
💳 Weekly Subscriptions: R ${weeklySubscriptions.toLocaleString()}
📈 Total Shares: ${totalShares}

*MEMBERSHIP STATUS*
👥 Active Members: ${activeMembers}
${lateMembers > 0 ? `⚠️ Outstanding Payments: ${lateMembers} member${lateMembers > 1 ? 's' : ''}` : '✅ All payments current'}

*NEXT MEETING*
📅 Check app for meeting schedule

_View full details in the app_
_Masonko Stokvel "Guptas"_ 🏛️`;
            
            copyToClipboard(report, '✅ Weekly report copied! Paste in WhatsApp group');
        }
        
        function shareMinutesToWhatsApp(minutes) {
            const message = `📋 *NEW MEETING MINUTES AVAILABLE*

*Date:* ${new Date(minutes.date).toLocaleDateString('en-ZA')}
*Type:* ${minutes.type}
*Venue:* ${minutes.venue}

View full minutes in the Masonko Stokvel app.

_- Masonko Stokvel "Guptas"_`;
            
            shareToWhatsApp(message);
        }
        
        function shareReportToWhatsApp(reportType) {
            const message = `📊 *MASONKO STOKVEL ${reportType.toUpperCase()} REPORT*

New ${reportType} report is now available in the app.

Log in to view detailed financial information.

_- Masonko Stokvel "Guptas"_ 🏦`;
            
            shareToWhatsApp(message);
        }
        
        // ============================================
        // WHATSAPP NOTIFICATION SYSTEM
        // ============================================
        
        function getAppLink(section = 'dashboard') {
            // Get current URL without query params
            const baseUrl = window.location.origin + window.location.pathname;
            return `${baseUrl}#${section}`;
        }
        
        function sendWhatsAppNotification(recipientId, notification) {
            // Find recipient member
            const recipient = appState.members.find(m => m.id === recipientId);
            if (!recipient || !recipient.phone) {
                console.log('Recipient not found or no phone number');
                return;
            }
            
            // Determine which section to link to based on notification type
            let section = 'dashboard';
            let actionText = 'View in App';
            
            switch(notification.type) {
                case 'guarantor-request':
                    section = 'settings';
                    actionText = 'Respond to Request';
                    break;
                case 'guarantor-response':
                case 'loan-ready':
                case 'loan-insufficient':
                    section = 'loans';
                    actionText = 'View Loan Status';
                    break;
                case 'payment-load-required':
                case 'payment-release-required':
                    section = 'loans';
                    actionText = 'Take Action';
                    break;
                case 'funds-available':
                    section = 'loans';
                    actionText = 'View Loan Details';
                    break;
                case 'payment':
                case 'payment-received':
                    section = 'contributions';
                    actionText = 'View Payments';
                    break;
                case 'meeting':
                    section = 'minutes';
                    actionText = 'View Minutes';
                    break;
                default:
                    section = 'dashboard';
                    actionText = 'Open App';
            }
            
            const appLink = getAppLink(section);
            
            // Create WhatsApp message
            const whatsappMessage = `
*🏛️ MASONKO STOKVEL "GUPTAS"*

*${notification.title}*

${notification.message}

━━━━━━━━━━━━━━━━━━

📱 *${actionText}:*
${appLink}

⏰ ${notification.time || 'Just now'}

_Please log in to the platform to take action._
`.trim();
            
            // Send via WhatsApp
            sendWhatsAppMessage(recipient.phone, whatsappMessage);
        }
        
        function addNotification(notification, recipientId) {
            // Add to notifications array
            notification.id = appState.notifications.length + 1;
            notification.recipientId = recipientId;
            notification.time = notification.time || 'Just now';
            notification.unread = true;
            
            appState.notifications.unshift(notification);
            
            // Send WhatsApp notification if recipient is not current user
            if (recipientId && recipientId !== appState.currentUser.id) {
                sendWhatsAppNotification(recipientId, notification);
            }
            
            return notification;
        }
        
        function notifyMultipleMembers(notification, recipientIds) {
            recipientIds.forEach(recipientId => {
                const personalNotification = { ...notification };
                addNotification(personalNotification, recipientId);
            });
        }
        
        function notifyAllMembers(notification) {
            const allMemberIds = appState.members.map(m => m.id);
            notifyMultipleMembers(notification, allMemberIds);
        }
        
        function notifyLeadership(notification) {
            const leadershipIds = [];
            Object.values(appState.electedPositions).forEach(position => {
                if (position && position.memberId) {
                    leadershipIds.push(position.memberId);
                }
            });
            notifyMultipleMembers(notification, [...new Set(leadershipIds)]); // Remove duplicates
        }
        
        function showNotification(message, type) {
            // Simple in-app notification toast
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--accent)';
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: 600;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // ============================================
        // TWO-FACTOR AUTHENTICATION SYSTEM
        // ============================================
        
        let twoFATimer = null;
        
        function generate2FACode() {
            // Generate random 6-digit code
            return Math.floor(100000 + Math.random() * 900000).toString();
        }
        
        function send2FACode(user, method = 'whatsapp') {
            const code = generate2FACode();
            const expiresAt = new Date(Date.now() + 5 * 60 * 1000); // 5 minutes
            
            // Store 2FA session
            appState.twoFASession = {
                user: user,
                code: code,
                expiresAt: expiresAt,
                attempts: 0,
                method: method
            };
            
            // Send code via WhatsApp or Email
            if (method === 'whatsapp' && user.phone) {
                const message = `
*🏛️ MASONKO STOKVEL "GUPTAS"*
*🔐 LOGIN VERIFICATION CODE*

Your verification code is:

*${code}*

This code will expire in 5 minutes.

⚠️ *Security Warning:*
Never share this code with anyone. If you did not attempt to log in, please contact Masonko Stokvel immediately.

━━━━━━━━━━━━━━━━━━

_This is an automated security message._
                `.trim();
                
                sendWhatsAppMessage(user.phone, message);
                return 'whatsapp';
            } else if (method === 'email' && user.email) {
                // Email fallback
                const message = `
*🏛️ MASONKO STOKVEL "GUPTAS"*
🔐 LOGIN VERIFICATION CODE

Your verification code is: ${code}

This code will expire in 5 minutes.

⚠️ Security Warning:
Never share this code with anyone. If you did not attempt to log in, please contact Masonko Stokvel immediately.

━━━━━━━━━━━━━━━━━━

This is an automated security message.
Email: security@masonko.com
                `.trim();
                
                // Simulate email send (in production, would call email API)
                console.log('Email sent to ' + user.email + ':', message);
                alert('📧 Verification code sent to ' + user.email + '\n\n(In development mode, code is: ' + code + ')');
                return 'email';
            }
            
            return method;
        }
        
        function start2FATimer() {
            let timeLeft = 300; // 5 minutes in seconds
            const timerDisplay = document.getElementById('twoFATimer');
            
            if (twoFATimer) clearInterval(twoFATimer);
            
            twoFATimer = setInterval(() => {
                timeLeft--;
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(twoFATimer);
                    timerDisplay.textContent = 'EXPIRED';
                    timerDisplay.style.color = 'var(--danger)';
                    appState.twoFASession = null;
                    showNotification('⏰ Verification code expired. Please login again.', 'error');
                    setTimeout(() => {
                        closeModal('twoFAModal');
                    }, 2000);
                } else if (timeLeft <= 60) {
                    timerDisplay.style.color = 'var(--danger)';
                } else if (timeLeft <= 120) {
                    timerDisplay.style.color = 'var(--gold)';
                }
            }, 1000);
        }
        
        function resend2FACode(method) {
            if (!appState.twoFASession) {
                showNotification('❌ Session expired. Please login again.', 'error');
                closeModal('twoFAModal');
                return;
            }
            
            const sentVia = send2FACode(appState.twoFASession.user, method);
            start2FATimer();
            
            const messageDiv = document.getElementById('twoFAMessage');
            if (sentVia === 'whatsapp') {
                messageDiv.innerHTML = `✅ New verification code sent to your WhatsApp: <strong>${appState.twoFASession.user.phone}</strong>`;
            } else {
                messageDiv.innerHTML = `✅ New verification code sent to your email: <strong>${appState.twoFASession.user.email}</strong>`;
            }
            
            showNotification(`📱 New code sent via ${method === 'whatsapp' ? 'WhatsApp' : 'Email'}`, 'success');
        }
        
        function verify2FACode(e) {
            e.preventDefault();
            
            const enteredCode = document.getElementById('twoFACode').value.trim();
            
            if (!appState.twoFASession) {
                showNotification('❌ Session expired. Please login again.', 'error');
                closeModal('twoFAModal');
                return;
            }
            
            // Check if code expired
            if (new Date() > new Date(appState.twoFASession.expiresAt)) {
                showNotification('⏰ Code expired. Please login again.', 'error');
                appState.twoFASession = null;
                closeModal('twoFAModal');
                return;
            }
            
            // Increment attempts
            appState.twoFASession.attempts++;
            
            // Check if too many attempts
            if (appState.twoFASession.attempts > 5) {
                showNotification('🔒 Too many failed attempts. Please login again.', 'error');
                appState.twoFASession = null;
                closeModal('twoFAModal');
                return;
            }
            
            // Verify code
            if (enteredCode === appState.twoFASession.code) {
                // Success! Complete login
                const user = appState.twoFASession.user;
                
                // Clear 2FA session
                appState.twoFASession = null;
                clearInterval(twoFATimer);
                
                // Set current user
                appState.currentUser = user;
                appState.isLoggedIn = true;
                
                // Save to localStorage
                localStorage.setItem('masonkoUser', JSON.stringify(user));
                
                // Close modals
                closeModal('twoFAModal');
                
                // Show main app
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
                // Update UI with user info
                updateUserInterface();
                
                // Log successful login
                console.log('2FA Login successful:', user.name);
                
                // Send login notification to user's WhatsApp
                if (user.phone) {
                    const loginMessage = `
*🏛️ MASONKO STOKVEL "GUPTAS"*
*✅ SUCCESSFUL LOGIN*

Your account was accessed successfully.

📅 Date: ${new Date().toLocaleString('en-ZA')}
🌍 Location: Johannesburg, ZA
📱 Device: Web Browser

If this wasn't you, please contact Masonko Stokvel immediately.

━━━━━━━━━━━━━━━━━━

_This is an automated security notification._
                    `.trim();
                    
                    sendWhatsAppMessage(user.phone, loginMessage);
                }
                
                showNotification(`✅ Welcome back, ${user.name}!`, 'success');
                
            } else {
                // Wrong code
                const attemptsLeft = 5 - appState.twoFASession.attempts;
                showNotification(`❌ Invalid code. ${attemptsLeft} attempt${attemptsLeft > 1 ? 's' : ''} remaining.`, 'error');
                document.getElementById('twoFACode').value = '';
                document.getElementById('twoFACode').focus();
            }
        }
        
        function cancel2FA() {
            if (confirm('Are you sure you want to cancel login?')) {
                appState.twoFASession = null;
                clearInterval(twoFATimer);
                closeModal('twoFAModal');
                document.getElementById('twoFACode').value = '';
            }
        }
        
        // Offline Detection
        window.addEventListener('online', () => {
            document.getElementById('offlineIndicator').classList.remove('show');
        });
        
        window.addEventListener('offline', () => {
            document.getElementById('offlineIndicator').classList.add('show');
        });
        
        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,');
        }
        
        // Chat input enter key
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
        
        // Meeting Minutes Functions
        function renderMinutes() {
            const table = document.getElementById('minutesTable');
            if (!appState.meetingMinutes || appState.meetingMinutes.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);">
                            No meeting minutes yet. Click "+ New Meeting Minutes" to create your first minutes.
                        </td>
                    </tr>
                `;
                return;
            }
            
            table.innerHTML = appState.meetingMinutes.map(minutes => {
                const attendeeCount = minutes.attendees ? minutes.attendees.length : 0;
                const statusColor = minutes.status === 'published' ? 'var(--success)' : 'var(--gold)';
                const statusText = minutes.status === 'published' ? '✓ Published' : '📝 Draft';
                
                return `
                    <tr>
                        <td>
                            <strong>${minutes.date}</strong><br>
                            <span style="font-size: 11px; color: var(--text-muted);">${minutes.time}</span>
                        </td>
                        <td>${minutes.type}</td>
                        <td>${attendeeCount} members present</td>
                        <td><span style="color: ${statusColor}; font-weight: 600;">${statusText}</span></td>
                        <td style="white-space: nowrap;">
                            <button class="btn btn-secondary" style="padding: 8px 16px;" onclick="viewMinutes(${minutes.id})"><span>👁️ View</span></button>
                            <button class="btn btn-primary" style="padding: 8px 16px; margin-left: 5px;" onclick="downloadMinutesPDF(${minutes.id})"><span>📄 PDF</span></button>
                            <button class="btn btn-primary" style="padding: 8px 16px; margin-left: 5px; background: #25D366;" onclick='shareMinutesToWhatsApp(${JSON.stringify(minutes).replace(/'/g, "\\'")})'><span>💬 Share</span></button>
                            ${minutes.status === 'draft' ? 
                                `<button class="btn btn-primary" style="padding: 8px 16px; margin-left: 5px;" onclick="publishMinutes(${minutes.id})"><span>✓ Publish</span></button>` : 
                                ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function populateAttendeesChecklist() {
            const container = document.getElementById('attendeesList');
            container.innerHTML = appState.members.map(member => `
                <label style="display: flex; align-items: center; padding: 8px; margin: 5px 0; background: rgba(0, 180, 216, 0.05); border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                    <input type="checkbox" name="attendees" value="${member.id}" style="width: auto; margin-right: 10px;" checked>
                    <span style="flex: 1;">${member.name}</span>
                    <span style="font-size: 11px; color: var(--text-muted);">${member.role}</span>
                </label>
            `).join('');
        }
        
        let votingItemCounter = 0;
        
        function addVotingItem() {
            votingItemCounter++;
            const container = document.getElementById('votingItemsContainer');
            
            // Build member options separately to avoid nested template literals
            const memberOptions = appState.members.map(m => 
                `<option value="${m.id}">${m.name}</option>`
            ).join('');
            
            const votingItemDiv = document.createElement('div');
            votingItemDiv.id = `votingItem${votingItemCounter}`;
            votingItemDiv.className = 'voting-item';
            votingItemDiv.style.cssText = `
                background: rgba(0, 180, 216, 0.08);
                border: 2px solid var(--border);
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 15px;
                position: relative;
            `;
            
            votingItemDiv.innerHTML = `
                <button type="button" onclick="removeVotingItem(${votingItemCounter})" style="
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    background: var(--danger);
                    color: white;
                    border: none;
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    cursor: pointer;
                    font-size: 18px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">×</button>
                
                <div style="margin-bottom: 15px;">
                    <label style="font-weight: 600; color: var(--text); margin-bottom: 8px; display: block;">
                        Motion/Resolution Topic <span style="color: var(--danger);">*</span>
                    </label>
                    <select class="form-control voting-topic" style="margin-bottom: 10px;">
                        <option value="">-- Select Topic --</option>
                        <option value="investment">💰 Investment Decision</option>
                        <option value="member">👥 New Member Induction</option>
                        <option value="constitution">📜 Constitutional Change</option>
                        <option value="loan">🏦 Loan Approval</option>
                        <option value="tier">💎 Tier Structure Change</option>
                        <option value="leadership">👑 Leadership Election</option>
                        <option value="expenditure">💸 Major Expenditure</option>
                        <option value="other">📋 Other Motion</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="font-weight: 600; color: var(--text); margin-bottom: 8px; display: block;">
                        Motion Description <span style="color: var(--danger);">*</span>
                    </label>
                    <textarea class="form-control voting-description" rows="3" placeholder="Describe the motion or resolution being voted on..." required></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="font-weight: 600; color: var(--text); margin-bottom: 8px; display: block;">
                            📝 Moved By
                        </label>
                        <select class="form-control voting-mover">
                            <option value="">-- Select Member --</option>
                            ${memberOptions}
                        </select>
                    </div>
                    
                    <div>
                        <label style="font-weight: 600; color: var(--text); margin-bottom: 8px; display: block;">
                            ✅ Seconded By
                        </label>
                        <select class="form-control voting-seconder">
                            <option value="">-- Select Member --</option>
                            ${memberOptions}
                        </select>
                    </div>
                </div>
                
                <div style="background: rgba(0, 0, 0, 0.2); border-radius: 8px; padding: 15px;">
                    <label style="font-weight: 600; color: var(--accent); margin-bottom: 12px; display: block;">
                        🗳️ Vote Results
                    </label>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                        <div>
                            <label style="font-size: 13px; color: var(--text-muted); margin-bottom: 5px; display: block;">
                                ✅ For
                            </label>
                            <input type="number" class="form-control voting-for" min="0" value="0" style="background: rgba(0, 122, 77, 0.1); border-color: var(--success);">
                        </div>
                        
                        <div>
                            <label style="font-size: 13px; color: var(--text-muted); margin-bottom: 5px; display: block;">
                                ❌ Against
                            </label>
                            <input type="number" class="form-control voting-against" min="0" value="0" style="background: rgba(255, 75, 87, 0.1); border-color: var(--danger);">
                        </div>
                        
                        <div>
                            <label style="font-size: 13px; color: var(--text-muted); margin-bottom: 5px; display: block;">
                                ⚪ Abstain
                            </label>
                            <input type="number" class="form-control voting-abstain" min="0" value="0" style="background: rgba(138, 165, 181, 0.1);">
                        </div>
                    </div>
                    
                    <div>
                        <label style="font-size: 13px; color: var(--text-muted); margin-bottom: 5px; display: block;">
                            Result
                        </label>
                        <select class="form-control voting-result">
                            <option value="passed">✅ Motion Passed</option>
                            <option value="failed">❌ Motion Failed</option>
                            <option value="deferred">⏸️ Deferred</option>
                        </select>
                    </div>
                </div>
            `;
            
            container.appendChild(votingItemDiv);
        }
        
        function removeVotingItem(itemId) {
            const item = document.getElementById(`votingItem${itemId}`);
            if (item && confirm('Remove this voting item?')) {
                item.remove();
            }
        }
        
        function getVotingItems() {
            const votingItems = [];
            const items = document.querySelectorAll('.voting-item');
            
            items.forEach((item, index) => {
                const topic = item.querySelector('.voting-topic').value;
                const description = item.querySelector('.voting-description').value;
                const mover = item.querySelector('.voting-mover').value;
                const seconder = item.querySelector('.voting-seconder').value;
                const votesFor = parseInt(item.querySelector('.voting-for').value) || 0;
                const votesAgainst = parseInt(item.querySelector('.voting-against').value) || 0;
                const abstain = parseInt(item.querySelector('.voting-abstain').value) || 0;
                const result = item.querySelector('.voting-result').value;
                
                if (description) {
                    votingItems.push({
                        topic,
                        description,
                        mover,
                        seconder,
                        votesFor,
                        votesAgainst,
                        abstain,
                        result
                    });
                }
            });
            
            return votingItems;
        }
        
        function createMinutes(e) {
            e.preventDefault();
            
            const attendeeCheckboxes = document.querySelectorAll('input[name="attendees"]:checked');
            const attendees = Array.from(attendeeCheckboxes).map(cb => parseInt(cb.value));
            
            const newMinutes = {
                id: appState.meetingMinutes.length + 1,
                date: document.getElementById('minutesDate').value,
                time: document.getElementById('minutesTime').value,
                type: document.getElementById('minutesType').value,
                venue: document.getElementById('minutesVenue').value,
                attendees: attendees,
                apologies: document.getElementById('minutesApologies').value,
                opening: document.getElementById('minutesOpening').value,
                previousReview: document.getElementById('minutesPreviousReview').value,
                proposer: document.getElementById('minutesProposer').value,
                seconder: document.getElementById('minutesSeconder').value,
                mattersArising: document.getElementById('minutesMattersArising').value,
                financialReport: document.getElementById('minutesFinancialReport').value,
                loans: document.getElementById('minutesLoans').value,
                newBusiness: document.getElementById('minutesNewBusiness').value,
                votingItems: getVotingItems(),
                decisions: document.getElementById('minutesDecisions').value,
                actionItems: document.getElementById('minutesActionItems').value,
                nextMeeting: document.getElementById('minutesNextMeeting').value,
                closing: document.getElementById('minutesClosing').value,
                status: 'draft',
                createdBy: appState.currentUser.name,
                createdDate: new Date().toISOString()
            };
            
            appState.meetingMinutes.push(newMinutes);
            
            showNotification('Meeting minutes saved! You can now publish and share as PDF.', 'success');
            closeModal('newMinutesModal');
            e.target.reset();
            votingItemCounter = 0; // Reset voting counter
            document.getElementById('votingItemsContainer').innerHTML = ''; // Clear voting items
            
            if (document.getElementById('minutes').classList.contains('active')) {
                renderMinutes();
            }
        }
        
        function viewMinutes(minutesId) {
            const minutes = appState.meetingMinutes.find(m => m.id === minutesId);
            if (!minutes) return;
            
            const attendeeNames = minutes.attendees.map(id => {
                const member = appState.members.find(m => m.id === id);
                return member ? member.name : '';
            }).filter(Boolean).join(', ');
            
            const viewWindow = window.open('', '_blank', 'width=900,height=700');
            viewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Meeting Minutes - ${minutes.date}</title>
                    <style>
                        body { font-family: Arial, sans-serif; line-height: 1.8; padding: 40px; max-width: 900px; margin: 0 auto; background: white; color: #333; }
                        h2 { color: #00B4D8; text-align: center; font-size: 24px; margin-bottom: 5px; }
                        h3 { color: #666; text-align: center; font-size: 18px; margin-top: 0; }
                        h4 { color: #00B4D8; margin-top: 25px; margin-bottom: 10px; border-bottom: 2px solid #00B4D8; padding-bottom: 5px; }
                        hr { border: 1px solid #ddd; margin: 30px 0; }
                        p { margin: 10px 0; text-align: justify; }
                        em { color: #666; font-size: 14px; }
                        @media print { body { padding: 20px; } }
                    </style>
                </head>
                <body>
                    <h2>MASONKO STOKVEL-GUPTAS</h2>
                    <h3>MEETING MINUTES</h3>
                    <hr>
                    
                    <p><strong>Date:</strong> ${minutes.date}</p>
                    <p><strong>Time:</strong> ${minutes.time}</p>
                    <p><strong>Type:</strong> ${minutes.type}</p>
                    <p><strong>Venue:</strong> ${minutes.venue}</p>
                    
                    <h4>Attendance</h4>
                    <p><strong>Present:</strong> ${attendeeNames}</p>
                    ${minutes.apologies ? `<p><strong>Apologies:</strong> ${minutes.apologies}</p>` : ''}
                    
                    ${minutes.opening ? `<h4>1. Opening & Welcome</h4><p>${minutes.opening}</p>` : ''}
                    ${minutes.previousReview ? `<h4>2. Previous Minutes Review</h4><p>${minutes.previousReview}</p>` : ''}
                    ${minutes.mattersArising ? `<h4>3. Matters Arising</h4><p>${minutes.mattersArising}</p>` : ''}
                    
                    <h4>4. Financial Report</h4>
                    <p>${minutes.financialReport}</p>
                    
                    ${minutes.loans ? `<h4>5. Loan Applications & Approvals</h4><p>${minutes.loans}</p>` : ''}
                    
                    <h4>6. New Business</h4>
                    <p>${minutes.newBusiness}</p>
                    
                    <h4>7. Decisions & Resolutions</h4>
                    <p>${minutes.decisions}</p>
                    
                    ${minutes.actionItems ? `<h4>8. Action Items</h4><p>${minutes.actionItems}</p>` : ''}
                    ${minutes.nextMeeting ? `<h4>9. Next Meeting</h4><p>${minutes.nextMeeting}</p>` : ''}
                    ${minutes.closing ? `<h4>10. Closing</h4><p>${minutes.closing}</p>` : ''}
                    
                    <hr>
                    <p><em>Minutes prepared by: ${minutes.createdBy}</em></p>
                    <p><em>Date prepared: ${new Date(minutes.createdDate).toLocaleDateString()}</em></p>
                    <p><em>Status: ${minutes.status}</em></p>
                    
                    <div style="margin-top: 40px; text-align: center;">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #00B4D8; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">Print / Save as PDF</button>
                    </div>
                </body>
                </html>
            `);
        }
        
        function downloadMinutesPDF(minutesId) {
            const minutes = appState.meetingMinutes.find(m => m.id === minutesId);
            if (!minutes) return;
            
            const attendeeNames = minutes.attendees.map(id => {
                const member = appState.members.find(m => m.id === id);
                return member ? member.name : '';
            }).filter(Boolean).join(', ');
            
            let pdfContent = `MASONKO STOKVEL-GUPTAS
MEETING MINUTES

Date: ${minutes.date}
Time: ${minutes.time}
Type: ${minutes.type}
Venue: ${minutes.venue}

ATTENDANCE
Present: ${attendeeNames}
${minutes.apologies ? `Apologies: ${minutes.apologies}` : ''}

${minutes.opening ? `1. OPENING & WELCOME\n${minutes.opening}\n\n` : ''}
${minutes.previousReview ? `2. PREVIOUS MINUTES REVIEW\n${minutes.previousReview}\n${minutes.proposer && minutes.seconder ? `\nProposed by: ${appState.members.find(m => m.id == minutes.proposer)?.name || 'N/A'}\nSeconded by: ${appState.members.find(m => m.id == minutes.seconder)?.name || 'N/A'}\n` : ''}\n` : ''}
${minutes.mattersArising ? `3. MATTERS ARISING\n${minutes.mattersArising}\n\n` : ''}

4. FINANCIAL REPORT
${minutes.financialReport}

${minutes.loans ? `5. LOAN APPLICATIONS & APPROVALS\n${minutes.loans}\n\n` : ''}

6. NEW BUSINESS
${minutes.newBusiness}

${minutes.votingItems && minutes.votingItems.length > 0 ? `
7. VOTING & RESOLUTIONS

${minutes.votingItems.map((item, index) => {
    const mover = appState.members.find(m => m.id == item.mover);
    const seconder = appState.members.find(m => m.id == item.seconder);
    const topicLabels = {
        'investment': '💰 Investment Decision',
        'member': '👥 New Member Induction',
        'constitution': '📜 Constitutional Change',
        'loan': '🏦 Loan Approval',
        'tier': '💎 Tier Structure Change',
        'leadership': '👑 Leadership Election',
        'expenditure': '💸 Major Expenditure',
        'other': '📋 Other Motion'
    };
    const topicLabel = topicLabels[item.topic] || item.topic;
    
    return `
Motion ${index + 1}: ${topicLabel}
Description: ${item.description}
${mover ? `Moved by: ${mover.name}` : ''}
${seconder ? `Seconded by: ${seconder.name}` : ''}

Vote Results:
  ✅ For: ${item.votesFor}
  ❌ Against: ${item.votesAgainst}
  ⚪ Abstain: ${item.abstain}
  Total Votes: ${item.votesFor + item.votesAgainst + item.abstain}

Result: ${item.result === 'passed' ? '✅ MOTION PASSED' : item.result === 'failed' ? '❌ MOTION FAILED' : '⏸️ DEFERRED'}
${'─'.repeat(50)}
`;
}).join('\n')}
` : ''}

8. DECISIONS & RESOLUTIONS
${minutes.decisions}

${minutes.actionItems ? `9. ACTION ITEMS\n${minutes.actionItems}\n\n` : ''}
${minutes.nextMeeting ? `10. NEXT MEETING\n${minutes.nextMeeting}\n\n` : ''}
${minutes.closing ? `11. CLOSING\n${minutes.closing}\n\n` : ''}

---
Minutes prepared by: ${minutes.createdBy}
Date prepared: ${new Date(minutes.createdDate).toLocaleDateString()}
Status: ${minutes.status}
`;
            
            const blob = new Blob([pdfContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Meeting_Minutes_${minutes.date}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('Meeting minutes downloaded! Share this file with members.', 'success');
        }
        
        function publishMinutes(minutesId) {
            if (confirm('Publish these minutes? They will be marked as final and shared with all members.')) {
                const minutes = appState.meetingMinutes.find(m => m.id === minutesId);
                if (minutes) {
                    minutes.status = 'published';
                    minutes.publishedDate = new Date().toISOString();
                    
                    const notification = {
                        id: appState.notifications.length + 1,
                        type: 'minutes',
                        title: 'New Meeting Minutes',
                        message: `Minutes from ${minutes.type} on ${minutes.date} have been published`,
                        time: 'Just now',
                        unread: true
                    };
                    appState.notifications.unshift(notification);
                    
                    renderMinutes();
                    showNotification('Minutes published and shared with all members!', 'success');
                }
            }
        }
    </script>
</body>
</html>
