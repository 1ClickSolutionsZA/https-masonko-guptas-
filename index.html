<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masonko Stokvel-Guptas - Investment Club Management</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTWFzb25rbyBTdG9rdmVsLUd1cHRhcyIsInNob3J0X25hbWUiOiJNYXNvbmtvIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwQTFBMkEiLCJ0aGVtZV9jb2xvciI6IiMwQTFBMkEifQ==">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Urbanist:wght@300;400;500;600;700;800;900&family=DM+Serif+Display:ital@0;1&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #0A1A2A;
            --secondary: #1A3A4A;
            --accent: #00D9B4;
            --accent-dark: #00B396;
            --gold: #FFB800;
            --danger: #FF4757;
            --success: #2ECC71;
            --text: #E8F4F8;
            --text-muted: #8BA5B5;
            --border: rgba(255, 255, 255, 0.1);
            --card-bg: rgba(26, 58, 74, 0.6);
            --shadow: rgba(0, 0, 0, 0.3);
        }
        
        body {
            font-family: 'Urbanist', sans-serif;
            background: linear-gradient(135deg, #0A1A2A 0%, #1A3A4A 50%, #0A2A3A 100%);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(0, 217, 180, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 184, 0, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        /* Login/Auth Screen */
        .auth-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .auth-container {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            max-width: 450px;
            width: 100%;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px var(--shadow);
            animation: slideUp 0.6s ease-out;
        }
        
        .auth-logo {
            font-family: 'DM Serif Display', serif;
            font-size: 36px;
            font-style: italic;
            text-align: center;
            background: linear-gradient(135deg, var(--accent), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        
        .auth-subtitle {
            text-align: center;
            color: var(--text-muted);
            margin-bottom: 35px;
            font-size: 14px;
        }
        
        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.2);
            padding: 5px;
            border-radius: 12px;
        }
        
        .auth-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-family: 'Urbanist', sans-serif;
        }
        
        .auth-tab.active {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: var(--primary);
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }
        
        .auth-link {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: var(--text-muted);
        }
        
        .auth-link a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }
        
        .auth-link a:hover {
            text-decoration: underline;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Password Toggle */
        .password-wrapper {
            position: relative;
        }
        
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 20px;
            color: var(--text-muted);
            user-select: none;
            transition: color 0.3s ease;
        }
        
        .password-toggle:hover {
            color: var(--accent);
        }
        
        .password-wrapper input {
            padding-right: 45px;
        }
        
        /* Password Strength Indicator */
        .password-requirements {
            margin-top: 10px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-size: 12px;
            border-left: 3px solid var(--text-muted);
        }
        
        .password-requirements.show {
            display: block;
        }
        
        .requirement {
            display: flex;
            align-items: center;
            margin: 5px 0;
            color: var(--text-muted);
            transition: all 0.3s ease;
        }
        
        .requirement.met {
            color: var(--success);
        }
        
        .requirement.met::before {
            content: '‚úì ';
            color: var(--success);
            font-weight: bold;
            margin-right: 5px;
        }
        
        .requirement:not(.met)::before {
            content: '‚úó ';
            color: var(--danger);
            font-weight: bold;
            margin-right: 5px;
        }
        
        .password-strength {
            margin-top: 8px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .password-strength-bar {
            height: 100%;
            transition: all 0.3s ease;
            border-radius: 2px;
        }
        
        .password-strength-bar.weak {
            width: 33%;
            background: var(--danger);
        }
        
        .password-strength-bar.medium {
            width: 66%;
            background: var(--gold);
        }
        
        .password-strength-bar.strong {
            width: 100%;
            background: var(--success);
        }
        
        .logout-btn {
            background: rgba(255, 71, 87, 0.2);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: 'Urbanist', sans-serif;
        }
        
        .logout-btn:hover {
            background: var(--danger);
            color: white;
        }
        
        .app-container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        header {
            background: rgba(10, 26, 42, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 40px var(--shadow);
            border: 1px solid var(--border);
            animation: slideDown 0.6s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .logo {
            font-family: 'DM Serif Display', serif;
            font-size: 32px;
            font-weight: 400;
            font-style: italic;
            background: linear-gradient(135deg, var(--accent), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .role-badge {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(0, 217, 180, 0.3);
        }
        
        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gold), #FFA500);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            color: var(--primary);
            box-shadow: 0 4px 15px rgba(255, 184, 0, 0.3);
        }
        
        /* Navigation */
        nav {
            background: rgba(10, 26, 42, 0.6);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 30px;
            display: flex;
            gap: 10px;
            overflow-x: auto;
            scrollbar-width: none;
            border: 1px solid var(--border);
            animation: fadeIn 0.8s ease-out 0.2s both;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        nav::-webkit-scrollbar {
            display: none;
        }
        
        .nav-btn {
            background: transparent;
            border: 2px solid transparent;
            color: var(--text-muted);
            padding: 12px 24px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-family: 'Urbanist', sans-serif;
        }
        
        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
            border-color: var(--border);
        }
        
        .nav-btn.active {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: var(--primary);
            border-color: var(--accent);
            box-shadow: 0 4px 20px rgba(0, 217, 180, 0.4);
        }
        
        /* Dashboard Cards */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            animation: fadeIn 0.8s ease-out 0.4s both;
        }
        
        .stat-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px var(--shadow);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), var(--gold));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px var(--shadow);
            border-color: var(--accent);
        }
        
        .stat-card:hover::before {
            opacity: 1;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--text), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }
        
        .stat-change {
            font-size: 13px;
            font-weight: 600;
        }
        
        .stat-change.positive {
            color: var(--success);
        }
        
        .stat-change.negative {
            color: var(--danger);
        }
        
        /* Main Content Area */
        .content-area {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 40px var(--shadow);
            min-height: 500px;
            animation: fadeIn 0.8s ease-out 0.6s both;
        }
        
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
            animation: viewFadeIn 0.5s ease-out;
        }
        
        @keyframes viewFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        h2 {
            font-family: 'DM Serif Display', serif;
            font-size: 32px;
            font-style: italic;
            margin-bottom: 25px;
            background: linear-gradient(135deg, var(--text), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 14px 18px;
            background: rgba(10, 26, 42, 0.6);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 15px;
            font-family: 'Urbanist', sans-serif;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(0, 217, 180, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Urbanist', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn span {
            position: relative;
            z-index: 1;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: var(--primary);
            box-shadow: 0 6px 20px rgba(0, 217, 180, 0.4);
        }
        
        .btn-primary:hover {
            box-shadow: 0 8px 30px rgba(0, 217, 180, 0.6);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            border: 2px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--accent);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #E63946);
            color: white;
            box-shadow: 0 6px 20px rgba(255, 71, 87, 0.4);
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: rgba(0, 217, 180, 0.1);
        }
        
        th {
            padding: 16px;
            text-align: left;
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--accent);
            border-bottom: 2px solid var(--border);
        }
        
        td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        /* Member Cards */
        .member-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .member-card {
            background: rgba(10, 26, 42, 0.6);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .member-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px var(--shadow);
            border-color: var(--accent);
        }
        
        .member-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .member-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gold), #FFA500);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 24px;
            color: var(--primary);
        }
        
        .member-info h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .member-role {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .member-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }
        
        .member-stat {
            text-align: center;
        }
        
        .member-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .member-stat-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent);
            margin-top: 5px;
        }
        
        /* Chat Interface */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 600px;
            background: rgba(10, 26, 42, 0.4);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .chat-message {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 18px;
            animation: messageSlide 0.3s ease-out;
        }
        
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chat-message.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: var(--primary);
            border-bottom-right-radius: 4px;
        }
        
        .chat-message.received {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            border-bottom-left-radius: 4px;
        }
        
        .message-author {
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 5px;
            opacity: 0.8;
        }
        
        .message-time {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 5px;
        }
        
        .chat-input-area {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid var(--border);
        }
        
        .chat-input {
            flex: 1;
        }
        
        /* Notifications */
        .notification-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .notification {
            background: rgba(10, 26, 42, 0.6);
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            animation: notificationSlide 0.4s ease-out;
        }
        
        @keyframes notificationSlide {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .notification:hover {
            background: rgba(10, 26, 42, 0.8);
            border-left-width: 6px;
        }
        
        .notification.unread {
            border-left-color: var(--gold);
            background: rgba(255, 184, 0, 0.05);
        }
        
        .notification-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 700;
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .notification-message {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .notification-time {
            font-size: 12px;
            color: var(--text-muted);
            opacity: 0.7;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease-out;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--secondary);
            border-radius: 20px;
            padding: 35px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px var(--shadow);
            animation: modalSlideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .modal-title {
            font-family: 'DM Serif Display', serif;
            font-size: 28px;
            font-style: italic;
            background: linear-gradient(135deg, var(--text), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 32px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-modal:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            transform: rotate(90deg);
        }
        
        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            justify-content: flex-end;
        }
        
        /* Loading State */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* Offline Indicator */
        .offline-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--danger);
            color: white;
            padding: 12px 20px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 6px 20px rgba(255, 71, 87, 0.4);
            display: none;
            z-index: 100;
            animation: slideUp 0.4s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .offline-indicator.show {
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                padding: 15px;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .logo {
                font-size: 28px;
            }
            
            nav {
                flex-wrap: nowrap;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .content-area {
                padding: 20px;
            }
            
            h2 {
                font-size: 26px;
            }
            
            .modal-content {
                padding: 25px;
            }
            
            .member-grid {
                grid-template-columns: 1fr;
            }
            
            .chat-message {
                max-width: 85%;
            }
        }
        
        /* AI Insights */
        .ai-insight {
            background: linear-gradient(135deg, rgba(0, 217, 180, 0.1), rgba(255, 184, 0, 0.1));
            border: 2px solid var(--accent);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }
        
        .ai-insight::before {
            content: '‚ú®';
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 32px;
            opacity: 0.3;
        }
        
        .ai-insight-title {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 10px;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .ai-insight-content {
            color: var(--text);
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-container">
            <div class="auth-logo">Masonko Stokvel-Guptas</div>
            <div class="auth-subtitle">Investment Club Management System</div>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
            </div>
            
            <!-- Login Form -->
            <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Email or Phone Number</label>
                    <input type="text" id="loginIdentifier" required placeholder="Enter your email or phone">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="loginPassword" required placeholder="Enter your password">
                        <span class="password-toggle" onclick="togglePassword('loginPassword', this)">üëÅÔ∏è</span>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">
                    <span>Login</span>
                </button>
                <div class="auth-link">
                    <a onclick="showForgotPassword()">Forgot password?</a>
                </div>
            </form>
            
            <!-- Registration Form -->
            <form class="auth-form" id="registerForm" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="regName" required placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="regEmail" required placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="regPhone" required placeholder="08X XXX XXXX">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="regPassword" required placeholder="Create a strong password" minlength="8" oninput="checkPasswordStrength(this.value)">
                        <span class="password-toggle" onclick="togglePassword('regPassword', this)">üëÅÔ∏è</span>
                    </div>
                    <div class="password-requirements">
                        <div style="font-weight: 600; margin-bottom: 8px; color: var(--accent);">Password must contain:</div>
                        <div class="requirement" id="req-length">At least 8 characters</div>
                        <div class="requirement" id="req-uppercase">At least one uppercase letter (A-Z)</div>
                        <div class="requirement" id="req-lowercase">At least one lowercase letter (a-z)</div>
                        <div class="requirement" id="req-number">At least one number (0-9)</div>
                        <div class="requirement" id="req-symbol">At least one symbol (!@#$%^&*)</div>
                        <div class="password-strength">
                            <div class="password-strength-bar" id="strength-bar"></div>
                        </div>
                        <div style="margin-top: 8px; font-size: 11px; text-align: center;">
                            <span id="strength-text" style="font-weight: 600;"></span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="regConfirmPassword" required placeholder="Confirm your password" oninput="checkPasswordMatch()">
                        <span class="password-toggle" onclick="togglePassword('regConfirmPassword', this)">üëÅÔ∏è</span>
                    </div>
                    <div id="password-match-message" style="margin-top: 5px; font-size: 13px;"></div>
                </div>
                <div class="form-group">
                    <label>Membership Tier</label>
                    <select id="regTier" required onchange="updateRegTierInfo()">
                        <option value="">Select Your Tier</option>
                        <option value="1">Tier 1 - R1,000 (1 Share) - R100/week</option>
                        <option value="2">Tier 2 - R2,000 (2 Shares) - R200/week</option>
                        <option value="3">Tier 3 - R3,000 (3 Shares) - R300/week</option>
                    </select>
                    <div id="regTierInfo" style="margin-top: 10px; padding: 10px; background: rgba(0, 217, 180, 0.1); border-radius: 8px; display: none; font-size: 13px;">
                        <strong>Initial Investment:</strong> <span id="regTierInvestment"></span><br>
                        <strong>Shares:</strong> <span id="regTierShares"></span><br>
                        <strong>Weekly Subscription:</strong> <span id="regTierSubscription"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="regTerms" required style="width: auto; margin-right: 8px;">
                        I agree to the terms and conditions
                    </label>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">
                    <span>Create Account</span>
                </button>
                <div class="auth-link" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
                    <small>Registration requires approval from the Admin or Treasurer</small>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Main Application (hidden until logged in) -->
    <div class="app-container hidden" id="mainApp">
        <header>
            <div class="logo">Masonko Stokvel-Guptas</div>
            <div class="user-info">
                <span class="role-badge" id="userRoleBadge">Admin</span>
                <div class="user-avatar" id="userAvatar">TS</div>
                <button class="logout-btn" onclick="handleLogout()">Logout</button>
            </div>
        </header>
        
        <nav>
            <button class="nav-btn active" data-view="dashboard">Dashboard</button>
            <button class="nav-btn" data-view="members">Members</button>
            <button class="nav-btn" data-view="contributions">Contributions</button>
            <button class="nav-btn" data-view="loans">Loans</button>
            <button class="nav-btn" data-view="reports">Reports</button>
            <button class="nav-btn" data-view="chat">Chat</button>
            <button class="nav-btn" data-view="notifications">Notifications</button>
            <button class="nav-btn" data-view="settings">Settings</button>
        </nav>
        
        <div class="dashboard" id="statsCards">
            <div class="stat-card">
                <div class="stat-label">Total Pool Value</div>
                <div class="stat-value">R 315,900</div>
                <div class="stat-change positive">+15.2% this month</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Members</div>
                <div class="stat-value">8</div>
                <div class="stat-change">17 Total Shares</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Weekly Subscriptions</div>
                <div class="stat-value">R 1,600</div>
                <div class="stat-change positive">75% paid this week</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Outstanding Payments</div>
                <div class="stat-value">2</div>
                <div class="stat-change">R 400 + R 100 fines due</div>
            </div>
        </div>
        
        <div class="content-area">
            <!-- Dashboard View -->
            <div id="dashboard" class="view active">
                <h2>Investment Overview</h2>
                
                <div class="ai-insight">
                    <div class="ai-insight-title">AI Investment Insight</div>
                    <div class="ai-insight-content">
                        Based on current weekly subscription trends (R 1,600/week) and 17 total shares, your stokveld is on track to accumulate R 83,200 annually in subscriptions alone. With current growth trajectory and reinvestment strategy, projected pool value by Q4 2026: R 420,000. Recommendation: 2 members have late payments - automated reminders sent with R 50 fine notices.
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px; color: var(--accent);">Recent Activity</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Member</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivityTable">
                                <tr>
                                    <td>2026-01-13</td>
                                    <td>Admin User</td>
                                    <td>Contribution</td>
                                    <td>R 800</td>
                                    <td><span style="color: var(--success);">‚úì Confirmed</span></td>
                                </tr>
                                <tr>
                                    <td>2026-01-12</td>
                                    <td>Member 6</td>
                                    <td>Contribution</td>
                                    <td>R 800</td>
                                    <td><span style="color: var(--success);">‚úì Confirmed</span></td>
                                </tr>
                                <tr>
                                    <td>2026-01-11</td>
                                    <td>Loan Officer User</td>
                                    <td>Loan Payment</td>
                                    <td>R 2,500</td>
                                    <td><span style="color: var(--success);">‚úì Confirmed</span></td>
                                </tr>
                                <tr>
                                    <td>2026-01-10</td>
                                    <td>Member 4</td>
                                    <td>Contribution</td>
                                    <td>R 800</td>
                                    <td><span style="color: var(--gold);">‚è≥ Pending</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Members View -->
            <div id="members" class="view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Members</h2>
                    <button class="btn btn-primary" onclick="openModal('addMemberModal')"><span>+ Add Member</span></button>
                </div>
                
                <!-- Pending Approvals Section (Admin/Treasurer only) -->
                <div id="pendingApprovalsSection" style="display: none;">
                    <h3 style="margin-bottom: 15px; color: var(--gold);">‚è≥ Pending Approvals</h3>
                    <div class="ai-insight" style="background: linear-gradient(135deg, rgba(255, 184, 0, 0.1), rgba(255, 71, 87, 0.1)); border-color: var(--gold); margin-bottom: 30px;">
                        <div class="ai-insight-title">Action Required</div>
                        <div class="ai-insight-content" id="pendingCount">
                            0 new member applications awaiting your approval.
                        </div>
                    </div>
                    <div id="pendingMembersList" style="margin-bottom: 30px;">
                        <!-- Pending members will be shown here -->
                    </div>
                </div>
                
                <h3 style="margin-bottom: 15px; color: var(--accent);">Active Members</h3>
                <div class="member-grid" id="memberGrid">
                    <!-- Members will be populated here -->
                </div>
            </div>
            
            <!-- Contributions View -->
            <div id="contributions" class="view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h2>Contributions</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="openModal('submitPaymentModal')"><span>üì§ Submit My Payment</span></button>
                        <button class="btn btn-primary" onclick="openModal('recordContributionModal')" id="recordPaymentBtn"><span>+ Record Payment</span></button>
                    </div>
                </div>
                
                <!-- Pending Payments Review (Treasurer/Admin only) -->
                <div id="pendingPaymentsSection" style="display: none; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px; color: var(--gold);">üìã Pending Payment Submissions</h3>
                    <div class="ai-insight" style="background: linear-gradient(135deg, rgba(255, 184, 0, 0.1), rgba(0, 217, 180, 0.1)); border-color: var(--gold);">
                        <div class="ai-insight-title">Payments Awaiting Verification</div>
                        <div class="ai-insight-content" id="pendingPaymentsCount">
                            0 payment submissions awaiting your verification.
                        </div>
                    </div>
                    <div id="pendingPaymentsList" style="margin-top: 15px;">
                        <!-- Pending payments will be shown here -->
                    </div>
                </div>
                
                <div class="ai-insight">
                    <div class="ai-insight-title">Weekly Payment Status</div>
                    <div class="ai-insight-content">
                        2 members have overdue payments from last week. Total outstanding: R 400 (subscriptions) + R 100 (late fees) = R 500. Automated SMS and WhatsApp reminders sent. Collection rate for current members: 75%. Expected weekly collection: R 1,600.
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Member</th>
                                <th>Due Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="contributionsTable">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Loans View -->
            <div id="loans" class="view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Loans</h2>
                    <button class="btn btn-primary" onclick="openModal('newLoanModal')"><span>+ New Loan</span></button>
                </div>
                
                <div class="ai-insight">
                    <div class="ai-insight-title">Loan Portfolio Health</div>
                    <div class="ai-insight-content">
                        Current loan portfolio is performing well with 100% on-time payment rate. Based on club liquidity, you can safely approve loans up to R 15,000 without affecting monthly operations.
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Member</th>
                                <th>Amount</th>
                                <th>Term</th>
                                <th>Interest</th>
                                <th>Status</th>
                                <th>Next Payment</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="loansTable">
                            <!-- Will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Reports View -->
            <div id="reports" class="view">
                <h2>Financial Reports</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                    <button class="btn btn-secondary" onclick="generateReport('monthly')"><span>Monthly Report</span></button>
                    <button class="btn btn-secondary" onclick="generateReport('quarterly')"><span>Quarterly Report</span></button>
                    <button class="btn btn-secondary" onclick="generateReport('annual')"><span>Annual Report</span></button>
                    <button class="btn btn-secondary" onclick="generateReport('custom')"><span>Custom Report</span></button>
                </div>
                
                <div class="ai-insight">
                    <div class="ai-insight-title">AI-Generated Financial Summary</div>
                    <div class="ai-insight-content" id="aiReportSummary">
                        Click on any report button above to generate an AI-powered financial analysis with insights and recommendations.
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px; color: var(--accent);">Report History</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Report Type</th>
                                    <th>Period</th>
                                    <th>Generated</th>
                                    <th>Generated By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reportHistoryTable">
                                <tr>
                                    <td>Monthly Report</td>
                                    <td>December 2025</td>
                                    <td>2026-01-05</td>
                                    <td>Treasurer</td>
                                    <td><button class="btn btn-secondary" style="padding: 8px 16px;"><span>Download</span></button></td>
                                </tr>
                                <tr>
                                    <td>Quarterly Report</td>
                                    <td>Q4 2025</td>
                                    <td>2026-01-02</td>
                                    <td>Admin</td>
                                    <td><button class="btn btn-secondary" style="padding: 8px 16px;"><span>Download</span></button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Chat View -->
            <div id="chat" class="view">
                <h2>Group Chat</h2>
                
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <!-- Messages will be populated here -->
                    </div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
                        <button class="btn btn-primary" onclick="sendMessage()"><span>Send</span></button>
                    </div>
                </div>
            </div>
            
            <!-- Notifications View -->
            <div id="notifications" class="view">
                <h2>Notifications</h2>
                
                <div class="notification-list" id="notificationList">
                    <!-- Notifications will be populated here -->
                </div>
            </div>
            
            <div id="settings" class="view">
                <h2>Settings</h2>
                
                <div style="max-width: 600px;">
                    <h3 style="margin-bottom: 20px; color: var(--accent); font-size: 18px;">Membership Tiers</h3>
                    
                    <div style="background: rgba(10, 26, 42, 0.6); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: var(--accent); margin-bottom: 15px;">Tier 1</h4>
                        <div class="form-group">
                            <label>Initial Investment</label>
                            <input type="number" value="1000" id="tier1Investment">
                        </div>
                        <div class="form-group">
                            <label>Shares</label>
                            <input type="number" value="1" id="tier1Shares" readonly style="background: rgba(0, 217, 180, 0.1);">
                        </div>
                        <div class="form-group">
                            <label>Weekly Subscription</label>
                            <input type="number" value="100" id="tier1Subscription">
                        </div>
                    </div>
                    
                    <div style="background: rgba(10, 26, 42, 0.6); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: var(--accent); margin-bottom: 15px;">Tier 2</h4>
                        <div class="form-group">
                            <label>Initial Investment</label>
                            <input type="number" value="2000" id="tier2Investment">
                        </div>
                        <div class="form-group">
                            <label>Shares</label>
                            <input type="number" value="2" id="tier2Shares" readonly style="background: rgba(0, 217, 180, 0.1);">
                        </div>
                        <div class="form-group">
                            <label>Weekly Subscription</label>
                            <input type="number" value="200" id="tier2Subscription">
                        </div>
                    </div>
                    
                    <div style="background: rgba(10, 26, 42, 0.6); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <h4 style="color: var(--accent); margin-bottom: 15px;">Tier 3</h4>
                        <div class="form-group">
                            <label>Initial Investment</label>
                            <input type="number" value="3000" id="tier3Investment">
                        </div>
                        <div class="form-group">
                            <label>Shares</label>
                            <input type="number" value="3" id="tier3Shares" readonly style="background: rgba(0, 217, 180, 0.1);">
                        </div>
                        <div class="form-group">
                            <label>Weekly Subscription</label>
                            <input type="number" value="300" id="tier3Subscription">
                        </div>
                    </div>
                    
                    <h3 style="margin: 30px 0 20px; color: var(--accent); font-size: 18px;">General Settings</h3>
                    
                    <div class="form-group">
                        <label>Club Name</label>
                        <input type="text" value="Masonko Stokvel-Guptas" id="clubName">
                    </div>
                    
                    <div class="form-group">
                        <label>Payment Due Day</label>
                        <select id="paymentDueDay">
                            <option value="1" selected>Monday</option>
                            <option value="2">Tuesday</option>
                            <option value="3">Wednesday</option>
                            <option value="4">Thursday</option>
                            <option value="5">Friday</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Late Payment Fee</label>
                        <input type="number" value="50" id="lateFee">
                    </div>
                    
                    <div class="form-group">
                        <label>Loan Interest Rate (%)</label>
                        <input type="number" value="10" step="0.5" id="loanInterestRate">
                    </div>
                    
                    <div class="form-group">
                        <label>Enable SMS Notifications</label>
                        <select id="smsNotifications">
                            <option value="yes" selected>Yes</option>
                            <option value="no">No</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Enable WhatsApp Notifications</label>
                        <select id="whatsappNotifications">
                            <option value="yes" selected>Yes</option>
                            <option value="no">No</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Enable AI Insights</label>
                        <select id="aiInsights">
                            <option value="yes" selected>Yes</option>
                            <option value="no">No</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveSettings()"><span>Save Settings</span></button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div class="modal" id="addMemberModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add New Member</div>
                <button class="close-modal" onclick="closeModal('addMemberModal')">√ó</button>
            </div>
            <form onsubmit="addMember(event)">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" required id="memberName">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" required id="memberEmail">
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" required id="memberPhone">
                </div>
                <div class="form-group">
                    <label>Membership Tier</label>
                    <select id="memberTier" required onchange="updateTierInfo()">
                        <option value="">Select Tier</option>
                        <option value="1">Tier 1 - R1,000 (1 Share) - R100/week</option>
                        <option value="2">Tier 2 - R2,000 (2 Shares) - R200/week</option>
                        <option value="3">Tier 3 - R3,000 (3 Shares) - R300/week</option>
                    </select>
                    <div id="tierInfo" style="margin-top: 10px; padding: 10px; background: rgba(0, 217, 180, 0.1); border-radius: 8px; display: none; font-size: 13px;">
                        <strong>Initial Investment:</strong> <span id="tierInvestment"></span><br>
                        <strong>Shares:</strong> <span id="tierShares"></span><br>
                        <strong>Weekly Subscription:</strong> <span id="tierSubscription"></span><br>
                        <strong>Late Fee:</strong> R 50 per week
                    </div>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="memberRole">
                        <option value="member">Regular Member</option>
                        <option value="admin">Admin</option>
                        <option value="vice-chair">Vice Chairperson</option>
                        <option value="treasurer">Treasurer</option>
                        <option value="loan-officer">Loan Officer</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addMemberModal')"><span>Cancel</span></button>
                    <button type="submit" class="btn btn-primary"><span>Add Member</span></button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="modal" id="recordContributionModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Record Contribution</div>
                <button class="close-modal" onclick="closeModal('recordContributionModal')">√ó</button>
            </div>
            <form onsubmit="recordContribution(event)">
                <div class="form-group">
                    <label>Member</label>
                    <select id="contributionMember" required onchange="updateContributionAmount()">
                        <option value="">Select Member</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Amount Due</label>
                    <input type="number" required id="contributionAmount2" readonly style="background: rgba(0, 217, 180, 0.1);">
                    <div id="contributionBreakdown" style="margin-top: 8px; font-size: 13px; color: var(--text-muted);"></div>
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="paymentMethod">
                        <option value="eft">EFT</option>
                        <option value="cash">Cash</option>
                        <option value="card">Card</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Reference/Proof</label>
                    <input type="text" id="paymentReference" placeholder="Enter payment reference number">
                </div>
                
                <!-- Camera/Upload Section -->
                <div class="form-group">
                    <label>Proof of Payment (Deposit Slip)</label>
                    <div style="margin-bottom: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="openCamera()" style="margin-right: 10px;">
                            <span>üì∑ Take Photo</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('fileUpload').click()">
                            <span>üìÅ Upload File</span>
                        </button>
                    </div>
                    <input type="file" id="fileUpload" accept="image/*" style="display: none;" onchange="handleFileUpload(event)">
                    <input type="file" id="cameraCapture" accept="image/*" capture="environment" style="display: none;" onchange="handleCameraCapture(event)">
                    
                    <!-- Preview Area -->
                    <div id="proofPreview" style="display: none; margin-top: 15px;">
                        <div style="position: relative; border: 2px solid var(--accent); border-radius: 12px; padding: 10px; background: rgba(0, 0, 0, 0.3);">
                            <button type="button" onclick="removeProof()" style="position: absolute; top: 5px; right: 5px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-weight: bold;">√ó</button>
                            <img id="proofImage" style="width: 100%; max-height: 300px; object-fit: contain; border-radius: 8px;">
                            <div style="margin-top: 10px; font-size: 13px; color: var(--text-muted);" id="proofFileName"></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="applyLateFee" onchange="updateContributionAmount()" style="width: auto; margin-right: 8px;">
                        Apply Late Payment Fine (R 50)
                    </label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('recordContributionModal')"><span>Cancel</span></button>
                    <button type="submit" class="btn btn-primary"><span>Record Payment</span></button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="modal" id="newLoanModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">Masonko Loan Application Form</div>
                <button class="close-modal" onclick="closeModal('newLoanModal')">√ó</button>
            </div>
            <form onsubmit="createLoan(event)">
                <!-- Loan Reference Numbers -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; padding: 15px; background: rgba(0, 217, 180, 0.1); border-radius: 8px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Loan Cycle No</label>
                        <input type="text" id="loanCycleNo" readonly value="2026-01">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Loan No</label>
                        <input type="text" id="loanNo" readonly value="AUTO">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Masonko Registration No</label>
                        <input type="text" id="regNo" readonly>
                    </div>
                </div>
                
                <h3 style="color: var(--accent); margin: 20px 0 15px; font-size: 16px;">Personal Information</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Applicant (Member)</label>
                        <select id="loanMember" required onchange="populateMemberInfo()">
                            <option value="">Select Member</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>First Names</label>
                        <input type="text" id="loanFirstNames" readonly>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Type of Identification</label>
                        <select id="idType">
                            <option value="SA ID">SA ID</option>
                            <option value="Passport">Passport</option>
                            <option value="Driver's License">Driver's License</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Identification No</label>
                        <input type="text" id="idNumber" required>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Personal Cell Phone No</label>
                        <input type="tel" id="loanPhone" readonly>
                    </div>
                    <div class="form-group">
                        <label>Alternative Tel No</label>
                        <input type="tel" id="altPhone">
                    </div>
                </div>
                
                <h3 style="color: var(--accent); margin: 20px 0 15px; font-size: 16px;">Residential Address</h3>
                
                <div class="form-group">
                    <label>Stand/House Number & Street</label>
                    <input type="text" id="residentialAddress" required>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 100px 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="resLocation">
                    </div>
                    <div class="form-group">
                        <label>Suburb/Township</label>
                        <input type="text" id="resSuburb">
                    </div>
                    <div class="form-group">
                        <label>Area Code</label>
                        <input type="text" id="resAreaCode">
                    </div>
                    <div class="form-group">
                        <label>Province</label>
                        <select id="resProvince">
                            <option value="Gauteng">Gauteng</option>
                            <option value="Western Cape">Western Cape</option>
                            <option value="KwaZulu-Natal">KwaZulu-Natal</option>
                            <option value="Eastern Cape">Eastern Cape</option>
                            <option value="Free State">Free State</option>
                            <option value="Limpopo">Limpopo</option>
                            <option value="Mpumalanga">Mpumalanga</option>
                            <option value="Northern Cape">Northern Cape</option>
                            <option value="North West">North West</option>
                        </select>
                    </div>
                </div>
                
                <h3 style="color: var(--accent); margin: 20px 0 15px; font-size: 16px;">Business Address (If Applicable)</h3>
                
                <div class="form-group">
                    <label>Business Address & Street</label>
                    <input type="text" id="businessAddress">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 100px 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="bizLocation">
                    </div>
                    <div class="form-group">
                        <label>Suburb/Township</label>
                        <input type="text" id="bizSuburb">
                    </div>
                    <div class="form-group">
                        <label>Area Code</label>
                        <input type="text" id="bizAreaCode">
                    </div>
                    <div class="form-group">
                        <label>Province</label>
                        <select id="bizProvince">
                            <option value="">N/A</option>
                            <option value="Gauteng">Gauteng</option>
                            <option value="Western Cape">Western Cape</option>
                            <option value="KwaZulu-Natal">KwaZulu-Natal</option>
                            <option value="Eastern Cape">Eastern Cape</option>
                            <option value="Free State">Free State</option>
                            <option value="Limpopo">Limpopo</option>
                            <option value="Mpumalanga">Mpumalanga</option>
                            <option value="Northern Cape">Northern Cape</option>
                            <option value="North West">North West</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Business Telephone No</label>
                        <input type="tel" id="bizPhone">
                    </div>
                    <div class="form-group">
                        <label>Email (If Any)</label>
                        <input type="email" id="loanEmail" readonly>
                    </div>
                </div>
                
                <h3 style="color: var(--accent); margin: 20px 0 15px; font-size: 16px;">Loan Details</h3>
                
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                    <div class="form-group">
                        <label>Loan Desired (Amount)</label>
                        <input type="number" id="loanAmount" required min="100" step="100" onchange="calculateLoanDetails()">
                    </div>
                    <div class="form-group">
                        <label>Duration (Weeks)</label>
                        <input type="number" id="loanDurationWeeks" required min="1" max="52" value="24" onchange="calculateLoanDetails()">
                    </div>
                    <div class="form-group">
                        <label>Est Interest</label>
                        <input type="number" id="loanInterestCalc" readonly style="background: rgba(0, 217, 180, 0.1);">
                    </div>
                    <div class="form-group">
                        <label>Total P&I</label>
                        <input type="number" id="loanTotalPI" readonly style="background: rgba(0, 217, 180, 0.1);">
                    </div>
                </div>
                
                <h3 style="color: var(--accent); margin: 20px 0 15px; font-size: 16px;">Member's Shares & Savings</h3>
                
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                    <div class="form-group">
                        <label>No of Shares</label>
                        <input type="number" id="memberShares" readonly style="background: rgba(0, 217, 180, 0.1);">
                    </div>
                    <div class="form-group">
                        <label>Total Share Value</label>
                        <input type="number" id="shareValue" readonly style="background: rgba(0, 217, 180, 0.1);">
                    </div>
                    <div class="form-group">
                        <label>Savings</label>
                        <input type="number" id="memberSavings" readonly style="background: rgba(0, 217, 180, 0.1);">
                    </div>
                    <div class="form-group">
                        <label>By Date</label>
                        <input type="date" id="savingsDate" readonly style="background: rgba(0, 217, 180, 0.1);">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Total Shares + Savings</label>
                        <input type="number" id="totalSharesSavings" readonly style="background: rgba(0, 217, 180, 0.1);">
                    </div>
                    <div class="form-group">
                        <label>P&I Amount to be Guaranteed</label>
                        <input type="number" id="guaranteeAmount" readonly style="background: rgba(0, 217, 180, 0.1);">
                    </div>
                </div>
                
                <h3 style="color: var(--accent); margin: 20px 0 15px; font-size: 16px;">Type of Guarantee</h3>
                
                <div class="form-group">
                    <label>Tangible Collateral (Optional)</label>
                    <input type="text" id="collateralType" placeholder="e.g., Vehicle, Property, Equipment">
                </div>
                
                <div class="form-group">
                    <label>Estimated Value of Collateral</label>
                    <input type="number" id="collateralValue" min="0">
                </div>
                
                <h3 style="color: var(--accent); margin: 20px 0 15px; font-size: 16px;">Member Guarantors</h3>
                <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 15px;">
                    The following Masonko members guarantee this loan with their shares and savings (up to 5 guarantors):
                </p>
                
                <div id="guarantorsSection">
                    <div style="margin-bottom: 10px; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 150px; gap: 10px; align-items: end;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Guarantor 1</label>
                                <select id="guarantor1" onchange="updateGuarantorValue(1)">
                                    <option value="">Select Member</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Shares/Savings (R)</label>
                                <input type="number" id="guarantor1Value" readonly style="background: rgba(0, 217, 180, 0.1);">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 10px; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 150px; gap: 10px; align-items: end;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Guarantor 2 (Optional)</label>
                                <select id="guarantor2" onchange="updateGuarantorValue(2)">
                                    <option value="">Select Member</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Shares/Savings (R)</label>
                                <input type="number" id="guarantor2Value" readonly style="background: rgba(0, 217, 180, 0.1);">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 10px; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 150px; gap: 10px; align-items: end;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Guarantor 3 (Optional)</label>
                                <select id="guarantor3" onchange="updateGuarantorValue(3)">
                                    <option value="">Select Member</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Shares/Savings (R)</label>
                                <input type="number" id="guarantor3Value" readonly style="background: rgba(0, 217, 180, 0.1);">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 10px; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 150px; gap: 10px; align-items: end;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Guarantor 4 (Optional)</label>
                                <select id="guarantor4" onchange="updateGuarantorValue(4)">
                                    <option value="">Select Member</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Shares/Savings (R)</label>
                                <input type="number" id="guarantor4Value" readonly style="background: rgba(0, 217, 180, 0.1);">
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 10px; padding: 12px; background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: 1fr 150px; gap: 10px; align-items: end;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Guarantor 5 (Optional)</label>
                                <select id="guarantor5" onchange="updateGuarantorValue(5)">
                                    <option value="">Select Member</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Shares/Savings (R)</label>
                                <input type="number" id="guarantor5Value" readonly style="background: rgba(0, 217, 180, 0.1);">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Loan Purpose</label>
                    <textarea id="loanPurpose" required placeholder="Describe the purpose of this loan"></textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newLoanModal')"><span>Cancel</span></button>
                    <button type="submit" class="btn btn-primary"><span>Submit Application</span></button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Submit Payment Modal (For Members) -->
    <div class="modal" id="submitPaymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Submit My Payment</div>
                <button class="close-modal" onclick="closeModal('submitPaymentModal')">√ó</button>
            </div>
            <form onsubmit="submitMyPayment(event)">
                <div class="ai-insight" style="margin-bottom: 20px;">
                    <div class="ai-insight-title">Your Payment Details</div>
                    <div class="ai-insight-content" id="myPaymentInfo">
                        Loading...
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Amount Paid</label>
                    <input type="number" required id="myPaymentAmount" placeholder="Enter the amount you paid">
                </div>
                
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="myPaymentMethod" required>
                        <option value="eft">EFT/Bank Transfer</option>
                        <option value="cash">Cash</option>
                        <option value="card">Card Payment</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Payment Reference Number</label>
                    <input type="text" id="myPaymentReference" required placeholder="e.g., Transaction reference or receipt number">
                </div>
                
                <div class="form-group">
                    <label>Payment Date</label>
                    <input type="date" id="myPaymentDate" required>
                </div>
                
                <!-- Camera/Upload Section for Member -->
                <div class="form-group">
                    <label>Upload Deposit Slip / Proof of Payment *</label>
                    <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 10px;">
                        Take a photo of your deposit slip or upload a screenshot of your payment confirmation
                    </p>
                    <div style="margin-bottom: 10px;">
                        <button type="button" class="btn btn-primary" onclick="openMemberCamera()" style="margin-right: 10px;">
                            <span>üì∑ Take Photo</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('memberFileUpload').click()">
                            <span>üìÅ Upload File</span>
                        </button>
                    </div>
                    <input type="file" id="memberFileUpload" accept="image/*,application/pdf" style="display: none;" onchange="handleMemberFileUpload(event)">
                    <input type="file" id="memberCameraCapture" accept="image/*" capture="environment" style="display: none;" onchange="handleMemberCameraCapture(event)">
                    
                    <!-- Preview Area for Member -->
                    <div id="memberProofPreview" style="display: none; margin-top: 15px;">
                        <div style="position: relative; border: 2px solid var(--accent); border-radius: 12px; padding: 10px; background: rgba(0, 0, 0, 0.3);">
                            <button type="button" onclick="removeMemberProof()" style="position: absolute; top: 5px; right: 5px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-weight: bold;">√ó</button>
                            <img id="memberProofImage" style="width: 100%; max-height: 300px; object-fit: contain; border-radius: 8px; display: none;">
                            <div style="margin-top: 10px; font-size: 13px; color: var(--text-muted); text-align: center;" id="memberProofFileName"></div>
                        </div>
                    </div>
                    <input type="hidden" id="memberProofData" required>
                </div>
                
                <div class="form-group">
                    <label>Additional Notes (Optional)</label>
                    <textarea id="myPaymentNotes" placeholder="Add any additional information about your payment"></textarea>
                </div>
                
                <div style="background: rgba(255, 184, 0, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--gold);">
                    <strong>‚ö†Ô∏è Important:</strong> Your payment will be reviewed by the Treasurer. You'll receive a notification once it's confirmed.
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('submitPaymentModal')"><span>Cancel</span></button>
                    <button type="submit" class="btn btn-primary"><span>Submit Payment</span></button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="offline-indicator" id="offlineIndicator">
        ‚ö†Ô∏è You're offline - Changes will sync when connected
    </div>
    
    <script>
        // IndexedDB Database Configuration
        const DB_NAME = 'MasonkoStokveldDB';
        const DB_VERSION = 1;
        let db;
        
        // Initialize IndexedDB
        function initDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('Database failed to open');
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    console.log('Database opened successfully');
                    loadDataFromDB();
                    resolve(db);
                };
                
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    
                    // Users/Members table
                    if (!db.objectStoreNames.contains('users')) {
                        const usersStore = db.createObjectStore('users', { keyPath: 'id', autoIncrement: true });
                        usersStore.createIndex('email', 'email', { unique: true });
                        usersStore.createIndex('phone', 'phone', { unique: true });
                        usersStore.createIndex('role', 'role', { unique: false });
                        usersStore.createIndex('approved', 'approved', { unique: false });
                    }
                    
                    // Contributions table
                    if (!db.objectStoreNames.contains('contributions')) {
                        const contribStore = db.createObjectStore('contributions', { keyPath: 'id', autoIncrement: true });
                        contribStore.createIndex('memberId', 'memberId', { unique: false });
                        contribStore.createIndex('date', 'date', { unique: false });
                        contribStore.createIndex('status', 'status', { unique: false });
                    }
                    
                    // Loans table
                    if (!db.objectStoreNames.contains('loans')) {
                        const loansStore = db.createObjectStore('loans', { keyPath: 'id', autoIncrement: true });
                        loansStore.createIndex('memberId', 'memberId', { unique: false });
                        loansStore.createIndex('status', 'status', { unique: false });
                    }
                    
                    // Pending Payments table
                    if (!db.objectStoreNames.contains('pendingPayments')) {
                        const pendingStore = db.createObjectStore('pendingPayments', { keyPath: 'id', autoIncrement: true });
                        pendingStore.createIndex('memberId', 'memberId', { unique: false });
                        pendingStore.createIndex('status', 'status', { unique: false });
                    }
                    
                    // Notifications table
                    if (!db.objectStoreNames.contains('notifications')) {
                        const notifsStore = db.createObjectStore('notifications', { keyPath: 'id', autoIncrement: true });
                        notifsStore.createIndex('userId', 'userId', { unique: false });
                        notifsStore.createIndex('unread', 'unread', { unique: false });
                    }
                    
                    // Chat Messages table
                    if (!db.objectStoreNames.contains('chatMessages')) {
                        const chatStore = db.createObjectStore('chatMessages', { keyPath: 'id', autoIncrement: true });
                        chatStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                    
                    // Settings table
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                    
                    console.log('Database setup complete');
                    
                    // Seed initial data
                    seedInitialData(e.target.transaction);
                };
            });
        }
        
        // Seed initial data
        function seedInitialData(transaction) {
            const usersStore = transaction.objectStore('users');
            const settingsStore = transaction.objectStore('settings');
            
            // Add default admin and treasurer
            const defaultUsers = [
                { 
                    id: 1, 
                    name: 'Admin User', 
                    email: 'admin@masonko.com', 
                    phone: '0821234567', 
                    password: 'admin123', 
                    role: 'admin', 
                    tier: 3, 
                    shares: 3, 
                    balance: 14400, 
                    joined: '2024-01-15', 
                    lastPayment: '2026-01-13', 
                    status: 'current', 
                    approved: true 
                },
                { 
                    id: 2, 
                    name: 'Treasurer User', 
                    email: 'treasurer@masonko.com', 
                    phone: '0832345678', 
                    password: 'treasurer123', 
                    role: 'treasurer', 
                    tier: 2, 
                    shares: 2, 
                    balance: 9600, 
                    joined: '2024-02-20', 
                    lastPayment: '2026-01-13', 
                    status: 'current', 
                    approved: true 
                },
                { 
                    id: 3, 
                    name: 'Loan Officer User', 
                    email: 'loanofficer@masonko.com', 
                    phone: '0843456789', 
                    password: 'member123', 
                    role: 'loan-officer', 
                    tier: 3, 
                    shares: 3, 
                    balance: 13800, 
                    joined: '2024-03-10', 
                    lastPayment: '2026-01-13', 
                    status: 'current', 
                    approved: true 
                }
            ];
            
            defaultUsers.forEach(user => {
                usersStore.add(user);
            });
            
            // Add default settings
            const defaultSettings = [
                { key: 'clubName', value: 'Masonko Stokvel-Guptas' },
                { key: 'lateFee', value: 50 },
                { key: 'loanInterestRate', value: 10 },
                { key: 'paymentDueDay', value: 1 },
                { key: 'smsNotifications', value: true },
                { key: 'whatsappNotifications', value: true },
                { key: 'aiInsights', value: true }
            ];
            
            defaultSettings.forEach(setting => {
                settingsStore.add(setting);
            });
        }
        
        // Database Helper Functions
        const DB = {
            // Add record to any store
            add: (storeName, data) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.add(data);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            
            // Get record by ID
            get: (storeName, id) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.get(id);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            
            // Get all records from store
            getAll: (storeName) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            
            // Update record
            update: (storeName, data) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(data);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            
            // Delete record
            delete: (storeName, id) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(id);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            },
            
            // Query by index
            getByIndex: (storeName, indexName, value) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const index = store.index(indexName);
                    const request = index.getAll(value);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            
            // Clear all data from store
            clear: (storeName) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        };
        
        // Load data from DB into appState
        async function loadDataFromDB() {
            try {
                // Load users
                const users = await DB.getAll('users');
                appState.users = users;
                appState.members = users.filter(u => u.approved);
                appState.pendingMembers = users.filter(u => !u.approved);
                
                // Load contributions
                const contributions = await DB.getAll('contributions');
                appState.contributions = contributions || [];
                
                // Load loans
                const loans = await DB.getAll('loans');
                appState.loans = loans || [];
                
                // Load pending payments
                const pendingPayments = await DB.getAll('pendingPayments');
                appState.pendingPayments = pendingPayments || [];
                
                // Load notifications
                const notifications = await DB.getAll('notifications');
                appState.notifications = notifications || [];
                
                // Load chat messages
                const chatMessages = await DB.getAll('chatMessages');
                appState.chatMessages = chatMessages || [];
                
                console.log('Data loaded from database');
            } catch (error) {
                console.error('Error loading data from database:', error);
            }
        }
        
        // Save data to DB
        async function saveToDB(storeName, data) {
            try {
                if (data.id) {
                    await DB.update(storeName, data);
                } else {
                    const id = await DB.add(storeName, data);
                    data.id = id;
                }
                return data;
            } catch (error) {
                console.error(`Error saving to ${storeName}:`, error);
                throw error;
            }
        }
        
        // App State Management
        const appState = {
            currentUser: null, // Will be set on login
            isLoggedIn: false,
            users: [
                // Pre-seeded accounts - Admin and Treasurer
                { id: 1, name: 'Admin User', email: 'admin@masonko.com', phone: '0821234567', password: 'admin123', role: 'admin', tier: 3, shares: 3, balance: 14400, joined: '2024-01-15', lastPayment: '2026-01-13', status: 'current', approved: true },
                { id: 2, name: 'Treasurer User', email: 'treasurer@masonko.com', phone: '0832345678', password: 'treasurer123', role: 'treasurer', tier: 2, shares: 2, balance: 9600, joined: '2024-02-20', lastPayment: '2026-01-13', status: 'current', approved: true },
                { id: 3, name: 'Loan Officer User', email: 'loanofficer@masonko.com', phone: '0843456789', password: 'member123', role: 'loan-officer', tier: 3, shares: 3, balance: 13800, joined: '2024-03-10', lastPayment: '2026-01-13', status: 'current', approved: true }
            ],
            pendingMembers: [],
            tiers: {
                1: { shares: 1, weeklySubscription: 100, initialInvestment: 1000 },
                2: { shares: 2, weeklySubscription: 200, initialInvestment: 2000 },
                3: { shares: 3, weeklySubscription: 300, initialInvestment: 3000 }
            },
            lateFee: 50,
            members: [
                { id: 1, name: 'Admin User', email: 'admin@masonko.com', phone: '0821234567', role: 'admin', tier: 3, shares: 3, balance: 14400, joined: '2024-01-15', lastPayment: '2026-01-13', status: 'current' },
                { id: 2, name: 'Treasurer User', email: 'treasurer@masonko.com', phone: '0832345678', role: 'treasurer', tier: 2, shares: 2, balance: 9600, joined: '2024-02-20', lastPayment: '2026-01-13', status: 'current' },
                { id: 3, name: 'Loan Officer User', email: 'loanofficer@masonko.com', phone: '0843456789', role: 'loan-officer', tier: 3, shares: 3, balance: 13800, joined: '2024-03-10', lastPayment: '2026-01-13', status: 'current' },
                { id: 4, name: 'Member 4', email: 'member4@email.com', phone: '0854567890', role: 'member', tier: 2, shares: 2, balance: 9200, joined: '2024-03-25', lastPayment: '2026-01-06', status: 'late' },
                { id: 5, name: 'Member 5', email: 'member5@email.com', phone: '0865678901', role: 'vice-chair', tier: 1, shares: 1, balance: 4800, joined: '2024-04-05', lastPayment: '2026-01-13', status: 'current' },
                { id: 6, name: 'Member 6', email: 'member6@email.com', phone: '0876789012', role: 'member', tier: 3, shares: 3, balance: 14100, joined: '2024-04-15', lastPayment: '2026-01-13', status: 'current' },
                { id: 7, name: 'Member 7', email: 'member7@email.com', phone: '0887890123', role: 'member', tier: 1, shares: 1, balance: 4600, joined: '2024-05-01', lastPayment: '2026-01-13', status: 'current' },
                { id: 8, name: 'Member 8', email: 'member8@email.com', phone: '0898901234', role: 'member', tier: 2, shares: 2, balance: 9400, joined: '2024-05-10', lastPayment: '2026-01-06', status: 'late' }
            ],
            contributions: [],
            loans: [
                { id: 1, memberId: 3, amount: 10000, term: 6, interest: 10, outstanding: 8500, nextPayment: '2026-02-15', status: 'active' },
                { id: 2, memberId: 4, amount: 5000, term: 4, interest: 10, outstanding: 3500, nextPayment: '2026-02-15', status: 'active' }
            ],
            notifications: [
                { id: 1, type: 'payment', title: 'Payment Received', message: 'A member contributed R 800', time: '2 hours ago', unread: true },
                { id: 2, type: 'reminder', title: 'Payment Due', message: '3 members have payments due tomorrow', time: '5 hours ago', unread: true },
                { id: 3, type: 'loan', title: 'Loan Payment', message: 'A member paid R 2,500 loan installment', time: '1 day ago', unread: false }
            ],
            chatMessages: [
                { id: 1, sender: 'Treasurer User', message: 'Good morning everyone! Reminder that contributions are due on the 15th.', time: '09:30', isSent: false },
                { id: 2, sender: 'You', message: 'Thanks! I have already made my payment.', time: '09:45', isSent: true },
                { id: 3, sender: 'Loan Officer User', message: 'Can we discuss investment opportunities at the next meeting?', time: '10:15', isSent: false }
            ]
        };
        
        // Payment Proof Upload Functions
        let currentProofData = null;
        let currentMemberProofData = null;
        
        // Password Toggle Function
        function togglePassword(inputId, iconElement) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                iconElement.textContent = 'üôà'; // Closed eye
            } else {
                input.type = 'password';
                iconElement.textContent = 'üëÅÔ∏è'; // Open eye
            }
        }
        
        // Password Strength Checker
        function checkPasswordStrength(password) {
            // Check requirements
            const hasLength = password.length >= 8;
            const hasUppercase = /[A-Z]/.test(password);
            const hasLowercase = /[a-z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSymbol = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
            
            // Update requirement indicators
            updateRequirement('req-length', hasLength);
            updateRequirement('req-uppercase', hasUppercase);
            updateRequirement('req-lowercase', hasLowercase);
            updateRequirement('req-number', hasNumber);
            updateRequirement('req-symbol', hasSymbol);
            
            // Calculate strength
            let strength = 0;
            if (hasLength) strength++;
            if (hasUppercase) strength++;
            if (hasLowercase) strength++;
            if (hasNumber) strength++;
            if (hasSymbol) strength++;
            
            // Update strength bar
            const strengthBar = document.getElementById('strength-bar');
            const strengthText = document.getElementById('strength-text');
            
            if (password.length === 0) {
                strengthBar.className = 'password-strength-bar';
                strengthText.textContent = '';
                strengthText.style.color = '';
            } else if (strength < 3) {
                strengthBar.className = 'password-strength-bar weak';
                strengthText.textContent = 'Weak Password';
                strengthText.style.color = 'var(--danger)';
            } else if (strength < 5) {
                strengthBar.className = 'password-strength-bar medium';
                strengthText.textContent = 'Medium Password';
                strengthText.style.color = 'var(--gold)';
            } else {
                strengthBar.className = 'password-strength-bar strong';
                strengthText.textContent = 'Strong Password';
                strengthText.style.color = 'var(--success)';
            }
            
            // Check if passwords match when confirm field is not empty
            checkPasswordMatch();
            
            return strength === 5;
        }
        
        function updateRequirement(id, met) {
            const element = document.getElementById(id);
            if (met) {
                element.classList.add('met');
            } else {
                element.classList.remove('met');
            }
        }
        
        function checkPasswordMatch() {
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const messageDiv = document.getElementById('password-match-message');
            
            if (confirmPassword.length === 0) {
                messageDiv.textContent = '';
                return;
            }
            
            if (password === confirmPassword) {
                messageDiv.textContent = '‚úì Passwords match';
                messageDiv.style.color = 'var(--success)';
                return true;
            } else {
                messageDiv.textContent = '‚úó Passwords do not match';
                messageDiv.style.color = 'var(--danger)';
                return false;
            }
        }
        
        function validatePasswordRequirements(password) {
            const hasLength = password.length >= 8;
            const hasUppercase = /[A-Z]/.test(password);
            const hasLowercase = /[a-z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSymbol = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
            
            return hasLength && hasUppercase && hasLowercase && hasNumber && hasSymbol;
        }
        
        function openCamera() {
            document.getElementById('cameraCapture').click();
        }
        
        function handleCameraCapture(event) {
            const file = event.target.files[0];
            if (file) {
                processProofFile(file);
            }
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processProofFile(file);
            }
        }
        
        function processProofFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file (JPG, PNG, etc.)');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentProofData = {
                    fileName: file.name,
                    fileType: file.type,
                    fileSize: file.size,
                    dataUrl: e.target.result,
                    uploadDate: new Date().toISOString()
                };
                
                // Show preview
                document.getElementById('proofImage').src = e.target.result;
                document.getElementById('proofFileName').textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                document.getElementById('proofPreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
        
        function removeProof() {
            currentProofData = null;
            document.getElementById('proofPreview').style.display = 'none';
            document.getElementById('proofImage').src = '';
            document.getElementById('proofFileName').textContent = '';
            document.getElementById('cameraCapture').value = '';
            document.getElementById('fileUpload').value = '';
        }
        
        // Member Submit Payment Functions
        function openMemberCamera() {
            document.getElementById('memberCameraCapture').click();
        }
        
        function handleMemberCameraCapture(event) {
            const file = event.target.files[0];
            if (file) {
                processMemberProofFile(file);
            }
        }
        
        function handleMemberFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processMemberProofFile(file);
            }
        }
        
        function processMemberProofFile(file) {
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'application/pdf'];
            if (!validTypes.includes(file.type)) {
                alert('Please upload an image file (JPG, PNG, GIF) or PDF');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                alert('File size must be less than 5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentMemberProofData = {
                    fileName: file.name,
                    fileType: file.type,
                    fileSize: file.size,
                    dataUrl: e.target.result,
                    uploadDate: new Date().toISOString()
                };
                
                // Show preview
                if (file.type === 'application/pdf') {
                    document.getElementById('memberProofImage').style.display = 'none';
                    document.getElementById('memberProofFileName').innerHTML = `üìÑ ${file.name}<br>(${(file.size / 1024).toFixed(1)} KB)`;
                } else {
                    document.getElementById('memberProofImage').src = e.target.result;
                    document.getElementById('memberProofImage').style.display = 'block';
                    document.getElementById('memberProofFileName').textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                }
                document.getElementById('memberProofPreview').style.display = 'block';
                document.getElementById('memberProofData').value = 'uploaded'; // Mark as uploaded
            };
            reader.readAsDataURL(file);
        }
        
        function removeMemberProof() {
            currentMemberProofData = null;
            document.getElementById('memberProofPreview').style.display = 'none';
            document.getElementById('memberProofImage').src = '';
            document.getElementById('memberProofImage').style.display = 'none';
            document.getElementById('memberProofFileName').textContent = '';
            document.getElementById('memberCameraCapture').value = '';
            document.getElementById('memberFileUpload').value = '';
            document.getElementById('memberProofData').value = '';
        }
        
        function submitMyPayment(e) {
            e.preventDefault();
            
            if (!currentMemberProofData) {
                alert('Please upload proof of payment before submitting.');
                return;
            }
            
            const payment = {
                memberId: appState.currentUser.id,
                memberName: appState.currentUser.name,
                amount: parseFloat(document.getElementById('myPaymentAmount').value),
                method: document.getElementById('myPaymentMethod').value,
                reference: document.getElementById('myPaymentReference').value,
                date: document.getElementById('myPaymentDate').value,
                notes: document.getElementById('myPaymentNotes').value,
                proof: currentMemberProofData,
                status: 'pending',
                submittedDate: new Date().toISOString()
            };
            
            // Save to database
            saveToDB('pendingPayments', payment).then(savedPayment => {
                // Add to app state
                if (!appState.pendingPayments) {
                    appState.pendingPayments = [];
                }
                appState.pendingPayments.push(savedPayment);
                
                showNotification('Payment submitted successfully! The Treasurer will review and confirm your payment.', 'success');
                closeModal('submitPaymentModal');
                e.target.reset();
                removeMemberProof();
            }).catch(error => {
                console.error('Error submitting payment:', error);
                alert('Failed to submit payment. Please try again.');
            });
        }
        
        // Authentication Functions
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelector('.auth-tab:first-child').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.querySelector('.auth-tab:last-child').classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            }
        }
        
        function updateRegTierInfo() {
            const tierSelect = document.getElementById('regTier');
            const tier = parseInt(tierSelect.value);
            const tierInfoDiv = document.getElementById('regTierInfo');
            
            if (tier) {
                const tierData = appState.tiers[tier];
                document.getElementById('regTierInvestment').textContent = `R ${tierData.initialInvestment.toLocaleString()}`;
                document.getElementById('regTierShares').textContent = tierData.shares;
                document.getElementById('regTierSubscription').textContent = `R ${tierData.weeklySubscription}`;
                tierInfoDiv.style.display = 'block';
            } else {
                tierInfoDiv.style.display = 'none';
            }
        }
        
        function handleLogin(e) {
            e.preventDefault();
            
            const identifier = document.getElementById('loginIdentifier').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            // Find user by email or phone
            const user = appState.users.find(u => 
                (u.email === identifier || u.phone === identifier) && u.password === password
            );
            
            if (user) {
                if (!user.approved) {
                    alert('Your account is pending approval from the Admin or Treasurer.');
                    return;
                }
                
                // Set current user
                appState.currentUser = user;
                appState.isLoggedIn = true;
                
                // Save to localStorage
                localStorage.setItem('mas–æ–ΩkoUser', JSON.stringify(user));
                
                // Show main app
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
                // Update UI with user info
                updateUserInterface();
                
                showNotification(`Welcome back, ${user.name}!`, 'success');
            } else {
                alert('Invalid email/phone or password. Please try again.');
            }
        }
        
        function handleRegister(e) {
            e.preventDefault();
            
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            
            // Validate password requirements
            if (!validatePasswordRequirements(password)) {
                alert('Password does not meet all requirements.\n\nPlease ensure your password contains:\n‚Ä¢ At least 8 characters\n‚Ä¢ At least one uppercase letter (A-Z)\n‚Ä¢ At least one lowercase letter (a-z)\n‚Ä¢ At least one number (0-9)\n‚Ä¢ At least one symbol (!@#$%^&*)');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }
            
            const email = document.getElementById('regEmail').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            
            // Check if user already exists
            if (appState.users.find(u => u.email === email || u.phone === phone)) {
                alert('An account with this email or phone number already exists.');
                return;
            }
            
            const tier = parseInt(document.getElementById('regTier').value);
            const tierData = appState.tiers[tier];
            
            // Create new pending member
            const newMember = {
                name: document.getElementById('regName').value.trim(),
                email: email,
                phone: phone,
                password: password,
                role: 'member',
                tier: tier,
                shares: tierData.shares,
                balance: 0,
                joined: new Date().toISOString().split('T')[0],
                lastPayment: null,
                status: 'pending',
                approved: false
            };
            
            // Save to database
            saveToDB('users', newMember).then(savedUser => {
                // Add to app state
                appState.pendingMembers.push(savedUser);
                appState.users.push(savedUser);
                
                // Show success message
                alert(`Registration submitted successfully!\n\nYour application has been sent to the Admin/Treasurer for approval.\n\nYou will receive a notification once your account is approved.\n\nInitial Investment Required: R ${tierData.initialInvestment.toLocaleString()}\nWeekly Subscription: R ${tierData.weeklySubscription}`);
                
                // Reset form and switch to login
                e.target.reset();
                document.getElementById('regTierInfo').style.display = 'none';
                
                // Reset password strength indicators
                document.querySelectorAll('.requirement').forEach(req => req.classList.remove('met'));
                document.getElementById('strength-bar').className = 'password-strength-bar';
                document.getElementById('strength-text').textContent = '';
                document.getElementById('password-match-message').textContent = '';
                
                switchAuthTab('login');
            }).catch(error => {
                console.error('Error saving user:', error);
                alert('Registration failed. Please try again.');
            });
        }
        
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                appState.currentUser = null;
                appState.isLoggedIn = false;
                localStorage.removeItem('masonkoUser');
                
                // Hide main app, show auth screen
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('authScreen').classList.remove('hidden');
                
                // Reset forms
                document.getElementById('loginForm').reset();
                document.getElementById('registerForm').reset();
            }
        }
        
        function showForgotPassword() {
            alert('Please contact the Admin (admin@masonko.com) or Treasurer (treasurer@masonko.com) to reset your password.');
        }
        
        function updateUserInterface() {
            if (!appState.currentUser) return;
            
            const initials = appState.currentUser.name.split(' ').map(n => n[0]).join('');
            document.getElementById('userAvatar').textContent = initials;
            document.getElementById('userRoleBadge').textContent = appState.currentUser.role.replace('-', ' ').toUpperCase();
            
            // Show/hide pending approvals section based on role
            if (appState.currentUser.role === 'admin' || appState.currentUser.role === 'treasurer') {
                document.getElementById('pendingApprovalsSection').style.display = 'block';
                renderPendingMembers();
            }
        }
        
        function renderPendingMembers() {
            const pending = appState.pendingMembers;
            const countDiv = document.getElementById('pendingCount');
            const listDiv = document.getElementById('pendingMembersList');
            
            countDiv.textContent = `${pending.length} new member application${pending.length !== 1 ? 's' : ''} awaiting your approval.`;
            
            if (pending.length === 0) {
                listDiv.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No pending applications</p>';
                return;
            }
            
            listDiv.innerHTML = pending.map(member => {
                const tierInfo = appState.tiers[member.tier];
                return `
                    <div class="member-card" style="border: 2px solid var(--gold);">
                        <div class="member-header">
                            <div class="member-avatar">${member.name.split(' ').map(n => n[0]).join('')}</div>
                            <div class="member-info">
                                <h3>${member.name}</h3>
                                <div class="member-role">New Application</div>
                            </div>
                        </div>
                        <div style="margin: 15px 0; padding: 12px; background: rgba(255, 184, 0, 0.1); border-radius: 8px;">
                            <div><strong>Email:</strong> ${member.email}</div>
                            <div><strong>Phone:</strong> ${member.phone}</div>
                            <div><strong>Tier:</strong> ${member.tier} (${member.shares} share${member.shares > 1 ? 's' : ''})</div>
                            <div><strong>Weekly Subscription:</strong> R ${tierInfo.weeklySubscription}</div>
                            <div><strong>Initial Investment:</strong> R ${tierInfo.initialInvestment.toLocaleString()}</div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" style="flex: 1;" onclick="approveMember(${member.id})"><span>‚úì Approve</span></button>
                            <button class="btn btn-danger" style="flex: 1;" onclick="rejectMember(${member.id})"><span>‚úó Reject</span></button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function approveMember(memberId) {
            if (confirm('Approve this member? They will be able to login immediately.')) {
                const member = appState.pendingMembers.find(m => m.id === memberId);
                if (member) {
                    member.approved = true;
                    member.status = 'current';
                    
                    // Update in database
                    saveToDB('users', member).then(() => {
                        // Move from pending to active members
                        appState.pendingMembers = appState.pendingMembers.filter(m => m.id !== memberId);
                        
                        // Check if already in members array
                        if (!appState.members.find(m => m.id === memberId)) {
                            appState.members.push(member);
                        }
                        
                        renderPendingMembers();
                        renderMembers();
                        showNotification(`${member.name} has been approved and added to the stokveld!`, 'success');
                    }).catch(error => {
                        console.error('Error approving member:', error);
                        alert('Failed to approve member. Please try again.');
                    });
                }
            }
        }
        
        function rejectMember(memberId) {
            if (confirm('Reject this member application? This cannot be undone.')) {
                const member = appState.pendingMembers.find(m => m.id === memberId);
                if (member) {
                    appState.pendingMembers = appState.pendingMembers.filter(m => m.id !== memberId);
                    appState.users = appState.users.filter(u => u.id !== memberId);
                    
                    renderPendingMembers();
                    showNotification(`Application from ${member.name} has been rejected.`, 'success');
                }
            }
        }
        
        // Check for saved login on page load
        window.addEventListener('DOMContentLoaded', async () => {
            // Initialize database first
            try {
                await initDatabase();
                console.log('Database initialized successfully');
            } catch (error) {
                console.error('Database initialization failed:', error);
                alert('Database initialization failed. The app may not work properly.');
            }
            
            const savedUser = localStorage.getItem('masonkoUser');
            if (savedUser) {
                const user = JSON.parse(savedUser);
                // Verify user still exists and is approved
                const currentUser = appState.users.find(u => u.email === user.email && u.approved);
                if (currentUser) {
                    appState.currentUser = currentUser;
                    appState.isLoggedIn = true;
                    document.getElementById('authScreen').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    updateUserInterface();
                }
            }
        });
        
        // Navigation
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const view = btn.dataset.view;
                
                // Update active nav button
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Show/hide views
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(view).classList.add('active');
                
                // Load view-specific data
                loadViewData(view);
            });
        });
        
        function loadViewData(view) {
            switch(view) {
                case 'members':
                    renderMembers();
                    break;
                case 'contributions':
                    renderContributions();
                    break;
                case 'loans':
                    renderLoans();
                    break;
                case 'chat':
                    renderChat();
                    break;
                case 'notifications':
                    renderNotifications();
                    break;
            }
        }
        
        // Render Members
        function renderMembers() {
            const grid = document.getElementById('memberGrid');
            grid.innerHTML = appState.members.map(member => {
                const tierInfo = appState.tiers[member.tier];
                return `
                <div class="member-card">
                    <div class="member-header">
                        <div class="member-avatar">${member.name.split(' ').map(n => n[0]).join('')}</div>
                        <div class="member-info">
                            <h3>${member.name}</h3>
                            <div class="member-role">${member.role.replace('-', ' ')}</div>
                        </div>
                    </div>
                    <div style="margin: 15px 0; padding: 12px; background: rgba(0, 217, 180, 0.1); border-radius: 8px; border-left: 3px solid ${member.status === 'late' ? 'var(--danger)' : 'var(--accent)'};">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">TIER ${member.tier} - ${member.shares} SHARE${member.shares > 1 ? 'S' : ''}</div>
                        <div style="font-size: 14px; font-weight: 600;">R ${tierInfo.weeklySubscription}/week</div>
                        <div style="font-size: 11px; color: ${member.status === 'late' ? 'var(--danger)' : 'var(--success)'}; margin-top: 5px;">
                            ${member.status === 'late' ? '‚ö†Ô∏è PAYMENT OVERDUE' : '‚úì Payment Current'}
                        </div>
                    </div>
                    <div class="member-stats">
                        <div class="member-stat">
                            <div class="member-stat-label">Balance</div>
                            <div class="member-stat-value">R ${member.balance.toLocaleString()}</div>
                        </div>
                        <div class="member-stat">
                            <div class="member-stat-label">Last Payment</div>
                            <div class="member-stat-value">${new Date(member.lastPayment).toLocaleDateString('en-ZA', { month: 'short', day: 'numeric' })}</div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        // Render Contributions
        function renderContributions() {
            const table = document.getElementById('contributionsTable');
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday
            const daysUntilMonday = dayOfWeek === 0 ? 1 : dayOfWeek === 1 ? 0 : 8 - dayOfWeek;
            const nextMonday = new Date(today);
            nextMonday.setDate(today.getDate() + daysUntilMonday);
            
            const contributions = appState.members.map(member => {
                const tierInfo = appState.tiers[member.tier];
                const isLate = member.status === 'late';
                const amountDue = tierInfo.weeklySubscription + (isLate ? appState.lateFee : 0);
                
                return {
                    member: member.name,
                    tier: member.tier,
                    shares: member.shares,
                    dueDate: nextMonday.toISOString().split('T')[0],
                    baseAmount: tierInfo.weeklySubscription,
                    lateFee: isLate ? appState.lateFee : 0,
                    totalAmount: amountDue,
                    status: isLate ? 'overdue' : (member.lastPayment === '2026-01-13' ? 'paid' : 'pending'),
                    lastPayment: member.lastPayment
                };
            });
            
            table.innerHTML = contributions.map(contrib => `
                <tr style="${contrib.status === 'overdue' ? 'background: rgba(255, 71, 87, 0.1);' : ''}">
                    <td>
                        <strong>${contrib.member}</strong><br>
                        <span style="font-size: 11px; color: var(--text-muted);">Tier ${contrib.tier} - ${contrib.shares} Share${contrib.shares > 1 ? 's' : ''}</span>
                    </td>
                    <td>${contrib.dueDate}<br><span style="font-size: 11px; color: var(--text-muted);">Every Monday</span></td>
                    <td>
                        <strong>R ${contrib.baseAmount}</strong>
                        ${contrib.lateFee > 0 ? `<br><span style="color: var(--danger); font-size: 12px;">+ R ${contrib.lateFee} late fee</span>` : ''}
                        ${contrib.lateFee > 0 ? `<br><strong style="color: var(--danger);">R ${contrib.totalAmount} total</strong>` : ''}
                    </td>
                    <td>
                        <span style="color: ${contrib.status === 'paid' ? 'var(--success)' : contrib.status === 'overdue' ? 'var(--danger)' : 'var(--gold)'}; font-weight: 600;">
                            ${contrib.status === 'paid' ? '‚úì Paid' : contrib.status === 'overdue' ? '‚ö†Ô∏è OVERDUE' : '‚è≥ Pending'}
                        </span>
                        ${contrib.status === 'paid' ? `<br><span style="font-size: 11px; color: var(--text-muted);">Last: ${contrib.lastPayment}</span>` : ''}
                    </td>
                    <td>
                        ${contrib.status !== 'paid' ? 
                            '<button class="btn btn-secondary" style="padding: 8px 16px;" onclick="sendReminder()"><span>Send Reminder</span></button>' : 
                            '<button class="btn btn-secondary" style="padding: 8px 16px;"><span>View Receipt</span></button>'}
                    </td>
                </tr>
            `).join('');
            
            // Show pending payments section if user is Treasurer or Admin
            if (appState.currentUser && (appState.currentUser.role === 'treasurer' || appState.currentUser.role === 'admin')) {
                renderPendingPayments();
            }
        }
        
        function renderPendingPayments() {
            if (!appState.pendingPayments) {
                appState.pendingPayments = [];
            }
            
            const section = document.getElementById('pendingPaymentsSection');
            const countDiv = document.getElementById('pendingPaymentsCount');
            const listDiv = document.getElementById('pendingPaymentsList');
            
            const pending = appState.pendingPayments.filter(p => p.status === 'pending');
            
            if (pending.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            countDiv.textContent = `${pending.length} payment submission${pending.length !== 1 ? 's' : ''} awaiting your verification.`;
            
            listDiv.innerHTML = pending.map((payment, index) => `
                <div style="background: rgba(10, 26, 42, 0.6); border: 2px solid var(--gold); border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4 style="color: var(--accent); margin-bottom: 10px;">${payment.memberName}</h4>
                            <div style="font-size: 14px; line-height: 1.8;">
                                <strong>Amount:</strong> R ${payment.amount}<br>
                                <strong>Method:</strong> ${payment.method.toUpperCase()}<br>
                                <strong>Reference:</strong> ${payment.reference}<br>
                                <strong>Payment Date:</strong> ${payment.date}<br>
                                <strong>Submitted:</strong> ${new Date(payment.submittedDate).toLocaleString()}<br>
                                ${payment.notes ? `<strong>Notes:</strong> ${payment.notes}<br>` : ''}
                            </div>
                        </div>
                        <div>
                            <strong style="color: var(--text-muted); font-size: 12px;">PROOF OF PAYMENT</strong>
                            <div style="margin-top: 10px; border: 2px solid var(--border); border-radius: 8px; overflow: hidden;">
                                ${payment.proof.fileType === 'application/pdf' ? 
                                    `<div style="padding: 40px; text-align: center; background: rgba(0,0,0,0.3);">
                                        <div style="font-size: 48px;">üìÑ</div>
                                        <div style="margin-top: 10px; font-size: 13px;">${payment.proof.fileName}</div>
                                        <button class="btn btn-secondary" style="margin-top: 10px; padding: 8px 16px;" onclick="viewProofFullScreen(${index})"><span>View PDF</span></button>
                                    </div>` :
                                    `<img src="${payment.proof.dataUrl}" style="width: 100%; max-height: 300px; object-fit: contain; background: rgba(0,0,0,0.3); cursor: pointer;" onclick="viewProofFullScreen(${index})">`
                                }
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                        <button class="btn btn-primary" style="flex: 1;" onclick="approvePayment(${index})"><span>‚úì Confirm Payment</span></button>
                        <button class="btn btn-danger" style="flex: 1;" onclick="rejectPayment(${index})"><span>‚úó Reject</span></button>
                    </div>
                </div>
            `).join('');
        }
        
        function viewProofFullScreen(index) {
            const payment = appState.pendingPayments.filter(p => p.status === 'pending')[index];
            if (payment && payment.proof) {
                window.open(payment.proof.dataUrl, '_blank');
            }
        }
        
        function approvePayment(index) {
            const pending = appState.pendingPayments.filter(p => p.status === 'pending');
            const payment = pending[index];
            
            if (confirm(`Confirm payment of R ${payment.amount} from ${payment.memberName}?`)) {
                // Update payment status
                payment.status = 'confirmed';
                payment.confirmedBy = appState.currentUser.name;
                payment.confirmedDate = new Date().toISOString();
                
                // Update member's record
                const member = appState.members.find(m => m.id === payment.memberId);
                if (member) {
                    member.lastPayment = payment.date;
                    member.status = 'current';
                    member.balance += payment.amount;
                    
                    // Save to database
                    Promise.all([
                        saveToDB('pendingPayments', payment),
                        saveToDB('users', member),
                        saveToDB('contributions', payment)
                    ]).then(() => {
                        // Update app state
                        if (!appState.contributions) {
                            appState.contributions = [];
                        }
                        appState.contributions.push(payment);
                        
                        renderPendingPayments();
                        renderContributions();
                        showNotification(`Payment from ${payment.memberName} confirmed successfully!`, 'success');
                    }).catch(error => {
                        console.error('Error approving payment:', error);
                        alert('Failed to approve payment. Please try again.');
                    });
                }
            }
        }
        
        function rejectPayment(index) {
            const pending = appState.pendingPayments.filter(p => p.status === 'pending');
            const payment = pending[index];
            
            const reason = prompt(`Why are you rejecting this payment from ${payment.memberName}?`);
            if (reason) {
                payment.status = 'rejected';
                payment.rejectedBy = appState.currentUser.name;
                payment.rejectedDate = new Date().toISOString();
                payment.rejectionReason = reason;
                
                renderPendingPayments();
                showNotification(`Payment from ${payment.memberName} rejected. Member will be notified.`, 'success');
            }
        }
        
        // Render Loans
        function renderLoans() {
            const table = document.getElementById('loansTable');
            table.innerHTML = appState.loans.map(loan => {
                const member = appState.members.find(m => m.id === loan.memberId);
                const statusColor = loan.status === 'active' ? 'var(--success)' : 
                                   loan.status === 'pending' ? 'var(--gold)' : 
                                   'var(--danger)';
                const statusText = loan.status === 'active' ? '‚úì Active' : 
                                  loan.status === 'pending' ? '‚è≥ Pending Review' : 
                                  '‚úó Rejected';
                
                return `
                    <tr>
                        <td>
                            <strong>${member.name}</strong><br>
                            <span style="font-size: 11px; color: var(--text-muted);">MSK-${String(member.id).padStart(4, '0')}</span>
                        </td>
                        <td>R ${loan.amount.toLocaleString()}</td>
                        <td>${loan.term} weeks</td>
                        <td>${loan.interest}%</td>
                        <td><span style="color: ${statusColor}; font-weight: 600;">${statusText}</span></td>
                        <td>${loan.nextPayment || 'N/A'}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 8px 16px;" onclick="viewLoanDetails(${loan.id})"><span>View Details</span></button>
                            ${loan.status === 'pending' && (appState.currentUser.role === 'admin' || appState.currentUser.role === 'loan-officer') ? 
                                `<button class="btn btn-primary" style="padding: 8px 16px; margin-left: 5px;" onclick="approveLoan(${loan.id})"><span>Approve</span></button>` : 
                                ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function viewLoanDetails(loanId) {
            const loan = appState.loans.find(l => l.id === loanId);
            if (!loan) return;
            
            const member = appState.members.find(m => m.id === loan.memberId);
            const details = loan.applicationDetails || {};
            
            let detailsHTML = `
                <strong>Loan Application Details</strong><br><br>
                <strong>Applicant:</strong> ${member.name}<br>
                <strong>Registration No:</strong> MSK-${String(member.id).padStart(4, '0')}<br>
                <strong>Amount:</strong> R ${loan.amount.toLocaleString()}<br>
                <strong>Duration:</strong> ${loan.term} weeks<br>
                <strong>Interest:</strong> ${loan.interest}%<br>
                <strong>Total P&I:</strong> R ${loan.outstanding.toLocaleString()}<br>
                <strong>Status:</strong> ${loan.status}<br>
                <strong>Application Date:</strong> ${loan.applicationDate || 'N/A'}<br><br>
            `;
            
            if (details.purpose) {
                detailsHTML += `<strong>Purpose:</strong><br>${details.purpose}<br><br>`;
            }
            
            if (details.residentialAddress) {
                detailsHTML += `<strong>Residential Address:</strong><br>${details.residentialAddress}, ${details.resSuburb || ''}<br><br>`;
            }
            
            if (details.collateralType) {
                detailsHTML += `<strong>Collateral:</strong> ${details.collateralType} (Est. Value: R ${details.collateralValue || 0})<br><br>`;
            }
            
            // Display all guarantors
            let guarantorCount = 0;
            if (details.guarantor1) {
                const g1 = appState.members.find(m => m.id === parseInt(details.guarantor1));
                if (g1) {
                    detailsHTML += `<strong>Guarantor 1:</strong> ${g1.name}<br>`;
                    guarantorCount++;
                }
            }
            if (details.guarantor2) {
                const g2 = appState.members.find(m => m.id === parseInt(details.guarantor2));
                if (g2) {
                    detailsHTML += `<strong>Guarantor 2:</strong> ${g2.name}<br>`;
                    guarantorCount++;
                }
            }
            if (details.guarantor3) {
                const g3 = appState.members.find(m => m.id === parseInt(details.guarantor3));
                if (g3) {
                    detailsHTML += `<strong>Guarantor 3:</strong> ${g3.name}<br>`;
                    guarantorCount++;
                }
            }
            if (details.guarantor4) {
                const g4 = appState.members.find(m => m.id === parseInt(details.guarantor4));
                if (g4) {
                    detailsHTML += `<strong>Guarantor 4:</strong> ${g4.name}<br>`;
                    guarantorCount++;
                }
            }
            if (details.guarantor5) {
                const g5 = appState.members.find(m => m.id === parseInt(details.guarantor5));
                if (g5) {
                    detailsHTML += `<strong>Guarantor 5:</strong> ${g5.name}<br>`;
                    guarantorCount++;
                }
            }
            
            if (guarantorCount > 0) {
                detailsHTML += `<br><strong>Total Guarantors:</strong> ${guarantorCount}`;
            }
            
            alert(detailsHTML);
        }
        
        function approveLoan(loanId) {
            if (confirm('Approve this loan application?')) {
                const loan = appState.loans.find(l => l.id === loanId);
                if (loan) {
                    loan.status = 'active';
                    renderLoans();
                    showNotification('Loan approved successfully!', 'success');
                }
            }
        }
        
        // Render Chat
        function renderChat() {
            const container = document.getElementById('chatMessages');
            container.innerHTML = appState.chatMessages.map(msg => `
                <div class="chat-message ${msg.isSent ? 'sent' : 'received'}">
                    ${!msg.isSent ? `<div class="message-author">${msg.sender}</div>` : ''}
                    <div>${msg.message}</div>
                    <div class="message-time">${msg.time}</div>
                </div>
            `).join('');
            container.scrollTop = container.scrollHeight;
        }
        
        // Render Notifications
        function renderNotifications() {
            const list = document.getElementById('notificationList');
            list.innerHTML = appState.notifications.map(notif => `
                <div class="notification ${notif.unread ? 'unread' : ''}">
                    <div class="notification-icon">${notif.type === 'payment' ? 'üí∞' : notif.type === 'reminder' ? 'üîî' : 'üìã'}</div>
                    <div class="notification-content">
                        <div class="notification-title">${notif.title}</div>
                        <div class="notification-message">${notif.message}</div>
                        <div class="notification-time">${notif.time}</div>
                    </div>
                </div>
            `).join('');
        }
        
        // Modal Functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            
            // Populate member dropdowns
            if (modalId === 'recordContributionModal') {
                const selectId = 'contributionMember';
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Select Member</option>' + 
                    appState.members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            } else if (modalId === 'newLoanModal') {
                const select = document.getElementById('loanMember');
                select.innerHTML = '<option value="">Select Member</option>' + 
                    appState.members
                        .filter(m => m.status === 'current') // Only current members can apply
                        .map(m => `<option value="${m.id}">${m.name}</option>`)
                        .join('');
            } else if (modalId === 'submitPaymentModal') {
                // Populate member's payment info
                if (appState.currentUser) {
                    const tierInfo = appState.tiers[appState.currentUser.tier];
                    const isLate = appState.currentUser.status === 'late';
                    const dueAmount = tierInfo.weeklySubscription + (isLate ? appState.lateFee : 0);
                    
                    document.getElementById('myPaymentInfo').innerHTML = `
                        <strong>Member:</strong> ${appState.currentUser.name}<br>
                        <strong>Tier:</strong> ${appState.currentUser.tier} (${appState.currentUser.shares} share${appState.currentUser.shares > 1 ? 's' : ''})<br>
                        <strong>Weekly Subscription:</strong> R ${tierInfo.weeklySubscription}<br>
                        ${isLate ? `<strong style="color: var(--danger);">Late Fee:</strong> R ${appState.lateFee}<br>` : ''}
                        <strong>Total Due:</strong> R ${dueAmount}
                    `;
                    
                    // Set today's date as default
                    document.getElementById('myPaymentDate').value = new Date().toISOString().split('T')[0];
                    
                    // Pre-fill amount
                    document.getElementById('myPaymentAmount').value = dueAmount;
                }
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // Form Handlers
        function updateTierInfo() {
            const tierSelect = document.getElementById('memberTier');
            const tier = parseInt(tierSelect.value);
            const tierInfoDiv = document.getElementById('tierInfo');
            
            if (tier) {
                const tierData = appState.tiers[tier];
                document.getElementById('tierInvestment').textContent = `R ${tierData.initialInvestment.toLocaleString()}`;
                document.getElementById('tierShares').textContent = tierData.shares;
                document.getElementById('tierSubscription').textContent = `R ${tierData.weeklySubscription}`;
                tierInfoDiv.style.display = 'block';
            } else {
                tierInfoDiv.style.display = 'none';
            }
        }
        
        function updateContributionAmount() {
            const memberSelect = document.getElementById('contributionMember');
            const memberId = parseInt(memberSelect.value);
            const applyLateFee = document.getElementById('applyLateFee').checked;
            
            if (memberId) {
                const member = appState.members.find(m => m.id === memberId);
                const tierInfo = appState.tiers[member.tier];
                const baseAmount = tierInfo.weeklySubscription;
                const lateFee = applyLateFee ? appState.lateFee : 0;
                const totalAmount = baseAmount + lateFee;
                
                document.getElementById('contributionAmount2').value = totalAmount;
                
                const breakdown = document.getElementById('contributionBreakdown');
                if (lateFee > 0) {
                    breakdown.innerHTML = `Base subscription: R ${baseAmount}<br>Late fee: R ${lateFee}<br><strong>Total: R ${totalAmount}</strong>`;
                    breakdown.style.color = 'var(--danger)';
                } else {
                    breakdown.innerHTML = `Tier ${member.tier} weekly subscription`;
                    breakdown.style.color = 'var(--text-muted)';
                }
            }
        }
        
        function addMember(e) {
            e.preventDefault();
            const tier = parseInt(document.getElementById('memberTier').value);
            const tierInfo = appState.tiers[tier];
            
            const newMember = {
                id: appState.members.length + 1,
                name: document.getElementById('memberName').value,
                email: document.getElementById('memberEmail').value,
                phone: document.getElementById('memberPhone').value,
                role: document.getElementById('memberRole').value,
                tier: tier,
                shares: tierInfo.shares,
                balance: tierInfo.initialInvestment,
                joined: new Date().toISOString().split('T')[0],
                lastPayment: new Date().toISOString().split('T')[0],
                status: 'current'
            };
            appState.members.push(newMember);
            renderMembers();
            closeModal('addMemberModal');
            e.target.reset();
            document.getElementById('tierInfo').style.display = 'none';
            showNotification('Member added successfully!', 'success');
        }
        
        function recordContribution(e) {
            e.preventDefault();
            const memberId = parseInt(document.getElementById('contributionMember').value);
            const member = appState.members.find(m => m.id === memberId);
            const amount = parseFloat(document.getElementById('contributionAmount2').value);
            
            // Create payment record with proof
            const payment = {
                memberId: memberId,
                amount: amount,
                method: document.getElementById('paymentMethod').value,
                reference: document.getElementById('paymentReference').value,
                proof: currentProofData,
                date: new Date().toISOString().split('T')[0],
                recordedBy: appState.currentUser.name,
                status: 'confirmed'
            };
            
            // Save to database
            saveToDB('contributions', payment).then(savedPayment => {
                appState.contributions.push(savedPayment);
                
                // Update member's last payment and status
                member.lastPayment = new Date().toISOString().split('T')[0];
                member.status = 'current';
                member.balance += amount;
                
                // Update member in database
                return saveToDB('users', member);
            }).then(() => {
                showNotification(`Payment of R ${amount} recorded successfully for ${member.name}!`, 'success');
                closeModal('recordContributionModal');
                e.target.reset();
                removeProof();
                
                // Refresh the contributions view if it's active
                if (document.getElementById('contributions').classList.contains('active')) {
                    renderContributions();
                }
            }).catch(error => {
                console.error('Error recording contribution:', error);
                alert('Failed to record payment. Please try again.');
            });
        }
        
        function createLoan(e) {
            e.preventDefault();
            
            const memberId = parseInt(document.getElementById('loanMember').value);
            const member = appState.members.find(m => m.id === memberId);
            const amount = parseFloat(document.getElementById('loanAmount').value);
            const durationWeeks = parseInt(document.getElementById('loanDurationWeeks').value);
            
            const newLoan = {
                memberId: memberId,
                amount: amount,
                term: durationWeeks,
                interest: 10,
                outstanding: parseFloat(document.getElementById('loanTotalPI').value),
                nextPayment: calculateNextPaymentDate(durationWeeks),
                status: 'pending',
                applicationDate: new Date().toISOString().split('T')[0],
                // Store full application details
                applicationDetails: {
                    idType: document.getElementById('idType').value,
                    idNumber: document.getElementById('idNumber').value,
                    altPhone: document.getElementById('altPhone').value,
                    residentialAddress: document.getElementById('residentialAddress').value,
                    resLocation: document.getElementById('resLocation').value,
                    resSuburb: document.getElementById('resSuburb').value,
                    resAreaCode: document.getElementById('resAreaCode').value,
                    resProvince: document.getElementById('resProvince').value,
                    businessAddress: document.getElementById('businessAddress').value,
                    collateralType: document.getElementById('collateralType').value,
                    collateralValue: document.getElementById('collateralValue').value,
                    guarantor1: document.getElementById('guarantor1').value,
                    guarantor2: document.getElementById('guarantor2').value,
                    guarantor3: document.getElementById('guarantor3').value,
                    guarantor4: document.getElementById('guarantor4').value,
                    guarantor5: document.getElementById('guarantor5').value,
                    purpose: document.getElementById('loanPurpose').value
                }
            };
            
            // Save to database
            saveToDB('loans', newLoan).then(savedLoan => {
                appState.loans.push(savedLoan);
                
                showNotification(`Loan application submitted successfully! Application is pending Loan Officer review.`, 'success');
                closeModal('newLoanModal');
                e.target.reset();
                
                // Refresh loans view if active
                if (document.getElementById('loans').classList.contains('active')) {
                    renderLoans();
                }
            }).catch(error => {
                console.error('Error creating loan:', error);
                alert('Failed to submit loan application. Please try again.');
            });
        }
        
        function calculateNextPaymentDate(weeks) {
            const date = new Date();
            date.setDate(date.getDate() + (weeks * 7));
            return date.toISOString().split('T')[0];
        }
        
        function populateMemberInfo() {
            const memberId = parseInt(document.getElementById('loanMember').value);
            const member = appState.members.find(m => m.id === memberId);
            
            if (member) {
                // Auto-populate member information
                const nameParts = member.name.split(' ');
                document.getElementById('loanFirstNames').value = nameParts.slice(1).join(' ');
                document.getElementById('loanPhone').value = member.phone;
                document.getElementById('loanEmail').value = member.email;
                document.getElementById('regNo').value = `MSK-${String(member.id).padStart(4, '0')}`;
                
                // Populate shares and savings
                document.getElementById('memberShares').value = member.shares;
                const tierInfo = appState.tiers[member.tier];
                document.getElementById('shareValue').value = tierInfo.initialInvestment;
                document.getElementById('memberSavings').value = member.balance;
                document.getElementById('savingsDate').value = new Date().toISOString().split('T')[0];
                
                const totalSharesSavings = tierInfo.initialInvestment + member.balance;
                document.getElementById('totalSharesSavings').value = totalSharesSavings;
                
                // Populate guarantor dropdowns (exclude current member)
                const guarantorOptions = '<option value="">Select Member</option>' + 
                    appState.members
                        .filter(m => m.id !== memberId && m.status === 'current')
                        .map(m => `<option value="${m.id}">${m.name}</option>`)
                        .join('');
                
                document.getElementById('guarantor1').innerHTML = guarantorOptions;
                document.getElementById('guarantor2').innerHTML = guarantorOptions;
                document.getElementById('guarantor3').innerHTML = guarantorOptions;
                document.getElementById('guarantor4').innerHTML = guarantorOptions;
                document.getElementById('guarantor5').innerHTML = guarantorOptions;
            }
        }
        
        function calculateLoanDetails() {
            const amount = parseFloat(document.getElementById('loanAmount').value) || 0;
            const weeks = parseInt(document.getElementById('loanDurationWeeks').value) || 0;
            
            if (amount > 0 && weeks > 0) {
                // Calculate interest (10% per annum, prorated for weeks)
                const annualInterestRate = 0.10;
                const weeklyInterestRate = annualInterestRate / 52;
                const totalInterest = amount * weeklyInterestRate * weeks;
                const totalPI = amount + totalInterest;
                
                document.getElementById('loanInterestCalc').value = totalInterest.toFixed(2);
                document.getElementById('loanTotalPI').value = totalPI.toFixed(2);
                document.getElementById('guaranteeAmount').value = totalPI.toFixed(2);
            }
        }
        
        function updateGuarantorValue(guarantorNum) {
            const selectId = `guarantor${guarantorNum}`;
            const valueId = `guarantor${guarantorNum}Value`;
            
            const memberId = parseInt(document.getElementById(selectId).value);
            if (memberId) {
                const member = appState.members.find(m => m.id === memberId);
                if (member) {
                    const tierInfo = appState.tiers[member.tier];
                    const totalValue = tierInfo.initialInvestment + member.balance;
                    document.getElementById(valueId).value = totalValue;
                }
            } else {
                document.getElementById(valueId).value = '';
            }
        }
        
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (message) {
                appState.chatMessages.push({
                    id: appState.chatMessages.length + 1,
                    sender: 'You',
                    message: message,
                    time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
                    isSent: true
                });
                renderChat();
                input.value = '';
            }
        }
        
        function sendReminder() {
            showNotification('Payment reminder sent successfully!', 'success');
        }
        
        function saveSettings() {
            showNotification('Settings saved successfully!', 'success');
        }
        
        function generateReport(type) {
            const summaryDiv = document.getElementById('aiReportSummary');
            summaryDiv.innerHTML = '<div class="loading"></div> Generating AI-powered report...';
            
            setTimeout(() => {
                const totalShares = appState.members.reduce((sum, m) => sum + m.shares, 0);
                const weeklyTotal = appState.members.reduce((sum, m) => sum + appState.tiers[m.tier].weeklySubscription, 0);
                const tier1Count = appState.members.filter(m => m.tier === 1).length;
                const tier2Count = appState.members.filter(m => m.tier === 2).length;
                const tier3Count = appState.members.filter(m => m.tier === 3).length;
                
                summaryDiv.innerHTML = `
                    <strong>${type.charAt(0).toUpperCase() + type.slice(1)} Financial Summary</strong><br><br>
                    <strong>Membership Structure:</strong><br>
                    - Tier 1: ${tier1Count} members (${tier1Count} shares)<br>
                    - Tier 2: ${tier2Count} members (${tier2Count * 2} shares)<br>
                    - Tier 3: ${tier3Count} members (${tier3Count * 3} shares)<br>
                    - Total: ${appState.members.length} members with ${totalShares} shares<br><br>
                    <strong>Financial Performance:</strong><br>
                    Weekly subscriptions collected: R ${weeklyTotal} (75% collection rate this week)<br>
                    Late fees collected: R 100<br>
                    Investment returns: +15.2% growth<br>
                    Active loans: R 12,000 with 100% on-time payment rate<br>
                    Projected annual subscription income: R ${weeklyTotal * 52}<br>
                    Current pool value: R 315,900<br><br>
                    <em>Recommendation: Strong membership tier distribution with healthy weekly cash flow. Consider tier-based dividend distribution based on share ownership. 2 members need payment follow-up to maintain 100% collection rate.</em>
                `;
            }, 2000);
        }
        
        function showNotification(message, type) {
            // Simple notification system - could be enhanced
            alert(message);
        }
        
        // Offline Detection
        window.addEventListener('online', () => {
            document.getElementById('offlineIndicator').classList.remove('show');
        });
        
        window.addEventListener('offline', () => {
            document.getElementById('offlineIndicator').classList.add('show');
        });
        
        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,');
        }
        
        // Initialize app
        renderMembers();
        
        // Chat input enter key
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
